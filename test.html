<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Swap TON to VIEC</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ton/core@0.0.6-alpha.2/dist/index.umd.js"></script>
</head>
<body>
  <h2>üîÑ G·ª≠i 0.005 TON ƒë·ªÉ nh·∫≠n 1000 VIEC</h2>
  <div id="ton-connect" style="margin-bottom: 10px;"></div>
  <button id="swap" disabled>‚ö° G·ª≠i 0.005 TON v√† nh·∫≠n 1000 VIEC</button>

  <script>
    const { Address, beginCell, toNano } = window["@ton/core"];

    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://duccodedao.github.io/VIEC/tonconnect-manifest.json",
      buttonRootId: "ton-connect"
    });

    // ƒê·ªãa ch·ªâ v√≠ c·ªßa b·∫°n (n∆°i nh·∫≠n TON v√† ch·ª©a Jetton)
    const OWNER_WALLET = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD";
    const JETTON_MASTER = "EQA5JIIDkiPljbagP_S9R7fZQLAhLZjNhIPRVSWkuicj5M_f";

    let userAddress = null;

    tonConnectUI.onStatusChange((walletInfo) => {
      if (walletInfo && walletInfo.account?.address) {
        userAddress = walletInfo.account.address;
        document.getElementById("swap").disabled = false;
      }
    });

    document.getElementById("swap").onclick = async () => {
      if (!userAddress) {
        alert("‚ùó B·∫°n ch∆∞a k·∫øt n·ªëi v√≠!");
        return;
      }

      const recipient = Address.parse(userAddress);

      // B∆∞·ªõc 1: G·ª≠i 0.005 TON ƒë·∫øn v√≠ c·ªßa b·∫°n
      const sendTonTx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [
          {
            address: OWNER_WALLET,
            amount: toNano("0.005").toString()
          }
        ]
      };

      try {
        await tonConnectUI.sendTransaction(sendTonTx);
        alert("‚úÖ ƒê√£ g·ª≠i 0.005 TON. ƒêang g·ª≠i l·∫°i 1000 VIEC...");

        // B∆∞·ªõc 2: G·ª≠i l·∫°i 1000 Jetton (VIEC) t·ª´ v√≠ b·∫°n ƒë·∫øn user
        const jettonTransferPayload = beginCell()
          .storeUint(0xf8a7ea5, 32) // Jetton transfer OP
          .storeUint(0, 64) // query_id
          .storeCoins(toNano("1000")) // amount
          .storeAddress(recipient) // recipient
          .storeAddress(recipient) // response_address
          .storeBit(0) // no custom payload
          .storeCoins(toNano("0.01")) // forward TON
          .storeBit(0) // no forward payload
          .endCell();

        const jettonTx = {
          validUntil: Math.floor(Date.now() / 1000) + 600,
          messages: [
            {
              address: JETTON_MASTER,
              amount: toNano("0.05").toString(), // ph√≠
              payload: jettonTransferPayload.toBoc().toString("base64")
            }
          ]
        };

        await tonConnectUI.sendTransaction(jettonTx);
        alert("üéâ G·ª≠i l·∫°i 1000 VIEC th√†nh c√¥ng!");
      } catch (e) {
        console.error(e);
        alert("‚ùå L·ªói: " + e.message);
      }
    };
  </script>
</body>
</html>
