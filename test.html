
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Bmass Experience</title>

<!-- Meta SEO -->
<meta name="description" content="Bmass: The ultimate Web3 experience. Discover top Mini Apps and manage your TON assets intuitively.">
<link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">

<!-- Thẻ Open Graph (Quan trọng cho việc chia sẻ trên mạng xã hội) -->
<meta property="og:title" content="The Bmass Experience" />
<meta property="og:description" content="The ultimate Web3 experience. Discover top Mini Apps and manage your TON assets intuitively." />
<meta property="og:image" content="https://bmass.vercel.app/img/bmass_nen.png" />
<meta property="og:url" content="https://bmass.vercel.app/img/bmass_seo.png" />
<meta property="og:type" content="website" />

<!-- Thẻ Twitter Card (Quan trọng cho việc chia sẻ trên Twitter/X) -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="The Bmass Experience" />
<meta name="twitter:description" content="The ultimate Web3 experience. Discover top Mini Apps and manage your TON assets intuitively." />
<meta name="twitter:image" content="https://bmass.vercel.app/img/bmasslogo.png" />


    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- [NEW] SheetJS Library for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* =================================================================== */
      /* [NEW VERSION] ROOT VARIABLES & KEYFRAME ANIMATIONS
      /* =================================================================== */
      :root {
          --bg-color: #050816;
          --card-color: rgba(23, 27, 48, 0.5);
          --border-color: rgba(145, 94, 255, 0.2);
          --accent-primary: #915EFF;
          --accent-secondary: #2BCBC4;
          --text-primary: #f1f2f6;
          --text-secondary: #aaa6c3;
          --color-in: #2BCBC4;
          --color-out: #ff6b6b;
          --color-failed: #ffcc00;
          --color-verified: #2ecc71;
          --gold: #FFD700;
          --silver: #C0C0C0;
          --bronze: #CD7F32;
          --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
      @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
      
      /* New Animations */
      @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(25px); }
          to { opacity: 1; transform: translateY(0); }
      }

      @keyframes pulse {
          0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(43, 203, 196, 0.4); }
          50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(43, 203, 196, 0.7); }
      }
      
      @keyframes spin {
          to { transform: rotate(360deg); }
      }
      
      @keyframes subtleShine {
          from { background-position: 200% center; }
          to { background-position: -200% center; }
      }

      /* [NEW] Keyframes for Level Shields */
        @keyframes shield-pulse-gold {
            0% { box-shadow: 0 0 15px 0px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 25px 8px rgba(255, 215, 0, 0.7); }
            100% { box-shadow: 0 0 15px 0px rgba(255, 215, 0, 0.5); }
        }

        @keyframes shield-rotate-gradient {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


      /* =================================================================== */
      /* GENERAL STYLES & ENHANCEMENTS
      /* =================================================================== */
      body {
          font-family: 'Poppins', sans-serif;
          background-color: var(--bg-color);
          color: var(--text-primary);
          background: linear-gradient(-45deg, #050816, #120e2a, #1a163c, #0d0b1f);
          background-size: 400% 400%;
          animation: gradientBG 15s ease infinite;
          overflow-x: hidden;
          font-size: 16px;
      }

      .main-container { 
          max-width: 1400px; 
          padding: 1.5rem 1rem; 
          margin: auto;
          /* Add animation for page content */
          animation: fadeInUp 0.6s ease-out forwards;
      }
      
      .header { 
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          padding-bottom: 1rem; 
          margin-bottom: 2rem; 
      }
      
      .header-logo { 
          display: flex; 
          align-items: center; 
          text-decoration: none; 
          color: var(--text-primary); 
          gap: 10px; 
          z-index: 1100; 
      }
      
      .header-logo img { 
          height: 40px; 
          width: 40px; 
          object-fit: cover; 
          transition: transform 0.4s ease;
      }
      .header-logo:hover img {
          transform: rotate(360deg);
      }
      
      .header-logo span { font-size: 1.1rem; font-weight: 600; }

      .card-glass { 
          background: var(--card-color); 
          border: 1px solid var(--border-color); 
          border-radius: 25px; 
          padding: 1.25rem; 
          backdrop-filter: blur(15px); 
          -webkit-backdrop-filter: blur(15px); 
          box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
          transition: var(--transition-smooth);
      }
      
      .card-glass:hover { 
          transform: translateY(-8px) scale(1.02); 
          box-shadow: 0 0 35px rgba(145, 94, 255, 0.35); 
          border-color: var(--accent-primary); 
      }
      
      .card-title { 
          font-weight: 600; 
          margin-bottom: 1.5rem; 
          font-size: 1.25rem; 
          background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--text-primary));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-size: 200%;
          animation: gradientShine 5s linear infinite reverse;
      }

      .skeleton-loader { 
          background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); 
          background-size: 200% 100%; 
          border-radius: 25px; 
          animation: shimmer 1.5s infinite; 
      }
      
      .skeleton-line { height: 20px; margin-bottom: 10px; }

      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }


      /* =================================================================== */
      /* HERO SECTION & LOGIN
      /* =================================================================== */
      .hero-section, .login-section { 
          text-align: center; 
          padding: 4rem 1rem; 
          min-height: 70vh; 
          display: flex; 
          flex-direction: column; 
          align-items: center; 
          justify-content: center;
      }
      
      /* Animate hero text on load */
      .hero-section h1, .login-section h1 { 
          font-size: 2rem; 
          font-weight: 700;
          animation: fadeInUp 0.8s ease-out 0.2s backwards; 
      }
      
      .hero-section p, .login-section p {
           animation: fadeInUp 0.8s ease-out 0.4s backwards;
      }

      .hero-section .btn, .login-section .btn {
           animation: fadeInUp 0.8s ease-out 0.6s backwards;
      }
      
      .hero-section .highlight, .login-section .highlight { color: var(--accent-primary); }
      
    
      /* ============================================= */
      /* [NEW] AVATAR & LEVEL SYSTEM STYLES            */
      /* ============================================= */
      .profile-avatar-wrapper {
          position: relative;
          width: 128px;
          height: 128px;
          margin: 0 auto 1.5rem; /* Tăng margin bottom */
      }

      .profile-avatar {
          width: 100%;
          height: 100%;
          border-radius: 50%;
          object-fit: cover;
          position: relative; /* Đảm bảo avatar nằm trên shield background */
          z-index: 2;
      }

      .avatar-shield {
          position: absolute;
          top: -6px; /* Điều chỉnh để tạo khoảng cách cho viền */
          left: -6px;
          width: calc(100% + 12px);
          height: calc(100% + 12px);
          border-radius: 50%;
          z-index: 1;
          transition: all 0.5s ease-in-out;
          background-clip: padding-box; /* Quan trọng để background không tràn vào trong */
          border: 4px solid transparent; /* Viền trong suốt mặc định */
      }

      .avatar-shield::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          border-radius: 50%;
          padding: 4px; /* Độ dày của viền gradient */
          background: var(--border-color); /* Màu nền mặc định */
          -webkit-mask: 
              linear-gradient(#fff 0 0) content-box, 
              linear-gradient(#fff 0 0);
          -webkit-mask-composite: xor;
          mask-composite: exclude;
          transition: all 0.5s ease-in-out;
      }

      /* Level 1: Bronze */
      .level-shield-1::before { background: var(--bronze); }
      /* Level 2: Silver */
      .level-shield-2::before { background: var(--silver); }
      /* Level 3: Basic Accent */
      .level-shield-3::before { background: var(--accent-secondary); }
      /* Level 4: Primary Accent */
      .level-shield-4::before { background: var(--accent-primary); }
      /* Level 5: Simple Gradient */
      .level-shield-5::before { background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); }
      /* Level 6: Enhanced Gradient */
      .level-shield-6::before { background: linear-gradient(90deg, #2BCBC4, #915EFF, #f977b8); }
      /* Level 7: Pulsing Accent */
      .level-shield-7 { animation: shield-pulse-gold 2.5s infinite; }
      .level-shield-7::before { background: linear-gradient(135deg, var(--accent-primary), var(--gold)); }
      /* Level 8: Gold */
      .level-shield-8 { animation: shield-pulse-gold 2s infinite; }
      .level-shield-8::before { background: var(--gold); }
      /* Level 9: Rotating Gradient */
      .level-shield-9::after {
          content: '';
          position: absolute;
          top: -8px; left: -8px; right: -8px; bottom: -8px;
          background: conic-gradient(from var(--angle), #915EFF, #2BCBC4, #f977b8, #915EFF);
          border-radius: 50%;
          animation: shield-rotate-gradient 4s linear infinite;
          z-index: -1;
          filter: blur(5px);
      }
      .level-shield-9::before { background: linear-gradient(45deg, #915EFF, #2BCBC4); }
      /* Level 10: MAX - Ultimate Rotating Rainbow */
      .level-shield-10 { animation: shield-pulse-gold 1.5s infinite; }
      .level-shield-10::after {
          content: '';
          position: absolute;
          top: -10px; left: -10px; right: -10px; bottom: -10px;
          background: conic-gradient(from var(--angle), #ff2257, #ffdd57, #57ffab, #57d1ff, #a257ff, #ff2257);
          border-radius: 50%;
          animation: shield-rotate-gradient 3s linear infinite;
          z-index: -1;
          filter: blur(8px);
          opacity: 0.8;
      }
      .level-shield-10::before { background: linear-gradient(315deg, #ffdd57, #a257ff, #57d1ff); }
      
      .progress { transition: all 0.4s ease; }
      .progress-bar { transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
      /* ============================================= */
      /* END OF AVATAR & LEVEL SYSTEM STYLES           */
      /* ============================================= */


      /* =================================================================== */
      /* UI COMPONENTS & WIDGETS
      /* =================================================================== */
      .activity-item-icon, .jetton-item-img { 
          width: 40px; 
          height: 40px; 
          border-radius: 50%; 
          object-fit: cover; 
          flex-shrink: 0;
          transition: transform 0.3s ease;
      }
      .d-flex:hover .activity-item-icon, .d-flex:hover .jetton-item-img {
          transform: scale(1.1);
      }

      .amount-in { color: var(--color-in); }
      .amount-out { color: var(--color-out); }
      .status-icon { font-size: 0.7rem; margin-right: 6px; }
      .status-ok { color: var(--color-in); }
      .status-failed { color: var(--color-failed); }
      .verified-tick { color: var(--color-verified); margin-left: 5px; font-size: 0.9em; }

      .jetton-item { cursor: pointer; transition: background-color: 0.2s; border-radius: 25px; }
      .jetton-item:hover { background-color: rgba(145, 94, 255, 0.1); }

      #search-results-container { max-height: 40vh; overflow-y: auto; }
      .search-result-item { cursor: pointer; padding: 10px; border-radius: 25px; transition: background-color 0.2s ease; }
      .search-result-item:hover { background-color: rgba(145, 94, 255, 0.1); }
      .search-result-item img { width: 32px; height: 32px; border-radius: 50%; }

      .copyable-address, .copyable-code { cursor: pointer; transition: color 0.2s; font-family: monospace; }
      .copyable-address:hover, .copyable-code:hover { color: var(--accent-secondary); }
      .copyable-address.copied, .copyable-code.copied { color: var(--color-verified) !important; font-weight: bold; }

      /* Modal and Tabs */
      .modal-content { background-color: #0c0f24; border: 1px solid var(--border-color); color: var(--text-primary); }
      .modal-header { border-bottom: 1px solid var(--border-color); }
      .modal-footer { border-top: 1px solid var(--border-color); }
      .modal-backdrop.show { opacity: 0.7; backdrop-filter: blur(5px); }
      .nav-tabs { border-bottom-color: var(--border-color); }
      .nav-tabs .nav-link { background: transparent; border-color: transparent; color: var(--text-secondary); transition: var(--transition-smooth); }
      .nav-tabs .nav-link.active { color: var(--accent-primary); background-color: rgba(145, 94, 255, 0.1); border-color: var(--border-color); }
      .nav-tabs .nav-link:not(.active):hover { color: var(--text-primary); transform: translateY(-3px); }
      .tab-content { max-height: 50vh; overflow-y: auto; padding-top: 1rem; }
      .metadata-key { color: var(--text-secondary); font-weight: 500; }
      
      .tab-content .table {
          --bs-table-bg: transparent;
          --bs-table-border-color: var(--border-color);
          --bs-table-color: var(--text-primary);
          --bs-table-striped-color: var(--text-primary);
      }
      .tab-content .table-hover > tbody > tr:hover > * {
          --bs-table-accent-bg: rgba(145, 94, 255, 0.15);
      }

      /* News Feed */
      .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
      .news-card { background: var(--card-color); border: 1px solid var(--border-color); border-radius: 25px; overflow: hidden; transition: var(--transition-smooth); text-decoration: none; color: var(--text-primary); }
      .news-card:hover { transform: translateY(-8px); box-shadow: 0 0 25px rgba(145, 94, 255, 0.3); border-color: var(--accent-primary); }
      .news-card-img { width: 100%; height: 180px; object-fit: cover; transition: transform 0.4s ease; }
      .news-card:hover .news-card-img { transform: scale(1.05); }
      .news-card-body { padding: 1rem; }
      .news-card-title { font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
      .news-card-source { font-size: 0.8rem; color: var(--text-secondary); }

      /* Sidebar & Hamburger Menu */
      .hamburger-btn { width: 40px; height: 40px; background: transparent; border: none; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; cursor: pointer; z-index: 1100; }
      .hamburger-btn span { display: block; width: 24px; height: 2px; background-color: var(--text-primary); border-radius: 2px; transition: all 0.3s ease-in-out; }
      .hamburger-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
      .hamburger-btn.open span:nth-child(2) { opacity: 0; }
      .hamburger-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

      .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--bg-color); padding: 6rem 2rem 2rem; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 1050; display: flex; flex-direction: column; }
      .sidebar.open { transform: translateX(0); box-shadow: 10px 0px 50px -20px rgba(0,0,0,0.5); }
      .sidebar-nav { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; }
.sidebar-link {
    /* Các thuộc tính hiện có của bạn */
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 1.1rem;
    font-weight: 500;
    padding: 10px;
    border-radius: 12px;
    transition: color 0.3s, background-color 0.3s, transform 0.3s;

    /* Thêm các thuộc tính này */
    display: flex;
    align-items: center;
}      .sidebar-link:hover, .sidebar-link.active { color: var(--text-primary); background-color: var(--border-color); transform: translateX(5px); }

      .sidebar-wallet-connect { margin-top: auto; }
      #custom-wallet-button { background: var(--accent-primary); color: white; border: none; padding: 10px 16px; width: 100%; border-radius: 25px; font-weight: 500; cursor: pointer; text-align: center; transition: var(--transition-smooth); }
      #custom-wallet-button:hover { transform: scale(1.03); background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); }

      #wallet-dropdown { display: none; position: absolute; right: 0; bottom: calc(100% + 10px); background-color: #171b30; border: 1px solid var(--border-color); border-radius: 25px; z-index: 1056; min-width: 100%; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
      #wallet-dropdown a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; }
      #wallet-dropdown a:hover { background-color: rgba(145, 94, 255, 0.2); }
      #wallet-dropdown a i { margin-right: 10px; width: 15px; text-align: center; }

      .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); z-index: 1040; opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s; }
      .sidebar-overlay.open { opacity: 1; visibility: visible; }
      
      /* Toast Notification */
      .toast-notification {
          position: fixed;
          top: 20px;
          right: 20px;
          background-color: #171b30;
          color: var(--text-primary);
          border: 1px solid var(--accent-primary);
          border-radius: 12px;
          padding: 1.5rem;
          z-index: 9999;
          box-shadow: 0 10px 30px rgba(0,0,0,0.5);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
          transition: opacity 0.4s ease, transform 0.4s ease;
          max-width: 400px;
          cursor: pointer;
      }
      .toast-notification.show {
          opacity: 1;
          transform: translateY(0) scale(1);
      }
      .toast-notification-header {
          font-weight: 600;
          font-size: 1.1rem;
          margin-bottom: 0.75rem;
          color: var(--accent-secondary);
      }
      .toast-notification p { font-size: 0.95rem; }


      /* =================================================================== */
      /* PAGE-SPECIFIC SECTIONS
      /* =================================================================== */
      
      /* App Store */
      .app-menu-container { padding: 1rem 0; }
      .app-filter-bar { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 2.5rem; }
      .app-filter-btn { background-color: var(--card-color); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 20px; border-radius: 50px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
      .app-filter-btn:hover { color: var(--text-primary); border-color: var(--accent-secondary); transform: translateY(-3px); }
      .app-filter-btn.active { background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); color: white; border-color: transparent; box-shadow: 0 0 15px rgba(145, 94, 255, 0.5); }

      .app-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; background: var(--card-color); border: 1px solid var(--border-color); border-radius: 25px; padding: 1rem; transition: var(--transition-smooth); height: 100%; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
      .app-item:hover { transform: translateY(-8px); box-shadow: 0 0 25px rgba(145, 94, 255, 0.3); border-color: var(--accent-primary); }
      .app-item-img-wrapper { width: 64px; height: 64px; border-radius: 15px; overflow: hidden; flex-shrink: 0; transition: transform 0.3s ease; }
      .app-item:hover .app-item-img-wrapper { transform: scale(1.1); }
      .app-item-img { width: 100%; height: 100%; object-fit: cover; }
      .app-item-name { display: block; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); line-height: 1.3; margin-top: 0.75rem; text-align: center; }

      /* Portfolio / Dashboard */
      #total-value-usd {
          font-size: 2.2rem;
          font-weight: 700;
          color: var(--text-primary);
          line-height: 1.2;
      }
      #total-value-vnd {
          font-size: 1.2rem;
          color: var(--accent-secondary);
          font-weight: 500;
      }

      /* Task Section */
      #checkin-button:disabled, #referral-code-submit:disabled {
          background-color: #3a3f5a !important;
          cursor: not-allowed;
          animation: none !important;
      }
      #checkin-button:not(:disabled) {
          animation: pulse 2.5s infinite ease-in-out;
      }
      .task-history-item {
          display: flex;
          align-items: center;
          padding: 0.75rem 0;
          border-bottom: 1px solid var(--border-color);
          opacity: 0;
          animation: fadeInUp 0.5s ease-out forwards;
      }
      .task-history-item:last-child { border-bottom: none; }
      .task-history-icon {
          font-size: 1.2rem;
          width: 30px;
          text-align: center;
          margin-right: 1rem;
          color: var(--accent-secondary);
      }

      /* Leaderboard Styles */
      .leaderboard-list { max-width: 800px; margin: auto; }
      .leaderboard-item {
          display: flex;
          align-items: center;
          background: var(--card-color);
          border: 1px solid var(--border-color);
          padding: 12px 20px;
          border-radius: 12px;
          margin-bottom: 10px;
          transition: var(--transition-smooth);
          opacity: 0; /* Initially hidden for animation */
          animation: fadeInUp 0.5s ease-out forwards;
      }
      /* Staggered animation for leaderboard items */
      .leaderboard-item:nth-child(1) { animation-delay: 0.1s; }
      .leaderboard-item:nth-child(2) { animation-delay: 0.15s; }
      .leaderboard-item:nth-child(3) { animation-delay: 0.2s; }
      .leaderboard-item:nth-child(4) { animation-delay: 0.25s; }
      .leaderboard-item:nth-child(5) { animation-delay: 0.3s; }
      .leaderboard-item:nth-child(6) { animation-delay: 0.35s; }
      .leaderboard-item:nth-child(7) { animation-delay: 0.4s; }

      .leaderboard-item:hover {
          transform: scale(1.03);
          border-color: var(--accent-secondary);
          box-shadow: 0 0 20px rgba(43, 203, 196, 0.3);
      }
      .leaderboard-rank {
          font-size: 1.2rem;
          font-weight: 700;
          width: 50px;
          color: var(--text-secondary);
          text-align: center;
          flex-shrink: 0;
          margin-right: 10px;
      }
      .leaderboard-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          object-fit: cover;
          margin-right: 15px;
          border: 3px solid var(--border-color);
          transition: all 0.3s ease;
      }
      .leaderboard-name { font-weight: 600; flex-grow: 1; min-width: 0; }
      .leaderboard-exp {
          font-size: 1.1rem;
          font-weight: 700;
          color: var(--accent-secondary);
      }
      .leaderboard-item.rank-1 .rank-icon, .leaderboard-item.rank-1 .leaderboard-avatar { color: var(--gold); border-color: var(--gold); }
      .leaderboard-item.rank-2 .rank-icon, .leaderboard-item.rank-2 .leaderboard-avatar { color: var(--silver); border-color: var(--silver); }
      .leaderboard-item.rank-3 .rank-icon, .leaderboard-item.rank-3 .leaderboard-avatar { color: var(--bronze); border-color: var(--bronze); }
      .rank-icon { font-size: 1.8rem; }
      .leaderboard-item.current-user {
          border-color: var(--accent-primary);
          box-shadow: 0 0 20px rgba(145, 94, 255, 0.4);
          transform: scale(1.03);
      }
    
       /* [NEW] Leaderboard Summary */
      #leaderboard-summary {
        text-align: center;
        margin-bottom: 2rem;
        font-size: 1.2rem;
        color: var(--text-secondary);
      }
      #leaderboard-summary .total-users-count {
        font-weight: 700;
        color: var(--accent-secondary);
      }


      /* Form Styles */
      .form-control, .form-select {
          background-color: rgba(23, 27, 48, 0.8);
          border-color: var(--border-color);
          color: var(--text-primary);
          transition: var(--transition-smooth);
      }
      .form-control:focus, .form-select:focus {
          background-color: rgba(23, 27, 48, 1);
          border-color: var(--accent-primary);
          color: var(--text-primary);
          box-shadow: 0 0 0 0.25rem rgba(145, 94, 255, 0.25);
      }
      .form-control::placeholder { color: var(--text-secondary); }
      .form-select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23915EFF' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e"); }
      .input-group-text {
          background-color: rgba(23, 27, 48, 0.8);
          border-color: var(--border-color);
          color: var(--accent-secondary);
      }
      
      /* [NEW] Avatar Upload UI */
        .avatar-upload-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 1rem;
        }
        .avatar-upload-container .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            object-fit: cover;
            transition: filter 0.3s ease;
        }
        .avatar-upload-container .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .avatar-upload-container:hover .avatar-overlay {
            opacity: 1;
        }
        .avatar-upload-container:hover .avatar-preview {
            filter: brightness(0.7);
        }
        .avatar-upload-container .avatar-overlay i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }


      /* Admin Panel */
      #admin-section .table {
          --bs-table-bg: transparent;
          --bs-table-border-color: var(--border-color);
          --bs-table-color: var(--text-primary);
          --bs-table-hover-bg: rgba(145, 94, 255, 0.1);
          white-space: nowrap;
      }
      #admin-section thead th {
          color: var(--text-secondary);
          background-color: rgba(145, 94, 255, 0.05);
          text-transform: uppercase;
          font-size: 0.75rem;
          letter-spacing: 0.5px;
          padding-top: 0.75rem;
          padding-bottom: 0.75rem;
          border-bottom: 2px solid var(--border-color);
      }
      #admin-section tbody tr { transition: background-color 0.2s ease; }
      #admin-section tbody td { padding: 0.75rem; vertical-align: middle; border-bottom: 1px solid var(--border-color); }
      #admin-section tbody tr:last-child td { border-bottom: none; }
      #admin-section tbody img.table-img-preview {
          width: 40px;
          height: 40px;
          border-radius: 20px;
          border: 2px solid var(--border-color);
          object-fit: cover;
      }
      #admin-section .text-truncate { max-width: 150px; }
      #admin-load-more-btn, #admin-load-more-claims-btn {
          border-color: var(--accent-secondary);
          color: var(--accent-secondary);
          font-weight: 600;
          transition: var(--transition-smooth);
      }
      #admin-load-more-btn:hover, #admin-load-more-claims-btn:hover { background-color: var(--accent-secondary); color: white; transform: scale(1.05); }
      #admin-user-list-container .form-check-input:checked { background-color: var(--color-verified); border-color: var(--color-verified); }
      #admin-user-list-container .form-switch .form-check-input { height: 1.25em; width: 2.25em; }
    
     /* [NEW] Scrollable Admin User List */
      #admin-user-list-container, #admin-claim-list-container {
        max-height: 70vh; /* Set a max height */
        overflow-y: auto;  /* Enable vertical scroll */
        /* The table-responsive class will handle horizontal scroll */
      }


      /* Airdrop Page */
      .airdrop-stat-card {
          background: linear-gradient(135deg, rgba(145, 94, 255, 0.1), rgba(43, 203, 196, 0.1));
          padding: 1.5rem;
          border-radius: 16px;
          text-align: center;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          transition: var(--transition-smooth);
      }
      .airdrop-stat-card:hover { transform: translateY(-5px); }
      .airdrop-stat-icon { font-size: 2.5rem; margin-bottom: 1rem; color: var(--accent-secondary); transition: transform 0.3s ease; }
      .airdrop-stat-card:hover .airdrop-stat-icon { transform: scale(1.1); }
      .airdrop-stat-value { font-size: 2rem; font-weight: 700; }
      .airdrop-stat-label { color: var(--text-secondary); }
      #airdrop-reward-card {
          background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
          color: white;
          padding: 2rem;
          transform: scale(1);
          transition: transform 0.4s ease, box-shadow 0.4s ease;
      }
      #airdrop-reward-card:hover {
          transform: scale(1.03);
          box-shadow: 0 10px 40px rgba(145, 94, 255, 0.4);
      }
      #airdrop-reward-logo { width: 32px; height: 32px; margin-left: 10px; vertical-align: middle; }
      #airdrop-eligibility-status.eligible { color: var(--color-verified); }
      #airdrop-eligibility-status.ineligible { color: var(--color-out); }
      
      /* [NEW] Airdrop Claim Styles */
      .airdrop-claim-btn {
          font-weight: 700;
          border: none;
          padding: 12px 30px;
          border-radius: 50px;
          transition: all 0.3s ease;
          width: 100%;
          margin-top: 0.75rem;
      }
      .airdrop-claim-btn:hover {
          transform: scale(1.05);
      }
      .airdrop-claim-btn:disabled {
          background: #ccc !important;
          color: #666 !important;
          cursor: not-allowed;
          transform: scale(1);
          box-shadow: none;
      }
      .claim-btn-onchain {
          background: var(--accent-primary);
          color: white;
      }
      .claim-btn-onchain:hover {
           box-shadow: 0 0 20px rgba(145, 94, 255, 0.5);
      }
      .claim-btn-offchain {
          background: white;
          color: var(--accent-primary);
      }
       .claim-btn-offchain:hover {
           box-shadow: 0 0 20px rgba(255,255,255,0.3);
      }

      .exchange-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 1.5rem;
      }
      .exchange-btn {
        background-color: rgba(255,255,255,0.1);
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .exchange-btn:hover {
        transform: translateY(-4px);
        background-color: rgba(255,255,255,0.2);
      }
      .exchange-btn.selected {
        border-color: var(--accent-secondary);
        box-shadow: 0 0 15px rgba(43, 203, 196, 0.5);
      }
      .exchange-btn img {
        width: 48px;
        height: 48px;
        object-fit: contain;
      }

      /* Loading & Maintenance Overlays */
      #loading-overlay, #maintenance-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(5, 8, 22, 0.9);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          z-index: 9999;
          display: flex;
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: var(--text-secondary);
          visibility: hidden;
          opacity: 0;
          transition: visibility 0s 0.3s, opacity 0.3s ease;
      }
      #loading-overlay.visible, #maintenance-overlay.visible {
          visibility: visible;
          opacity: 1;
          transition: opacity 0.3s ease;
      }
      #loading-overlay .spinner-border, #maintenance-overlay .spinner-border {
          animation: spin 1s linear infinite;
      }
      #maintenance-overlay h2 {
          color: var(--text-primary);
      }
      #admin-maintenance-banner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(90deg, var(--gold), var(--color-failed));
        color: #000;
        text-align: center;
        padding: 5px;
        font-weight: 600;
        z-index: 10000;
        font-size: 0.9rem;
      }


      /* Partner Task Card */
      .partner-task-card {
          display: flex;
          flex-direction: column; 
          gap: 0.75rem; 
          background: var(--card-color);
          border: 1px solid var(--border-color);
          padding: 1rem;
          border-radius: 16px;
          transition: var(--transition-smooth);
          text-decoration: none;
          color: var(--text-primary);
          opacity: 0;
          animation: fadeInUp 0.5s ease-out forwards;
      }
      .partner-task-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 0 25px rgba(145, 94, 255, 0.3);
          border-color: var(--accent-primary);
      }
      .partner-task-card.mandatory { border-left: 4px solid var(--gold); }
      .partner-task-card.completed {
          opacity: 0.7;
          pointer-events: none;
          background: linear-gradient(45deg, rgba(46, 204, 113, 0.05), rgba(46, 204, 113, 0.15));
      }

      .partner-task-top { display: flex; align-items: center; gap: 1rem; }
      .partner-task-img {
          width: 64px;
          height: 64px;
          border-radius: 12px;
          object-fit: cover;
          flex-shrink: 0;
          border: 2px solid var(--border-color);
      }
      .partner-task-body { flex-grow: 1; min-width: 0; }
      .partner-task-title { font-weight: 600; font-size: 1.1rem; margin: 0; color: var(--text-primary); }
      .partner-task-desc {
          color: var(--text-secondary);
          font-size: 0.9rem;
          margin: 0.25rem 0 0.5rem;
          white-space: normal;
          overflow: hidden;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          transition: all 0.3s ease-in-out;
      }
      .partner-task-desc.expanded { -webkit-line-clamp: 10; max-height: 200px; }
      .task-details-toggle {
          background: none;
          border: none;
          color: var(--accent-secondary);
          font-size: 0.85rem;
          font-weight: 600;
          padding: 0;
          cursor: pointer;
          z-index: 2;
          position: relative;
      }
      .task-details-toggle:hover { text-decoration: underline; }
      .partner-task-action-bar {
          width: 100%;
          text-align: center;
          padding: 10px;
          font-weight: 700;
          border-radius: 25px;
          background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
          color: white;
          transition: all 0.3s ease;
      }
      .partner-task-card:not(.completed):hover .partner-task-action-bar {
          transform: scale(1.03);
          box-shadow: 0 0 15px rgba(145, 94, 255, 0.5);
      }
      .partner-task-card.completed .partner-task-action-bar {
          background: rgba(46, 204, 113, 0.25);
          color: var(--color-verified);
      }


      /* Responsive & Platform-Specific */
      @media (min-width: 768px) {
          .hero-section h1, .login-section h1 { font-size: 3.5rem; }
          .card-glass { padding: 2rem; }
          .main-container { padding: 2rem; }
      }
      
      .platform-ios .main-container,
      .platform-ios #loading-overlay { padding-top: 90px !important; }

      .platform-android .main-container,
      .platform-android #loading-overlay { padding-top: 65px !important; }

      .platform-ios .toast-notification { top: 90px !important; }
      .platform-android .toast-notification { top: 65px !important; }
      
      .platform-ios #sidebar-menu { padding-top: 90px !important; }
      .platform-android #sidebar-menu { padding-top: 65px !important; }
    
    
    /* [NEW & UPDATED] Admin Navigation Styles */
    /* Styling cho Bố cục Tab Admin */
    #admin-nav-tabs {
        border-bottom-color: var(--border-color);
        margin-bottom: 2rem;
        overflow-x: auto;
        flex-wrap: nowrap;
    }
     #admin-nav-tabs::-webkit-scrollbar { height: 4px; }
     #admin-nav-tabs::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }

    #admin-nav-tabs .nav-link {
        background: transparent;
        border-color: transparent;
        color: var(--text-secondary);
        transition: var(--transition-smooth);
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        white-space: nowrap;
    }
    #admin-nav-tabs .nav-link.active {
        color: var(--accent-primary);
        background-color: rgba(145, 94, 255, 0.1);
        border-color: var(--border-color) var(--border-color) transparent var(--border-color);
        border-bottom: 2px solid var(--accent-primary);
    }
    #admin-nav-tabs .nav-link:not(.active):hover {
        color: var(--text-primary);
        transform: translateY(-2px);
        border-color: var(--border-color);
    }
    </style>
</head>
<body>
    <!-- [NEW] Maintenance Overlay -->
    <div id="maintenance-overlay">
        <div class="text-center">
            <i class="fas fa-tools fa-3x mb-4" style="color: var(--accent-primary);"></i>
            <h2 class="mb-3">Under Maintenance</h2>
            <p>Bmass is currently undergoing scheduled maintenance.<br>We'll be back online shortly. Thank you for your patience!</p>
        </div>
    </div>

    <!-- [NEW] Admin-only Maintenance Banner -->
    <div id="admin-maintenance-banner" style="display: none;">
        <i class="fas fa-exclamation-triangle me-2"></i> MAINTENANCE MODE IS ACTIVE
    </div>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Please wait...</p>
    </div>
    
    <div id="sidebar-overlay"></div>
    <nav id="sidebar-menu" class="sidebar">
        <div class="sidebar-nav">
            <a href="#dashboard" class="sidebar-link active" id="nav-dashboard">
                <i class="fas fa-wallet fa-fw me-3"></i>Wallet
            </a>
            <a href="#apps" class="sidebar-link" id="nav-apps">
                <i class="fas fa-th-large fa-fw me-3"></i>Apps
            </a>
            <a href="#task" class="sidebar-link" id="nav-task">
                <i class="fas fa-history fa-fw me-3"></i>History
            </a>
            <a href="#partner" class="sidebar-link" id="nav-partner">
                <i class="fas fa-list-check fa-fw me-3"></i>Tasks
            </a>
            <a href="#referral" class="sidebar-link" id="nav-referral">
                <i class="fas fa-users fa-fw me-3"></i>Referral
            </a>
            <a href="#airdrop" class="sidebar-link" id="nav-airdrop">
                <i class="fas fa-parachute-box fa-fw me-3"></i>Airdrop
            </a>
            <a href="#leaderboard" class="sidebar-link" id="nav-leaderboard">
                <i class="fas fa-trophy fa-fw me-3"></i>Leaderboard
            </a>
            <a href="#account" class="sidebar-link" id="nav-account">
                <i class="fas fa-user-circle fa-fw me-3"></i>Account
            </a>
            <a href="#admin" class="sidebar-link" id="nav-admin" style="display: none;">
                <i class="fas fa-user-shield fa-fw me-3"></i>Admin
            </a>
        </div>
        
        <div class="sidebar-wallet-connect">
            <div class="position-relative">
                <div id="ton-connect-button-root"></div>
                <div id="custom-wallet-button-container" style="display: none;">
                    <button id="custom-wallet-button"></button>
                    <div id="wallet-dropdown">
                        <a href="#" id="my-account-btn" target="_blank" rel="noopener noreferrer"><i class="fas fa-user-circle"></i><span>My Account</span></a>
                        <a href="#" id="copy-address-btn"><i class="fas fa-copy"></i><span>Copy Address</span></a>
                        <a href="#" id="disconnect-wallet-btn"><i class="fas fa-unlink"></i><span>Disconnect Wallet</span></a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        <header class="header">
            <a href="#" class="header-logo" id="app-logo-container">
                <img id="app-logo-img" src="https://bmass.vercel.app/img/bmasslogo.png" alt="App Logo">
                <span id="app-logo-text"></span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <div id="header-exp-display" class="d-none" style="color: var(--accent-secondary); font-weight: 600;">
                    EXP: <span id="header-exp-balance">0</span>
                </div>
                <button id="hamburger-menu-btn" class="hamburger-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </header>
        
        <main id="account-section" style="display: none;">
            <div class="container">
                <div class="text-center mb-5">
                    <h1 class="mb-2" style="font-weight: 700;">Account Information</h1>
                    <p class="lead text-secondary col-md-8 mx-auto">Manage your personal information and settings.</p>
                </div>
                <div class="row justify-content-center">
                    <div class="col-12 col-md-10 col-lg-8 col-xl-6">
                        <div class="card-glass p-4 text-center">
                            
                            <!-- [MODIFIED] AVATAR SECTION WITH SHIELD -->
                            <div class="profile-avatar-wrapper mx-auto mb-3">
                                <img id="profile-photo" src="" alt="User Photo" class="profile-avatar">
                                <div id="profile-avatar-shield" class="avatar-shield"></div>
                            </div>
                            <!-- END OF MODIFIED AVATAR SECTION -->
                            
                            <h3 id="profile-fullname" class="fw-bold"></h3>
                            <p id="profile-username" class="text-secondary fs-5"></p>

                             <!-- [NEW] LEVEL PROGRESS SECTION -->
                            <div id="level-progress-container" class="px-3 my-4">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span id="current-level-display" class="fw-bold"></span>
                                    <span id="next-level-display" class="text-secondary"></span>
                                </div>
                                <div class="progress" style="height: 10px; background-color: var(--border-color);">
                                    <div id="level-progress-bar" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                                </div>
                                <div class="text-center text-secondary mt-1 small" id="level-exp-display"></div>
                            </div>
                             <!-- END OF NEW LEVEL PROGRESS SECTION -->

                            <hr style="border-color: var(--border-color); opacity: 0.5;">
                            
                            <div id="profile-details" class="text-start p-2">
                                <!-- User details rendered by JS -->
                            </div>

                            <!-- [NEW] NEXT LEVEL PERK DISPLAY -->
                            <div id="next-level-perk-container" class="card-glass p-3 mt-4 text-center" style="background-color: rgba(255, 215, 0, 0.1); border-color: rgba(255, 215, 0, 0.3);">
                                <h6 class="text-secondary mb-2">Next Level Perk <i class="fas fa-arrow-up"></i></h6>
                                <p id="next-level-perk" class="m-0 fw-bold" style="color: var(--gold);"></p>
                            </div>
                            <!-- END OF NEW NEXT LEVEL PERK DISPLAY -->

                            <div class="d-grid gap-2 mt-4">
                                <button id="contact-admin-btn" class="btn btn-outline-secondary">
                                    <i class="fab fa-telegram-plane me-2"></i>Contact Admin
                                </button>
                                <button id="full-logout-btn" class="btn" style="background-color: var(--color-out); color: white;">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <main id="dashboard" style="display: none;">
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div id="portfolio-overview-card" class="card-glass">
                        <h5 class="card-title">Portfolio Overview</h5>
                        <div id="portfolio-overview-content">
                            <h2 id="total-value-usd">$0.00</h2>
                            <h4 id="total-value-vnd">0 VND</h4>
                        </div>
                         <div id="portfolio-overview-skeleton" style="display: none;">
                            <div class="skeleton-loader skeleton-line w-75" style="height: 35px; margin-bottom: 15px;"></div>
                            <div class="skeleton-loader skeleton-line w-50" style="height: 20px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="account-search-section" class="mb-4">
                <div class="input-group">
                    <input type="text" id="account-search-input" class="form-control" placeholder="Search by name or paste an address">
                    <button id="account-search-button" class="btn"><i class="fas fa-search"></i></button>
                </div>
                <div id="search-results-container" class="mt-2 card-glass" style="padding: 1rem; display: none;"></div>
            </div>

             <div class="row g-4">
                <div class="col-12 col-lg-7 mb-4 mb-lg-0">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title d-flex justify-content-between align-items-center">
                                    <span>Core Assets</span>
                                    <button id="back-to-my-wallet-btn" class="btn btn-sm" style="display: none; background-color: var(--accent-secondary); color: white;">
                                        <i class="fas fa-arrow-left me-1"></i> Go Back
                                    </button>
                                </h5>
                                <div id="main-assets-content"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title">NFT Gallery</h5>
                                <div id="nft-gallery-content" style="max-height: 420px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-5">
                     <div class="row g-4">
                         <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title">Token Portfolio</h5>
                                <div id="other-tokens-content" style="max-height: 250px; overflow-y: auto; padding-right: 10px;"></div>
                            </div>
                         </div>
                        <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title">Activity Feed</h5>
                                <div id="activity-feed-content" style="max-height: 525px; overflow-y: auto; padding-right: 10px;"></div>
                            </div>
                        </div>
                     </div>
                </div>
            </div>
        </main>
        
        <section id="hero-section" class="hero-section">
            <div class="container">
                <h1 class="mb-4">Welcome to the <span class="highlight">Bmass</span><br/>Web3 Experience</h1>
                <p class="lead text-secondary col-md-8 mx-auto mb-4">Connect your wallet to visualize your assets and interact with the Bmass ecosystem in a stunning, next-generation interface.</p>
                <div id="connect-wallet-hero-btn-container"></div>
                 <div id="referral-input-container-hero" class="mt-4 col-md-6 mx-auto" style="display: none;">
                    <p class="text-secondary">Have a referral code? Enter it here!</p>
                    <div class="input-group">
                        <input type="text" id="referral-code-input-hero" class="form-control" placeholder="Enter invitation code...">
                        <button class="btn" id="referral-code-submit-hero" style="background-color: var(--accent-secondary); color: white;">Confirm</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="crypto-news-feed" class="mt-5" style="display:none;">
            <h2 class="card-title fs-2 text-center mb-4">Latest Crypto News</h2>
            <div id="news-content-area"></div>
        </section>

        <main id="app-store-section" style="display: none;">
            <div class="app-menu-container">
                <div class="text-center mb-5">
                    <h1 class="mb-2" style="font-weight: 700;">Discover Mini Apps</h1>
                    <p class="lead text-secondary col-md-8 mx-auto">The most powerful apps, games, and tools in the ecosystem.</p>
                </div>
                <div id="app-search-section" class="mb-4 col-md-8 col-lg-6 mx-auto">
                    <div class="input-group">
                        <input type="text" id="app-search-input" class="form-control" placeholder="Search by name...">
                        <button class="btn" id="app-search-button"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                <div id="app-filter-controls" class="app-filter-bar">
                    <button class="app-filter-btn active" data-filter="all">All</button>
                    <button class="app-filter-btn" data-filter="Airdrop">Airdrop</button>
                    <button class="app-filter-btn" data-filter="DePIN">DePIN</button>
                    <button class="app-filter-btn" data-filter="DEX">DEX</button>
                    <button class="app-filter-btn" data-filter="CEX">CEX</button>
                    <button class="app-filter-btn" data-filter="Tiện ích">Utility</button>
                </div>
                <div id="app-grid" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-3">
                    <!-- Apps will be rendered by JS -->
                </div>
            </div>
        </main>

        <main id="task-section" style="display: none;">
            <div class="container">
                <div class="text-center mb-5">
                    <h1 class="mb-2" style="font-weight: 700;">Tasks & Rewards</h1>
                    <p class="lead text-secondary col-md-8 mx-auto">Complete tasks to earn rewards. EXP rewards will be converted to tokens in the future.</p>
                </div>
                <div class="row justify-content-center g-4">
                    <div class="col-12 col-md-10 col-lg-8 col-xl-6">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <p class="text-secondary mb-0">Your total EXP balance</p>
                                <h2 id="task-exp-balance" class="fw-bold mb-0">0</h2>
                            </div>
                        </div>
                        <div class="card-glass">
                            <!-- Daily Check-in -->
                            <h5 class="card-title">Tasks and History</h5>
                            <div id="daily-checkin-content" class="d-flex justify-content-between align-items-center">
<p class="mb-0">Check-in to receive <strong style="color: var(--accent-primary);" id="checkin-exp-display">+1000 EXP</strong>.</p>                                <button id="checkin-button" class="btn px-4 py-2" style="background-color: var(--accent-secondary); color: white; font-weight: 600; flex-shrink: 0; min-width: 130px;" disabled>
                                    <i class="fas fa-spinner fa-spin me-2"></i>Wait...
                                </button>
                            </div>

                            <!-- Separator -->
                            <hr style="border-color: var(--border-color); opacity: 0.5; margin: 1.5rem 0;">

                            <!-- Task History -->
                            <h5 class="card-title">Activity History</h5>
                            <div id="task-history-content" style="max-height: 300px; overflow-y: auto; padding-right: 10px; padding-bottom: 15px;">
                                <p class="text-secondary text-center p-3">No activity yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- ============================================= -->
        <!-- NEW: PARTNER SECTION                          -->
        <!-- ============================================= -->
        <main id="partner-section" style="display: none;">
            <div class="container">
                <div class="text-center mb-5">
                    <h1 class="mb-2" style="font-weight: 700;">Partner Tasks</h1>
                    <p class="lead text-secondary col-md-8 mx-auto">Complete tasks from our partners to earn additional valuable EXP rewards.</p>
                </div>
                <div class="row justify-content-center g-4">
                    <div class="col-12 col-md-10 col-lg-8">
                        <div id="partner-tasks-container" class="d-flex flex-column gap-3">
                            <!-- Partner tasks will be rendered here by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
<main id="referral-section" style="display: none;">
     <div class="container">
        <div class="text-center mb-5">
            <h1 class="mb-2" style="font-weight: 700;">Invite Friends</h1>
            <p class="lead text-secondary col-md-8 mx-auto">Invite friends to join and you both get a reward. Receive <strong style="color: var(--accent-secondary);" id="referral-base-exp-display">5000 EXP</strong> for each successful referral!</p>
        </div>

        <!-- ============================================= -->
        <!-- [NEW] KHỐI HIỂN THỊ MỐC THƯỞNG - DÁN VÀO ĐÂY -->
        <!-- ============================================= -->
        <div class="row justify-content-center g-4 mb-4">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card-glass">
                    <h5 class="card-title"><i class="fas fa-gem me-2"></i>Referral Milestones</h5>
                    <p class="text-secondary small">Invite more friends to unlock huge bonus rewards!</p>
                    <div id="referral-milestones-list-container">
                        <!-- Danh sách mốc thưởng sẽ được JS render ở đây -->
                        <div class="skeleton-loader skeleton-line w-100 mb-2"></div>
                        <div class="skeleton-loader skeleton-line w-75 mb-2"></div>
                        <div class="skeleton-loader skeleton-line w-50"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ============================================= -->
        <!-- KẾT THÚC KHỐI MỚI                             -->
        <!-- ============================================= -->

        <div class="row justify-content-center g-4">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card-glass">
                    <ul class="nav nav-tabs" id="referralTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="my-codes-tab" data-bs-toggle="tab" data-bs-target="#my-codes-pane" type="button" role="tab"><i class="fas fa-link me-2"></i>My Codes</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="invited-list-tab" data-bs-toggle="tab" data-bs-target="#invited-list-pane" type="button" role="tab"><i class="fas fa-users me-2"></i>Invited (<span id="referral-count">0</span>)</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content pt-4">
                                <div class="tab-pane fade show active" id="my-codes-pane" role="tabpanel">
                                    <div id="referral-links-container"></div>
                                    <div id="referral-codes-container"></div>

                                    <!-- [NEW] Display the user who referred you -->
                                    <div id="referred-by-container" class="mt-4" style="display: none;"></div>
                                    
                                    <div id="referral-input-container" class="mt-4" style="display: none;">
                                        <h6 class="mb-2"><i class="fas fa-user-plus me-2"></i>Enter Invitation Code</h6>
                                        <p class="text-secondary small">If you were invited by someone but haven't entered the code, do it here.</p>
                                        <div class="input-group">
                                            <input type="text" id="referral-code-input" class="form-control" placeholder="Enter inviter's code...">
                                            <button class="btn" id="referral-code-submit" style="background-color: var(--accent-secondary); color: white;">Confirm</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="invited-list-pane" role="tabpanel" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                                    <!-- Invited users list will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <main id="airdrop-section" style="display: none;">
            <div class="container">
                 <div id="airdrop-coming-soon" style="display: none;" class="text-center p-5 card-glass col-md-8 mx-auto">
                    <i class="fas fa-rocket fa-3x text-secondary mb-3"></i>
                    <h2 class="mb-2" style="font-weight: 700;">Airdrop Feature Coming Soon!</h2>
                    <p class="lead text-secondary">Stay tuned to not miss the latest announcements. We are working hard to bring you exciting rewards.</p>
                </div>

                <div id="airdrop-content-wrapper">
                    <div class="text-center mb-5">
                        <h1 class="mb-2" style="font-weight: 700;">Bmass Token Airdrop</h1>
                        <p class="lead text-secondary col-md-8 mx-auto">Bmass token rewards will be distributed based on your activity level. The more you accumulate, the bigger the reward!</p>
                    </div>
                    
                    <div id="airdrop-content-loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div id="airdrop-content-logged-in" style="display: none;">
                        <div class="row justify-content-center g-4">
                            <!-- Allocation Rules Card -->
                            <div class="col-12 col-md-10 col-lg-8">
                                <div class="card-glass p-4">
                                <h5 class="card-title text-center">Scoring Mechanism</h5>
                                <p class="text-center text-secondary">The final airdrop score is calculated by multiplying your activity counts by their respective point multipliers, and then by your Level multiplier.</p>
                                <div class="row text-center mt-4">
                                   <div class="col-3">
                                        <i class="fas fa-users airdrop-stat-icon" style="color:var(--accent-primary)"></i>
                                        <p class="text-secondary mb-0"><strong>Friends</strong></p>
                                   </div>
                                   <div class="col-3">
                                       <i class="fas fa-calendar-check airdrop-stat-icon"></i>
                                       <p class="text-secondary mb-0"><strong>Check-ins</strong></p>
                                   </div>
                                   <div class="col-3">
                                        <i class="fas fa-star airdrop-stat-icon" style="color:var(--gold)"></i>
                                       <p class="text-secondary mb-0"><strong>EXP Points</strong></p>
                                   </div>
                                   <div class="col-3">
                                        <i class="fas fa-layer-group airdrop-stat-icon" style="color:var(--accent-secondary)"></i>
                                       <p class="text-secondary mb-0"><strong>Level</strong></p>
                                   </div>
                               </div>
                                </div>
                            </div>

<!-- User Stats -->
<div class="col-12 col-md-10 col-lg-8">
    <h5 class="card-title text-center mt-4">Your Statistics</h5>
</div>
<div class="col-12 col-md-10 col-lg-8">
    <div class="row g-3">
        <!-- Cột Referrals -->
        <div class="col-6 col-md-3">
            <div class="airdrop-stat-card">
                <i class="fas fa-users airdrop-stat-icon"></i>
                <div id="airdrop-ref-count" class="airdrop-stat-value">0</div>
                <div class="airdrop-stat-label">Referrals</div>
            </div>
        </div>
        <!-- Cột Check-ins -->
        <div class="col-6 col-md-3">
            <div class="airdrop-stat-card">
                <i class="fas fa-calendar-check airdrop-stat-icon"></i>
                <div id="airdrop-checkin-count" class="airdrop-stat-value">0</div>
                <div class="airdrop-stat-label">Check-ins</div>
            </div>
        </div>
        <!-- Cột EXP Score -->
        <div class="col-6 col-md-3">
            <div class="airdrop-stat-card">
                <i class="fas fa-star airdrop-stat-icon" style="color: var(--gold)"></i>
                <div id="airdrop-exp-count" class="airdrop-stat-value">0</div>
                <div class="airdrop-stat-label">EXP Score</div>
            </div>
        </div>
        <!-- Cột Level -->
        <div class="col-6 col-md-3">
            <div class="airdrop-stat-card">
                <i class="fas fa-layer-group airdrop-stat-icon" style="color: var(--accent-secondary)"></i>
                <div id="airdrop-level-display" class="airdrop-stat-value">1</div>
                <div class="airdrop-stat-label">Your Level</div>
            </div>
        </div>
    </div>
</div>
                            
                            <!-- Total Reward & Eligibility -->
                            <div class="col-12 col-md-10 col-lg-8 mt-4">
                                <div id="airdrop-reward-card" class="card-glass text-center">
                                    <h6 class="text-white-50">YOUR ESTIMATED $BMASS REWARD</h6>
                                    <div class="d-flex justify-content-center align-items-center">
                                        <h2 id="airdrop-reward-value" class="fw-bold display-4 mb-0">0</h2>
                                        <img src="https://bmass.vercel.app/img/token3d.png" id="airdrop-reward-logo" alt="Bmass Token">
                                    </div>
                                    <p id="airdrop-eligibility-status" class="fw-bold mt-2 mb-0 fs-5"></p>
                                    
                                    <!-- [RESTRUCTURED] Claim Actions Container -->
                                    <div id="airdrop-claim-container" class="mt-4">
                                        <!-- This will be populated by JS -->
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div id="airdrop-content-logged-out" class="text-center p-5 card-glass col-md-8 mx-auto" style="display: none;">
                        <i class="fas fa-wallet fa-3x text-secondary mb-3"></i>
                        <h4 class="text-secondary">Please Connect Wallet</h4>
                        <p class="text-secondary">Connect your wallet to see your stats and calculate your airdrop reward.</p>
                    </div>
                </div>

            </div>
        </main>
        
        <main id="leaderboard-section" style="display: none;">
            <div class="container">
                <div class="text-center mb-5">
                    <h1 class="mb-2" style="font-weight: 700;">Leaderboard</h1>
                    <!-- [NEW] Leaderboard Summary -->
                    <div id="leaderboard-summary">
                        <p class="lead text-secondary col-md-8 mx-auto">
                            Celebrating our most active users. Keep earning EXP to climb the ranks!
                            <br>
                            <span id="leaderboard-total-users">
                                <i class="fas fa-users me-2"></i>Total Participants: 
                                <span class="total-users-count">...</span>
                            </span>
                        </p>
                    </div>
                </div>
                <div id="leaderboard-list" class="leaderboard-list"></div>
            </div>
        </main>
        
        <main id="admin-section" style="display: none;">
            <div class="container">
                <div class="text-center mb-5">
                    <h1 class="mb-2" style="font-weight: 700;">Admin Panel</h1>
                    <p class="lead text-secondary col-md-8 mx-auto">Công cụ quản lý người dùng và sự kiện.</p>
                </div>

                <!-- [BỐ CỤC 1] Dạng Tab -->
                <ul class="nav nav-tabs" id="admin-nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-target="#admin-panel-users" type="button">
                            <i class="fas fa-users me-1"></i> User List
                        </button>
                    </li>
                     <!-- [NEW] Claim List Tab -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-claim-list" type="button">
                            <i class="fas fa-clipboard-check me-1"></i> Claim List
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-partner-tasks" type="button">
                            <i class="fas fa-handshake me-1"></i> Partner Tasks
                        </button>
                    </li>
                     <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-messenger" type="button">
                            <i class="fab fa-telegram-plane me-1"></i> Messenger
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-reward-settings" type="button">
                            <i class="fas fa-gift me-1"></i> Rewards
                        </button>
                    </li>
                    <!-- ============================================= -->
                    <!-- [NEW] NÚT TAB CÀI ĐẶT LEVEL - DÁN VÀO ĐÂY    -->
                    <!-- ============================================= -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-level-settings" type="button">
                            <i class="fas fa-layer-group me-1"></i> Level Settings
                        </button>
                    </li>
                     <!-- ============================================= -->
                    <!-- [RESTRUCTURED] TAB AIRDROP MỚI                 -->
                    <!-- ============================================= -->
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-airdrop" type="button">
                            <i class="fas fa-parachute-box me-1"></i> Airdrop
                        </button>
                    </li>
                     <!-- ============================================= -->
                    <li class="nav-item" role="presentation">
                         <button class="nav-link" data-target="#admin-panel-edit-exp" type="button">
                            <i class="fas fa-edit me-1"></i> User Actions
                        </button>
                    </li>
                    
                    <!-- ============================================= -->
                    <!-- [NEW-FEATURE] TAB KIỂM TRA & THƯỞNG           -->
                    <!-- ============================================= -->
                     <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-audit-award" type="button">
                            <i class="fas fa-tasks me-1"></i> Kiểm tra & Thưởng
                        </button>
                    </li>
                    <!-- ============================================= -->
                    
                     <li class="nav-item" role="presentation">
                        <button class="nav-link" data-target="#admin-panel-system-status" type="button">
                            <i class="fas fa-server me-1"></i> System
                        </button>
                    </li>
                </ul>

                <div class="row justify-content-center g-4">
                    <!-- [NEW] Bảng Trạng Thái Hệ Thống -->
                    <div id="admin-panel-system-status" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                             <div class="card-glass mb-4">
                                <h5 class="card-title">System Status & Maintenance</h5>
                                <div class="d-flex justify-content-center align-items-center p-4">
                                    <div class="form-check form-switch fs-2 d-inline-block">
                                        <input class="form-check-input" type="checkbox" role="switch" id="maintenance-mode-switch" style="width: 4em; height: 2em;">
                                        <label class="form-check-label ms-3" for="maintenance-mode-switch" style="color: var(--color-out);">Maintenance Mode</label>
                                    </div>
                                </div>
                                <p class="text-center text-secondary small">
                                    WARNING: Activating maintenance mode will block access for all non-admin users.
                                </p>
                                 <div id="admin-system-status" class="mt-3 text-center fw-bold"></div>
                            </div>
                             <!-- ============================================= -->
                             <!-- [FIX-BUG] KHU VỰC SỬA LỖI ĐẾM USER          -->
                             <!-- ============================================= -->
                            <div class="card-glass">
                                <h5 class="card-title">Data Synchronization</h5>
                                 <p class="text-secondary small">
                                    If the "Total Participants" count on the Leaderboard is incorrect, use this tool to recount all users and update the value.
                                </p>
                                <div id="recalculate-status" class="mt-3 text-center fw-bold"></div>
                                <div class="d-grid mt-3">
                                    <button type="button" id="recalculate-users-btn" class="btn btn" style="background-color: var(--accent-secondary); color: white;">
                                        <i class="fas fa-sync-alt me-2"></i>Recalculate User Count
                                    </button>
                                </div>
                            </div>
                             <!-- ============================================= -->

                        </div>
                    </div>
                    
                    <!-- ============================================= -->
                    <!-- [NEW-FEATURE] PANEL KIỂM TRA & THƯỞNG         -->
                    <!-- ============================================= -->
                    <div id="admin-panel-audit-award" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                           <div class="card-glass">
                                <h5 class="card-title">Rà soát và Thưởng EXP Bổ sung</h5>
                                <p class="text-secondary small">Công cụ này sẽ quét người dùng theo điều kiện, kiểm tra xem họ đã nhận thưởng cho một sự kiện cụ thể hay chưa, và chỉ cộng điểm cho những người chưa nhận. Điều này đảm bảo không ai nhận thưởng hai lần.</p>
                                <form id="admin-audit-award-form">
                                     <div class="mb-3">
                                        <label for="admin-audit-event-id" class="form-label">ID Sự kiện / Nhiệm vụ (Duy nhất)</label>
                                        <input type="text" class="form-control" id="admin-audit-event-id" placeholder="e.g., thuong_giang_sinh_2024" required>
                                        <div class="form-text">ID này dùng để hệ thống kiểm tra, tránh cộng điểm nhiều lần.</div>
                                     </div>
                                     <hr style="border-color: var(--border-color); opacity: 0.5;">
                                     <div class="mb-3"><label for="admin-audit-condition-type" class="form-label">Thưởng cho người dùng theo</label><select class="form-select" id="admin-audit-condition-type"><option value="all" selected>Tất cả người dùng</option><option value="referralCount">Số lượt mời</option><option value="checkinCount">Số lượt Check-in</option><option value="points">Số điểm EXP</option><option value="level">Level</option></select></div>
                                     <div id="admin-audit-condition-wrapper" style="display: none;"><label class="form-label">Điều kiện</label><div class="input-group mb-3"><select class="form-select" id="admin-audit-operator" style="max-width: 150px;"><option value=">=" selected>Lớn hơn hoặc bằng</option><option value="<=">Nhỏ hơn hoặc bằng</option><option value="==">Bằng</option></select><input type="number" class="form-control" id="admin-audit-condition-value" placeholder="e.g., 10" min="0"></div></div>
                                     <div class="mb-3"><label for="admin-audit-exp-amount" class="form-label">Số lượng EXP để thưởng</label><input type="number" class="form-control" id="admin-audit-exp-amount" placeholder="e.g., 500" required min="1"></div>
                                     
                                     <div id="admin-audit-award-status" class="mt-3 text-center fw-bold"></div>
                                     <button type="submit" id="admin-audit-award-submit-btn" class="btn btn-lg w-100" style="background: linear-gradient(90deg, #ffc107, #ff9800); color: black;"><i class="fas fa-tasks me-2"></i>Chạy Rà soát và Thưởng</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================= -->


                    <!-- Bảng Gửi Tin Nhắn -->
                    <div id="admin-panel-messenger" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                            <div class="card-glass">
                                <h5 class="card-title">Gửi Tin Nhắn Hàng Loạt qua Telegram</h5>
                                <form id="admin-telegram-sender-form">
                                    <div class="mb-3">
                                        <label for="telegram-api-token-input" class="form-label">Telegram Bot API Token</label>
                                        <input type="password" class="form-control" id="telegram-api-token-input" placeholder="Dán API Token của bot vào đây" required>
                                    </div>
                                    <hr style="border-color: var(--border-color); opacity: 0.5;">
                                    <h6 class="text-secondary mb-3">NỘI DUNG TIN NHẮN</h6>
                                    <div class="mb-3">
                                        <label for="telegram-image-url-input" class="form-label">URL Hình ảnh (Tùy chọn)</label>
                                        <input type="url" class="form-control" id="telegram-image-url-input" placeholder="https://example.com/image.png">
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram-message-text-input" class="form-label">Văn bản tin nhắn / Chú thích ảnh</label>
                                        <textarea class="form-control" id="telegram-message-text-input" rows="4"></textarea>
                                    </div>
                                    <h6 class="text-secondary my-3">NÚT BẤM (TÙY CHỌN)</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="telegram-button-text-input" class="form-label">Văn bản trên nút</label>
                                            <input type="text" class="form-control" id="telegram-button-text-input">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="telegram-button-url-input" class="form-label">URL của nút</label>
                                            <input type="url" class="form-control" id="telegram-button-url-input">
                                        </div>
                                    </div>
                                    <div id="telegram-sender-status" class="mt-3 text-center fw-bold"></div>
                                    <div class="d-grid mt-3">
                                        <button type="button" id="send-bulk-telegram-message-btn" class="btn btn-lg" style="background: linear-gradient(90deg, #0088cc, #00aaff); color: white;">
                                            <i class="fab fa-telegram-plane me-2"></i>Gửi Hàng Loạt
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng Nhiệm Vụ Partner -->
                    <div id="admin-panel-partner-tasks" class="admin-panel-wrapper" style="display: none;">
                         <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                            <div class="card-glass">
                                <h5 class="card-title">Quản lý Nhiệm vụ Partner</h5>
                                <form id="admin-partner-task-form">
                                     <input type="hidden" id="partner-task-id-input">
                                    <div class="mb-3">
                                        <label for="partner-task-name-input" class="form-label">Tên dự án</label>
                                        <input type="text" class="form-control" id="partner-task-name-input" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="partner-task-desc-input" class="form-label">Mô tả ngắn</label>
                                        <textarea class="form-control" id="partner-task-desc-input" rows="2" required></textarea>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="partner-task-img-upload" class="form-label">Tải ảnh lên</label>
                                            <input class="form-control" type="file" id="partner-task-img-upload" accept="image/*">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="partner-task-img-url" class="form-label">Hoặc dán Link ảnh</label>
                                            <input type="url" class="form-control" id="partner-task-img-url" placeholder="https://...">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="partner-task-link-input" class="form-label">Link nhiệm vụ</label>
                                        <input type="url" class="form-control" id="partner-task-link-input" required placeholder="https://...">
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="partner-task-exp-input" class="form-label">EXP Thưởng</label>
                                            <input type="number" class="form-control" id="partner-task-exp-input" required min="0">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="partner-task-type-select" class="form-label">Loại nhiệm vụ</label>
                                            <select class="form-select" id="partner-task-type-select">
                                                <option value="normal" selected>Thông thường</option>
                                                <option value="mandatory">Bắt buộc (Ghim)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="admin-partner-task-status" class="mt-3 text-center"></div>
                                    <div class="d-flex gap-3 mt-3">
                                        <button type="submit" id="partner-task-save-btn" class="btn w-100" style="background-color: var(--accent-primary); color: white;">Lưu Nhiệm Vụ</button>
                                        <button type="button" id="partner-task-clear-btn" class="btn btn-outline-secondary w-50">Làm mới</button>
                                    </div>
                                </form>
                                <hr style="border-color: var(--border-color); opacity: 0.5; margin: 2rem 0;">
                                <h5 class="card-title">Danh sách Nhiệm vụ Partner</h5>
                                <div id="admin-partner-tasks-list" class="table-responsive"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ============================================= -->
                    <!-- [NEW] PANEL CÀI ĐẶT LEVEL - DÁN VÀO ĐÂY       -->
                    <!-- ============================================= -->
                    <div id="admin-panel-level-settings" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                            <div class="card-glass">
                                <h5 class="card-title">Cấu hình Level và Quyền lợi</h5>
                                <p class="text-secondary small">Tại đây, bạn có thể định nghĩa các cấp độ, số EXP cần thiết để đạt được chúng, và mô tả các quyền lợi mà người dùng sẽ nhận được khi lên cấp.</p>
                                <form id="admin-level-settings-form">
                                    <div id="level-settings-container">
                                        <!-- Các dòng cài đặt level sẽ được JS render ở đây -->
                                    </div>
                                    <button type="button" id="add-level-btn" class="btn btn-outline-secondary mt-3"><i class="fas fa-plus me-2"></i>Thêm Cấp độ</button>
                                    <div id="admin-level-settings-status" class="mt-4 text-center fw-bold"></div>
                                    <div class="d-grid mt-3">
                                        <button type="submit" id="save-level-settings-btn" class="btn btn-lg" style="background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); color: white;">
                                            <i class="fas fa-save me-2"></i>Lưu Cài đặt Level
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================= -->

                    <!-- [RESTRUCTURED] Bảng Cài đặt Airdrop -->
                    <div id="admin-panel-airdrop" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                            <div class="card-glass mb-4">
                                <h5 class="card-title">Cấu hình Tính điểm Airdrop</h5>
                                <form id="admin-airdrop-scoring-form" onsubmit="event.preventDefault();">
                                    <h6 class="text-secondary text-center my-3">CÔNG THỨC TÍNH ĐIỂM CƠ BẢN</h6>
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-4"><label for="ref-multiplier-input" class="form-label">Điểm mỗi Lượt mời</label><input type="number" class="form-control" id="ref-multiplier-input" value="50" min="0"></div>
                                        <div class="col-md-4"><label for="checkin-multiplier-input" class="form-label">Điểm mỗi Check-in</label><input type="number" class="form-control" id="checkin-multiplier-input" value="30" min="0"></div>
                                        <div class="col-md-4"><label for="exp-multiplier-input" class="form-label">Điểm mỗi EXP</label><input type="number" class="form-control" id="exp-multiplier-input" value="1" min="0" step="0.1"></div>
                                    </div>
                                    
                                    <hr style="border-color: var(--border-color); opacity: 0.5;">
                                    <h6 class="text-secondary text-center my-3">HỆ SỐ THƯỞNG THEO LEVEL (MULTIPLIER)</h6>
                                    <div id="admin-level-multipliers-container" class="mb-4" style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                                        <!-- Hệ số level sẽ được JS render ở đây -->
                                    </div>
                                    
                                    <hr style="border-color: var(--border-color); opacity: 0.5;">
                                    <h6 class="text-secondary text-center my-3">ĐIỀU KIỆN TỐI THIỂU</h6>
                                    <div class="row g-3">
                                        <div class="col-md-4"><label for="min-checkins-input" class="form-label">Tối thiểu Check-in</label><input type="number" class="form-control" id="min-checkins-input" value="0" min="0"></div>
                                        <div class="col-md-4"><label for="min-referrals-input" class="form-label">Tối thiểu Lượt mời</label><input type="number" class="form-control" id="min-referrals-input" value="0" min="0"></div>
                                        <div class="col-md-4"><label for="min-exp-input" class="form-label">Tối thiểu EXP</label><input type="number" class="form-control" id="min-exp-input" value="0" min="0"></div>
                                    </div>
                                    <div class="mt-3"><label class="form-label fw-bold" style="color: var(--gold);">ĐIỀU KIỆN NHIỆM VỤ BẮT BUỘC (Tự động áp dụng)</label></div>
                                    <div id="admin-scoring-settings-status" class="mt-3"></div>
                                    <div class="d-grid mt-3">
                                        <button type="submit" id="save-scoring-settings-btn" class="btn w-100" style="background-color: var(--accent-secondary); color: white;">Lưu Cài Đặt Tính điểm</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="card-glass">
                                <h5 class="card-title">Cấu hình & Quản lý Claim Airdrop</h5>
                                <form id="admin-airdrop-claim-form" onsubmit="event.preventDefault();">
                                     <div class="row text-center g-3 mb-4">
                                        <div class="col-6 col-sm-3">
                                            <div class="form-check form-switch fs-5 d-inline-block">
                                                <input class="form-check-input" type="checkbox" role="switch" id="airdrop-live-switch">
                                                <label class="form-check-label" for="airdrop-live-switch">Live</label>
                                            </div>
                                        </div>
                                         <div class="col-6 col-sm-3">
                                            <div class="form-check form-switch fs-5 d-inline-block">
                                                <input class="form-check-input" type="checkbox" role="switch" id="snapshot-active-switch">
                                                <label class="form-check-label" for="snapshot-active-switch" style="color: var(--color-out);">Snap</label>
                                            </div>
                                        </div>
                                        <div class="col-6 col-sm-3">
                                            <div class="form-check form-switch fs-5 d-inline-block">
                                                <input class="form-check-input" type="checkbox" role="switch" id="claim-edit-switch">
                                                <label class="form-check-label" for="claim-edit-switch">Sửa</label>
                                            </div>
                                        </div>
                                         <div class="col-6 col-sm-3">
                                            <div class="form-check form-switch fs-5 d-inline-block">
                                                <input class="form-check-input" type="checkbox" role="switch" id="notify-sent-switch">
                                                <label class="form-check-label" for="notify-sent-switch">Báo đã gửi</label>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                     <h6 class="text-secondary text-center my-3">CÀI ĐẶT PHƯƠNG THỨC CLAIM</h6>
                                     <div class="row mb-3">
                                         <div class="col-md-6 mb-3">
                                             <div class="form-check form-switch">
                                                 <input class="form-check-input" type="checkbox" role="switch" id="onchain-claim-enabled-switch">
                                                 <label class="form-check-label" for="onchain-claim-enabled-switch">Cho phép Claim On-chain</label>
                                             </div>
                                         </div>
                                         <div class="col-md-6">
                                              <div class="form-check form-switch">
                                                 <input class="form-check-input" type="checkbox" role="switch" id="offchain-claim-enabled-switch">
                                                 <label class="form-check-label" for="offchain-claim-enabled-switch">Cho phép Claim Off-chain</label>
                                             </div>
                                         </div>
                                     </div>
                                     <div id="offchain-settings-container" style="display: none;">
                                         <h6 class="text-secondary">Chọn sàn được hiển thị</h6>
                                         <div id="exchange-checkboxes-container" class="d-flex flex-wrap gap-3">
                                            <!-- Checkboxes for exchanges will be rendered here -->
                                         </div>
                                     </div>
                                    <div id="admin-claim-settings-status" class="mt-3"></div>
                                    <div class="d-flex gap-3 mt-3">
                                        <button type="submit" id="save-claim-settings-btn" class="btn w-100" style="background-color: var(--accent-primary); color: white;">Lưu Cài Đặt Claim</button>
                                        <button type="button" id="export-claim-excel-btn" class="btn btn-outline-light w-100">Xuất File Excel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>


                    <!-- Bảng Chỉnh sửa EXP / Mass Award -->
                    <div id="admin-panel-edit-exp" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                           <div class="card-glass mb-4">
                                <h5 class="card-title">Chỉnh sửa EXP cho một User</h5>
                                <form id="admin-exp-form">
                                     <div class="mb-3"><label for="admin-target-type" class="form-label">Loại định danh</label><select class="form-select" id="admin-target-type"><option value="uid" selected>UID (Telegram ID)</option><option value="address">Address (Raw)</option></select></div>
                                     <div class="mb-3"><label for="admin-target-value" class="form-label">Giá trị định danh</label><input type="text" class="form-control" id="admin-target-value" placeholder="Nhập UID hoặc địa chỉ ví..." required></div>
                                     <div class="mb-3"><label for="admin-action-type" class="form-label">Hành động</label><select class="form-select" id="admin-action-type"><option value="add" selected>Cộng EXP</option><option value="subtract">Trừ EXP</option></select></div>
                                     <div class="mb-3"><label for="admin-exp-amount" class="form-label">Số lượng EXP</label><input type="number" class="form-control" id="admin-exp-amount" placeholder="e.g., 100" required min="1"></div>
                                     <div class="mb-3"><label for="admin-task-name" class="form-label">Lý do (Task Name)</label><input type="text" class="form-control" id="admin-task-name" placeholder="e.g., Thưởng event" required></div>
                                     <button type="submit" id="admin-submit-btn" class="btn w-100" style="background-color: var(--accent-primary); color: white;"><i class="fas fa-check me-2"></i>Xác nhận</button>
                                </form>
                            </div>
                            <div class="card-glass">
                                <h5 class="card-title">Thưởng EXP Hàng Loạt</h5>
                                <form id="admin-mass-award-form">
                                     <div class="mb-3"><label for="admin-mass-condition-type" class="form-label">Thưởng cho người dùng theo</label><select class="form-select" id="admin-mass-condition-type"><option value="all" selected>Tất cả người dùng</option><option value="referralCount">Số lượt mời</option><option value="checkinCount">Số lượt Check-in</option><option value="points">Số điểm EXP</option><option value="level">Level</option></select></div>
                                     <div id="admin-mass-condition-wrapper" style="display: none;"><label class="form-label">Điều kiện</label><div class="input-group mb-3"><select class="form-select" id="admin-mass-operator" style="max-width: 150px;"><option value=">=" selected>Lớn hơn hoặc bằng</option><option value="<=">Nhỏ hơn hoặc bằng</option><option value="==">Bằng</option></select><input type="number" class="form-control" id="admin-mass-condition-value" placeholder="e.g., 10" min="0"></div></div>
                                     <div class="mb-3"><label for="admin-mass-exp-amount" class="form-label">Số lượng EXP để thưởng</label><input type="number" class="form-control" id="admin-mass-exp-amount" placeholder="e.g., 500" required min="1"></div>
                                     <div class="mb-3"><label for="admin-mass-task-name" class="form-label">Nội dung/Lý do thưởng</label><input type="text" class="form-control" id="admin-mass-task-name" placeholder="e.g., Thưởng event Giáng Sinh" required></div>
                                     <div id="admin-mass-award-status" class="mt-3 text-center"></div>
                                     <button type="submit" id="admin-mass-award-submit-btn" class="btn w-100" style="background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); color: white;"><i class="fas fa-gifts me-2"></i>Thực Hiện Thưởng Hàng Loạt</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng Trạng Thái Tài Khoản -->
                    <div id="admin-panel-account-status" class="admin-panel-wrapper" style="display: none;">
                        <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                            <div class="card-glass">
                                <h5 class="card-title">Quản lý Trạng thái Tài khoản</h5>
                                 <form id="admin-disable-form">
                                     <div class="mb-3"><label for="admin-disable-target-type" class="form-label">Loại định danh</label><select class="form-select" id="admin-disable-target-type"><option value="uid" selected>UID (Telegram ID)</option><option value="address">Address (Raw)</option></select></div>
                                     <div class="mb-3"><label for="admin-disable-target-value" class="form-label">Giá trị định danh</label><input type="text" class="form-control" id="admin-disable-target-value" placeholder="Nhập UID hoặc địa chỉ ví..." required></div>
                                     <div class="mb-3"><label for="admin-disable-duration" class="form-label">Thời gian vô hiệu hoá (ngày)</label><input type="number" class="form-control" id="admin-disable-duration" placeholder="e.g., 7 (để trống nếu muốn mở khoá)" min="0"></div>
                                     <div class="d-flex gap-3"><button type="button" id="admin-disable-btn" class="btn w-100" style="background-color: var(--color-out); color: white;"><i class="fas fa-user-lock me-2"></i>Vô hiệu hoá</button><button type="button" id="admin-enable-btn" class="btn w-100" style="background-color: var(--color-verified); color: white;"><i class="fas fa-user-check me-2"></i>Mở khoá</button></div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng Danh sách User (Mặc định hiển thị) -->
                    <div id="admin-panel-users" class="admin-panel-wrapper">
                         <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title">Danh sách Người dùng</h5>
                                <div class="mb-3">
                                    <input type="text" id="admin-user-search-input" class="form-control" placeholder="Tìm theo Tên, UID, hoặc Địa chỉ ví...">
                                </div>
                                <div id="admin-user-list-container" class="table-responsive"></div>
                                <div class="text-center mt-3">
                                    <button id="admin-load-more-btn" class="btn btn-outline-secondary" style="display: none;">Tải thêm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- [NEW] Bảng Danh sách Claim -->
                    <div id="admin-panel-claim-list" class="admin-panel-wrapper" style="display: none;">
                         <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title">Danh sách Claim Airdrop</h5>
                                <div id="admin-claim-filter-controls" class="app-filter-bar" style="justify-content: start; margin-bottom: 1.5rem;">
                                    <!-- Filter buttons will be rendered by JS -->
                                </div>
                                <div id="admin-claim-list-container" class="table-responsive"></div>
                                <div class="text-center mt-3">
                                    <button id="admin-load-more-claims-btn" class="btn btn-outline-secondary" style="display: none;">Tải thêm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bảng Cài đặt Thưởng -->
            <div id="admin-panel-reward-settings" class="admin-panel-wrapper" style="display: none;">
                <div class="col-12 col-lg-10 col-xl-8 mx-auto">
                    <div class="card-glass">
                        <h5 class="card-title">Cấu hình Phần thưởng EXP</h5>
                        <form id="admin-reward-settings-form">
                            <h6 class="text-secondary mb-3">Cài đặt Cơ bản</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="checkin-exp-input" class="form-label">EXP mỗi lần Check-in</label>
                                    <input type="number" class="form-control" id="checkin-exp-input" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label for="base-referral-exp-input" class="form-label">EXP cơ bản mỗi lượt mời</label>
                                    <input type="number" class="form-control" id="base-referral-exp-input" min="0">
                                </div>
                            </div>
                            <hr style="border-color: var(--border-color); opacity: 0.5;">
                            <h6 class="text-secondary my-3">Các Mốc Thưởng Thêm Khi Mời Bạn</h6>
                            <div id="referral-milestones-container"></div>
                            <button type="button" id="add-milestone-btn" class="btn btn-outline-secondary mt-3"><i class="fas fa-plus me-2"></i>Thêm Mốc</button>
                            <div id="admin-reward-settings-status" class="mt-4 text-center fw-bold"></div>
                            <div class="d-grid mt-3">
                                <button type="submit" id="save-reward-settings-btn" class="btn btn-lg" style="background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); color: white;">
                                    <i class="fas fa-save me-2"></i>Lưu Cài đặt
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- [MODIFIED] All Modals below -->
    
    <!-- Jetton Detail Modal -->
    <div class="modal fade" id="jettonDetailModal" tabindex="-1" aria-labelledby="jettonDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <div id="jetton-modal-header-content" class="d-flex align-items-center"></div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="jettonDetailTab" role="tablist">
              <li class="nav-item" role="presentation"><button class="nav-link active" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata-tab-pane" type="button">Metadata</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button">History</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="holders-tab" data-bs-toggle="tab" data-bs-target="#holders-tab-pane" type="button">Holders</button></li>
            </ul>
            <div class="tab-content" id="jettonDetailTabContent">
              <div class="tab-pane fade show active" id="metadata-tab-pane" role="tabpanel"></div>
              <div class="tab-pane fade" id="history-tab-pane" role="tabpanel"></div>
              <div class="tab-pane fade" id="holders-tab-pane" role="tabpanel"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Checkin Popup Modal -->
    <div class="modal fade" id="checkinPopupModal" tabindex="-1" aria-labelledby="checkinPopupModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkinPopupModalLabel"><i class="fas fa-calendar-check me-2" style="color: var(--accent-secondary);"></i>It's Check-in Time!</h5>
          </div>
          <div class="modal-body text-center">
            <p>Congratulations! You are eligible to check in and receive your reward.</p>
            <p class="display-4 fw-bold" style="color: var(--accent-primary);">+10 EXP</p>
            <p>Press the button below to claim it now!</p>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <button type="button" id="popup-checkin-button" class="btn btn-lg" style="background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); color: white; font-weight: 600;">Check-in and Claim Reward</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Admin Modal -->
    <div class="modal fade" id="contactAdminModal" tabindex="-1" aria-labelledby="contactAdminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactAdminModalLabel"><i class="fab fa-telegram-plane me-2"></i>Contact Admin</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p>If you need assistance or have any questions, please contact the administrator via Telegram.</p>
                    <a href="https://t.me/BmassK3" target="_blank" rel="noopener noreferrer" class="btn btn-lg w-100" style="background-color: #0088cc; color: white;">
                        <i class="fab fa-telegram-plane me-2"></i> Open Telegram (@BmassK3)
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- [NEW] Email Update Modal -->
    <div class="modal fade" id="emailUpdateModal" tabindex="-1" aria-labelledby="emailUpdateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailUpdateModalLabel"><i class="fas fa-envelope me-2"></i>Update Email</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-secondary small">Please enter your email address. This is optional and used for account recovery or important notifications.</p>
                    <form id="email-update-form">
                        <div class="mb-3">
                            <label for="email-input" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email-input" placeholder="you@example.com" required>
                        </div>
                        <div id="email-update-status" class="text-center"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="save-email-btn" class="btn" style="background-color: var(--accent-primary); color: white;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- [UPDATED] Temporary Profile Setup Modal with better UI -->
    <div class="modal fade" id="profileSetupModal" tabindex="-1" aria-labelledby="profileSetupModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileSetupModalLabel"><i class="fas fa-user-edit me-2"></i>Setup Your Profile</h5>
                </div>
                <div class="modal-body">
                    <p class="text-secondary small">Since you're joining from the web, please set up a temporary profile. This will be updated automatically when you log in via the Telegram Mini App.</p>
                    <form id="profile-setup-form">
                        <div class="text-center mb-3">
                            <label for="temp-avatar-upload" class="avatar-upload-container">
                                <img id="temp-avatar-preview" src="https://bmass.vercel.app/img/bmasslogo.png" alt="Avatar Preview" class="avatar-preview">
                                <div class="avatar-overlay">
                                    <i class="fas fa-camera"></i>
                                    <span>Change</span>
                                </div>
                            </label>
                            <input type="file" id="temp-avatar-upload" accept="image/*" style="display: none;">
                        </div>
                        <div class="mb-3">
                            <label for="temp-fullname-input" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="temp-fullname-input" placeholder="Enter your name" required>
                        </div>
                        <div id="profile-setup-status" class="text-center"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="save-temp-profile-btn" class="btn w-100" style="background-color: var(--accent-primary); color: white;">Save and Continue</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/apps-data.js"></script>
    



<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START OF DOMCONTENTLOADED ---

    document.addEventListener('touchmove', function (event) {
      if (event.scale !== 1) { event.preventDefault(); }
    }, { passive: false });

    // Chặn double-tap để zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);


    
    const TON_API_BASE = 'https://tonapi.io/v2';
    const COINGECKO_API_BASE = 'https://api.coingecko.com/api/v3';
    const USER_SESSION_KEY = 'BmassUserSession';
    const REFERRAL_SESSION_KEY = 'BmassReferralCode';
    
    // --- CONFIGURATION ---
    const YOUR_TELEGRAM_BOT_NAME = "bmassk3_bot"; 
    const YOUR_MINI_APP_NAME = "BmassK3"; 
    const YOUR_WEB_APP_URL = "https://bmass.vercel.app/";
    
    // Admin Credentials
    const ADMIN_ADDRESS = '0:eef2fc994996c062f45143f8d6e3fd048811a26c01aaef6c126636164663401a';
    const ADMIN_UID = 5387725104;

    // Element Selectors
    const loadingOverlay = document.getElementById('loading-overlay');
    const maintenanceOverlay = document.getElementById('maintenance-overlay');
    const adminMaintenanceBanner = document.getElementById('admin-maintenance-banner');
    const accountSectionEl = document.getElementById('account-section');
    const dashboardEl = document.getElementById('dashboard');
    const heroEl = document.getElementById('hero-section');
    const mainAssetsContent = document.getElementById('main-assets-content');
    const activityFeedContent = document.getElementById('activity-feed-content');
    const otherTokensContent = document.getElementById('other-tokens-content');
    const nftGalleryContent = document.getElementById('nft-gallery-content');
    const searchInput = document.getElementById('account-search-input');
    const searchButton = document.getElementById('account-search-button');
    const searchResultsContainer = document.getElementById('search-results-container');
    const backToMyWalletBtn = document.getElementById('back-to-my-wallet-btn');
    const newsSection = document.getElementById('crypto-news-feed');
    const newsContentArea = document.getElementById('news-content-area');
    const hamburgerBtn = document.getElementById('hamburger-menu-btn');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const navDashboard = document.getElementById('nav-dashboard');
    const navApps = document.getElementById('nav-apps');
    const navTask = document.getElementById('nav-task');
    const navPartner = document.getElementById('nav-partner');
    const navReferral = document.getElementById('nav-referral');
    const navAirdrop = document.getElementById('nav-airdrop');
    const navLeaderboard = document.getElementById('nav-leaderboard');
    const navAccount = document.getElementById('nav-account'); 
    const navAdmin = document.getElementById('nav-admin');
    const tonConnectButtonRoot = document.getElementById('ton-connect-button-root');
    const connectWalletHeroBtnContainer = document.getElementById('connect-wallet-hero-btn-container');
    const customWalletContainer = document.getElementById('custom-wallet-button-container');
    const customWalletButton = document.getElementById('custom-wallet-button');
    const walletDropdown = document.getElementById('wallet-dropdown');
    const copyAddressBtn = document.getElementById('copy-address-btn');
    const disconnectWalletBtn = document.getElementById('disconnect-wallet-btn');
    const fullLogoutBtn = document.getElementById('full-logout-btn');
    const myAccountBtn = document.getElementById('my-account-btn');
    const appLogoImg = document.getElementById('app-logo-img');
    const appLogoText = document.getElementById('app-logo-text');
    const appStoreSection = document.getElementById('app-store-section');
    const taskSectionEl = document.getElementById('task-section');
    const partnerSectionEl = document.getElementById('partner-section');
    const leaderboardSectionEl = document.getElementById('leaderboard-section');
    const adminSectionEl = document.getElementById('admin-section');
    const referralSectionEl = document.getElementById('referral-section');
    const airdropSectionEl = document.getElementById('airdrop-section');
    const appGrid = document.getElementById('app-grid');
    const appSearchInput = document.getElementById('app-search-input');
    const appSearchButton = document.getElementById('app-search-button');
    const appFilterControls = document.getElementById('app-filter-controls');
    const jettonDetailModalEl = document.getElementById('jettonDetailModal');
    const jettonDetailModal = new bootstrap.Modal(jettonDetailModalEl);
    const emailUpdateModalEl = document.getElementById('emailUpdateModal');
    const emailUpdateModal = new bootstrap.Modal(emailUpdateModalEl);
    const saveEmailBtn = document.getElementById('save-email-btn');
    const profileSetupModalEl = document.getElementById('profileSetupModal');
    const profileSetupModal = new bootstrap.Modal(profileSetupModalEl);
    const saveTempProfileBtn = document.getElementById('save-temp-profile-btn');
    const portfolioContent = document.getElementById('portfolio-overview-content');
    const portfolioSkeleton = document.getElementById('portfolio-overview-skeleton');
    const totalValueUsdEl = document.getElementById('total-value-usd');
    const totalValueVndEl = document.getElementById('total-value-vnd');
    const taskExpBalanceEl = document.getElementById('task-exp-balance');
    const headerExpDisplay = document.getElementById('header-exp-display');
    const headerExpBalanceEl = document.getElementById('header-exp-balance');
    const checkinButton = document.getElementById('checkin-button');
    const popupCheckinButton = document.getElementById('popup-checkin-button');
    const checkinPopupModalEl = document.getElementById('checkinPopupModal');
    const checkinPopupModal = new bootstrap.Modal(checkinPopupModalEl);
    const taskHistoryContent = document.getElementById('task-history-content');
    const adminExpForm = document.getElementById('admin-exp-form');
    const adminSubmitBtn = document.getElementById('admin-submit-btn');
    const adminDisableForm = document.getElementById('admin-disable-form');
    const adminDisableBtn = document.getElementById('admin-disable-btn');
    const adminEnableBtn = document.getElementById('admin-enable-btn');
    const adminUserListContainer = document.getElementById('admin-user-list-container');
    const adminUserSearchInput = document.getElementById('admin-user-search-input');
    const adminLoadMoreBtn = document.getElementById('admin-load-more-btn');
    const referralInputContainer = document.getElementById('referral-input-container');
    const referralCodeInput = document.getElementById('referral-code-input');
    const referralCodeSubmit = document.getElementById('referral-code-submit');
    const referralInputContainerHero = document.getElementById('referral-input-container-hero');
    const referralCodeInputHero = document.getElementById('referral-code-input-hero');
    const referralCodeSubmitHero = document.getElementById('referral-code-submit-hero');
    const contactAdminBtn = document.getElementById('contact-admin-btn');
    const contactAdminModal = new bootstrap.Modal(document.getElementById('contactAdminModal'));
    
    // Mass Award Form Elements
    const adminMassAwardForm = document.getElementById('admin-mass-award-form');
    const adminMassConditionType = document.getElementById('admin-mass-condition-type');
    const adminMassConditionWrapper = document.getElementById('admin-mass-condition-wrapper');
    const adminMassAwardSubmitBtn = document.getElementById('admin-mass-award-submit-btn');
    const adminMassAwardStatus = document.getElementById('admin-mass-award-status');
    
    // Partner Task Elements
    const partnerTasksContainer = document.getElementById('partner-tasks-container');
    const adminPartnerTaskForm = document.getElementById('admin-partner-task-form');
    const partnerTaskIdInput = document.getElementById('partner-task-id-input');
    const partnerTaskSaveBtn = document.getElementById('partner-task-save-btn');
    const partnerTaskClearBtn = document.getElementById('partner-task-clear-btn');
    const adminPartnerTaskStatus = document.getElementById('admin-partner-task-status');
    const adminPartnerTasksList = document.getElementById('admin-partner-tasks-list');

    // Telegram Sender Elements
    const sendBulkTelegramMessageBtn = document.getElementById('send-bulk-telegram-message-btn');
    const telegramSenderStatus = document.getElementById('telegram-sender-status');
    
    // [NEW] Maintenance Mode Switch
    const maintenanceModeSwitch = document.getElementById('maintenance-mode-switch');
    const adminSystemStatus = document.getElementById('admin-system-status');
    
    // [NEW] Leaderboard Total Users
    const leaderboardTotalUsersEl = document.getElementById('leaderboard-total-users');

    // [NEW-FEATURE] Audit & Award Elements
    const adminAuditAwardForm = document.getElementById('admin-audit-award-form');
    const adminAuditConditionType = document.getElementById('admin-audit-condition-type');
    const adminAuditConditionWrapper = document.getElementById('admin-audit-condition-wrapper');
    const adminAuditAwardSubmitBtn = document.getElementById('admin-audit-award-submit-btn');
    const adminAuditAwardStatus = document.getElementById('admin-audit-award-status');

    // [FIX-BUG] Recalculate Button
    const recalculateUsersBtn = document.getElementById('recalculate-users-btn');
    const recalculateStatusEl = document.getElementById('recalculate-status');
    
    // [NEW] Admin Airdrop Panel Elements
    const saveScoringSettingsBtn = document.getElementById('save-scoring-settings-btn');
    const saveClaimSettingsBtn = document.getElementById('save-claim-settings-btn');
    const exportClaimExcelBtn = document.getElementById('export-claim-excel-btn');
    const adminScoringSettingsStatusEl = document.getElementById('admin-scoring-settings-status');
    const adminClaimSettingsStatusEl = document.getElementById('admin-claim-settings-status');
    const offchainSettingsContainer = document.getElementById('offchain-settings-container');
    const offchainClaimEnabledSwitch = document.getElementById('offchain-claim-enabled-switch');
    const adminClaimListContainer = document.getElementById('admin-claim-list-container');
    const adminLoadMoreClaimsBtn = document.getElementById('admin-load-more-claims-btn');
    const adminClaimFilterControls = document.getElementById('admin-claim-filter-controls');


    const DEFAULT_LOGO_SRC = 'https://bmass.vercel.app/img/bmasslogo.png';
    const GENERIC_WALLET_ICON = 'https://ton.org/download/ton_symbol.png';
    const GENERIC_TASK_ICON = 'https://bmass.vercel.app/img/bmass.png';

    // State Variables
    let telegramUserData = null;
    let connectedWalletAddress = null; // Raw address from wallet
    let currentUserData = null; // Full user profile from Firestore
    let airdropSettings = null; // Will hold all airdrop settings from admin
    let systemStatus = { isMaintenanceMode: false }; // [NEW] System status
    let lastFetchedAddress = null;
    let currentActivityLogs = [];
    let activityRefreshInterval = null;
    const addressCache = {};
    let searchTimeout;
    let db = null;
    let storage = null; // Firebase Storage
    let checkinInterval = null;
    let lastVisibleAdminUser = null; // For admin pagination
    let lastVisibleAdminClaim = null; // For admin claim list pagination
    let userAirdropClaimData = null; // [NEW] To store user's claim info

    // [UPDATED] Level System Configuration - Now treated as a default/fallback
    let levelConfig = [
        { level: 1, expRequired: 0,         shieldClass: 'level-shield-1', benefit: "Unlock Daily Check-in" },
        { level: 2, expRequired: 15000,     shieldClass: 'level-shield-2', benefit: "Unlock Referral System" },
        { level: 3, expRequired: 50000,     shieldClass: 'level-shield-3', benefit: "+1% EXP bonus on all tasks" },
        { level: 4, expRequired: 100000,    shieldClass: 'level-shield-4', benefit: "Access to special partner tasks" },
        { level: 5, expRequired: 200000,    shieldClass: 'level-shield-5', benefit: "+2% EXP bonus & priority support" },
        { level: 6, expRequired: 400000,    shieldClass: 'level-shield-6', benefit: "Unique role in community" },
        { level: 7, expRequired: 700000,    shieldClass: 'level-shield-7', benefit: "Early access to new features" },
        { level: 8, expRequired: 1200000,   shieldClass: 'level-shield-8', benefit: "Higher Airdrop multiplier" },
        { level: 9, expRequired: 2000000,   shieldClass: 'level-shield-9', benefit: "Direct line to the dev team" },
        { level: 10, expRequired: 5000000,  shieldClass: 'level-shield-10', benefit: "Legendary status & surprise rewards" }
    ];

    // [NEW] Reward Configuration Variable
    let rewardConfig = {
        checkinExp: 1000,
        baseReferralExp: 5000,
        referralMilestones: [
            { required: 5, bonus: 10000 },
            { required: 10, bonus: 25000 },
            { required: 25, bonus: 70000 },
            { required: 50, bonus: 150000 },
            { required: 100, bonus: 500000 }
        ]
    }; // Default values

    // [NEW] Exchange Configuration
    const exchanges = [
        { id: 'binance', name: 'Binance', logo: 'https://s2.coinmarketcap.com/static/img/exchanges/64x64/270.png' },
        { id: 'okx', name: 'OKX', logo: 'https://s2.coinmarketcap.com/static/img/exchanges/64x64/294.png' },
        { id: 'bybit', name: 'Bybit', logo: 'https://bmass.vercel.app/logo-coin/bybitx.png' },
        { id: 'bitget', name: 'Bitget', logo: 'https://bmass.vercel.app/logo-coin/bitget.jpg' },
        { id: 'kucoin', name: 'KuCoin', logo: 'https://s2.coinmarketcap.com/static/img/exchanges/64x64/311.png' },
        { id: 'gateio', name: 'Gate.io', logo: 'https://s2.coinmarketcap.com/static/img/exchanges/64x64/302.png' }
    ];

    // Constants
    const CHECKIN_COOLDOWN = 24 * 60 * 60 * 1000;
    const ADMIN_LIST_PER_PAGE = 50;
    const BATCH_SIZE = 200; // For mass award processing
    const FIRESTORE_FETCH_BATCH_SIZE = 500; // For fetching all users
    const TELEGRAM_SEND_DELAY_MS = 150; // Delay between each message to avoid rate limits
    
    // [UPDATED] On-chain claim constants to match user request
    const ONCHAIN_CLAIM_WALLET_ADDRESS = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD"; // Admin wallet to receive gas fee
    const ONCHAIN_CLAIM_FEE_TON = 0.02;
    const ONCHAIN_CLAIM_FEE_NANOTONS = "20000000";

    const skeletonAsset = `<div class="d-flex align-items-center mb-3"><img class="skeleton-loader me-3" style="width: 48px; height: 48px; border-radius: 50%;"><div><div class="skeleton-loader skeleton-line" style="width: 100px;"></div><div class="skeleton-loader skeleton-line" style="width: 150px;"></div></div></div><div class="skeleton-loader skeleton-line w-100 mb-3"></div><div class="skeleton-loader skeleton-line w-100 mb-3"></div><div class="skeleton-loader skeleton-line w-100"></div>`;
    const skeletonTx = `<div class="d-flex align-items-center mb-3"><div class="skeleton-loader me-3" style="width: 40px; height: 40px; border-radius: 50%;"></div><div style="flex-grow: 1;"><div class="skeleton-loader skeleton-line"></div><div class="skeleton-loader skeleton-line w-50"></div></div></div>`;

    // --- Core Logic ---

    function initializeFirebase() {
        if (db) return;
        const firebaseConfig = {
            apiKey: "AIzaSyCHjgJkqVmgpZ6s5HRobpqB6XT--Sa2_zY",
            authDomain: "tgapp-30a28.firebaseapp.com",
            projectId: "tgapp-30a28",
            storageBucket: "tgapp-30a28.firebasestorage.app",
            messagingSenderId: "329047273664",
            appId: "1:329047273664:web:c9e1bfe367afb54953fd25",
            measurementId: "G-68P4PT49B0"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        storage = firebase.storage();
    }
    
    function showLoadingOverlay(message = 'Please wait...') {
        loadingOverlay.querySelector('p').textContent = message;
        loadingOverlay.classList.add('visible');
    }

    function hideLoadingOverlay() {
        loadingOverlay.classList.remove('visible');
    }
    
    // [NEW] Fetch system status
    async function fetchSystemStatus() {
        if (!db) return { isMaintenanceMode: false };
        try {
            const doc = await db.collection('admin_settings').doc('system_status').get();
            if (doc.exists) {
                systemStatus = doc.data();
            } else {
                // If it doesn't exist, create it with default false value
                await db.collection('admin_settings').doc('system_status').set({ isMaintenanceMode: false });
                systemStatus = { isMaintenanceMode: false };
            }
        } catch (error) {
            console.error("Error fetching system status:", error);
            systemStatus = { isMaintenanceMode: false }; // Default to off on error
        }
        return systemStatus;
    }
    
    // [UPDATED] Check and apply maintenance mode
    function applyMaintenanceMode(walletAddress = null) {
        if (systemStatus.isMaintenanceMode) {
            // Allow admin access by checking the specific wallet address
            const isWalletAdmin = walletAddress === ADMIN_ADDRESS;
            if (isWalletAdmin) {
                adminMaintenanceBanner.style.display = 'block';
                return false; // Admin is not blocked
            } else {
                maintenanceOverlay.classList.add('visible');
                return true; // App flow should stop for non-admins
            }
        } else {
             maintenanceOverlay.classList.remove('visible');
             adminMaintenanceBanner.style.display = 'none';
        }
        return false; // App flow can continue
    }


    async function onUserAuthenticated() {
        hideLoadingOverlay();
        
        // [UPDATED] Re-check maintenance mode now that we know if user is admin
        if(applyMaintenanceMode(connectedWalletAddress)) return;
        
        updateUIAfterLogin();
        await fetchAndDisplayAccountData(connectedWalletAddress);
        activityRefreshInterval = setInterval(() => {
            if (lastFetchedAddress === connectedWalletAddress) {
                fetchAndDisplayAccountData(connectedWalletAddress);
            }
        }, 30000);
    }
    
    function isCurrentUserAdmin() {
        if(systemStatus.isMaintenanceMode && connectedWalletAddress === ADMIN_ADDRESS){
            return true;
        }
        if (!currentUserData) return false;
        const isAdminByAddress = currentUserData.address === ADMIN_ADDRESS;
        const isAdminByUID = currentUserData.telegramId === ADMIN_UID;
        return isAdminByAddress || isAdminByUID;
    }

    async function checkMandatoryTasksCompletion(userAddress) {
        if (!db) return true;

        const mandatoryTasksSnapshot = await db.collection('partner_tasks').where('taskType', '==', 'mandatory').get();
        if (mandatoryTasksSnapshot.empty) {
            return true;
        }
        
        const mandatoryTaskIds = new Set(mandatoryTasksSnapshot.docs.map(doc => doc.id));
        
        const completedTasksSnapshot = await db.collection('users').doc(userAddress).collection('completed_partner_tasks').get();
        const completedTaskIds = new Set(completedTasksSnapshot.docs.map(doc => doc.id));

        for (const taskId of mandatoryTaskIds) {
            if (!completedTaskIds.has(taskId)) {
                return false;
            }
        }

        return true;
    }

    async function calculateBmassReward(user, settings) {
        if (!user || !settings) return 0;
        
        const refCount = user.referralCount || 0;
        const checkinCount = user.checkinCount || 0;
        const expCount = user.points || 0;
        
        const refMultiplier = settings.refMultiplier ?? 50;
        const checkinMultiplier = settings.checkinMultiplier ?? 30;
        const expMultiplier = settings.expMultiplier ?? 1;

        // 1. Calculate the base reward
        const baseReward = (refCount * refMultiplier) + (checkinCount * checkinMultiplier) + (expCount * expMultiplier);

        // 2. Get the level multiplier
        const userLevel = user.level || 1;
        let levelMultiplier = 1.0;
        if (settings.levelMultipliers && Array.isArray(settings.levelMultipliers)) {
            const multiplierData = settings.levelMultipliers.find(m => m.level === userLevel);
            if (multiplierData && typeof multiplierData.multiplier === 'number') {
                levelMultiplier = multiplierData.multiplier;
            }
        }

        // 3. Apply the level multiplier
        const finalReward = baseReward * levelMultiplier;

        return Math.floor(finalReward);
    }
    
    // [UPDATED] to include LEVEL BACKFILLING
    async function loadOrCreateUserByAddress(address) {
        if (!address || !db) return;
    
        showLoadingOverlay('Authenticating and syncing...');
    
        // Logic to prevent TG account hijacking
        if (telegramUserData) {
            const uidQuery = db.collection('users').where('telegramId', '==', telegramUserData.id).limit(1);
            const uidSnapshot = await uidQuery.get();
    
            if (!uidSnapshot.empty) {
                const existingUserDoc = uidSnapshot.docs[0];
                const existingUserData = existingUserDoc.data();
                if (existingUserData.address !== address) {
                    hideLoadingOverlay();
                    showAppToast('Link Error', `This Telegram account is already linked with another wallet.`, 'error');
                    handleFullLogout();
                    return;
                }
            }
        }
        
        const userRef = db.collection('users').doc(address);
        let doc = await userRef.get();
    
        if (!doc.exists) {
            console.log(`Creating new user profile for address: ${address}`);
            const newUser = {
                address: address,
                points: 0,
                level: 1, // [NEW] Initialize level
                lastCheckin: null,
                checkinCount: 0,
                referralCount: 0,
                referredBy: null,
                partnerTasksCompletedCount: 0,
                disabledUntil: null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                notificationsEnabled: true,
                email: null,
                telegramId: telegramUserData ? telegramUserData.id : null,
                username: telegramUserData ? (telegramUserData.username || `user${telegramUserData.id}`) : null,
                fullName: telegramUserData ? `${telegramUserData.first_name || ''} ${telegramUserData.last_name || ''}`.trim() : null,
                photoUrl: telegramUserData ? telegramUserData.photo_url : null,
                temporaryFullName: null,
                temporaryPhotoUrl: null,
                isTemporaryProfile: !telegramUserData
            };
    
            await userRef.set(newUser);
            currentUserData = newUser;
            
            const metadataRef = db.collection('admin_settings').doc('metadata');
            await metadataRef.set({ 
                userCount: firebase.firestore.FieldValue.increment(1) 
            }, { merge: true });

    
            if (newUser.isTemporaryProfile) {
                hideLoadingOverlay();
                profileSetupModal.show();
                return; 
            }
            
            const referrerCode = sessionStorage.getItem(REFERRAL_SESSION_KEY);
            if (referrerCode) {
                await applyReferral(referrerCode, address);
                 // Re-fetch user data after referral to get updated points
                doc = await userRef.get();
                currentUserData = doc.data();
            }
    
        } else {
            let userData = doc.data();
    
            if (userData.disabledUntil && userData.disabledUntil.toDate() > new Date()) {
                hideLoadingOverlay();
                showAppToast('Account Disabled', `Your account is temporarily disabled until ${userData.disabledUntil.toDate().toLocaleString('en-US')}.`, 'error');
                handleFullLogout();
                return;
            }
    
            if (telegramUserData && userData.telegramId && userData.telegramId !== telegramUserData.id) {
                hideLoadingOverlay();
                const ownerUsername = userData.username ? `@${userData.username}` : 'another user';
                showAppToast('Ownership Error', `This wallet already belongs to ${ownerUsername}.`, 'error');
                handleFullLogout();
                return;
            }
    
            const updates = {};
            if (telegramUserData && userData.isTemporaryProfile) {
                Object.assign(updates, {
                    telegramId: telegramUserData.id,
                    username: telegramUserData.username || `user${telegramUserData.id}`,
                    fullName: `${telegramUserData.first_name || ''} ${telegramUserData.last_name || ''}`.trim(),
                    photoUrl: telegramUserData.photo_url || null,
                    isTemporaryProfile: false 
                });
            }
    
            if (telegramUserData && !userData.telegramId) {
                 Object.assign(updates, {
                    telegramId: telegramUserData.id,
                    username: telegramUserData.username || `user${telegramUserData.id}`,
                    fullName: `${telegramUserData.first_name || ''} ${telegramUserData.last_name || ''}`.trim(),
                    photoUrl: telegramUserData.photo_url || null,
                });
            }
            
            if (typeof userData.email === 'undefined') { updates.email = null; }
            if (typeof userData.isTemporaryProfile === 'undefined') { updates.isTemporaryProfile = !userData.telegramId; }
            if (typeof userData.level === 'undefined') { updates.level = 1; } // [NEW] Add level to old users

            // [NEW] Check for level up on login (BACKFILLING LOGIC)
            const calculatedLevel = calculateLevel(userData.points || 0);
            if (userData.level !== calculatedLevel) {
                updates.level = calculatedLevel;
            }
    
            if (Object.keys(updates).length > 0) {
                 console.log(`Updating existing user profile:`, updates);
                 await userRef.update(updates);
                 userData = { ...userData, ...updates };
            }
            
            currentUserData = userData;
        }
        
        await onUserAuthenticated();
    }
    
    // [NEW] Level Calculation Function
    function calculateLevel(exp) {
        if (typeof exp !== 'number' || exp < 0) return 1;
        let currentLevel = 1;
        // Iterate backwards to find the highest level achieved
        for (let i = levelConfig.length - 1; i >= 0; i--) {
            if (exp >= levelConfig[i].expRequired) {
                currentLevel = levelConfig[i].level;
                break;
            }
        }
        return currentLevel;
    }
    
    // [NEW] Check and update level after gaining EXP
    async function checkAndUpdateLevel(userAddress, newPoints) {
        if (!currentUserData) return; // Cannot check level if user data is not loaded
        const oldLevel = currentUserData.level;
        const newLevel = calculateLevel(newPoints);
        
        if (oldLevel !== newLevel) {
            // Level up!
            currentUserData.level = newLevel; // Update state immediately for UI responsiveness
            try {
                const userRef = db.collection('users').doc(userAddress);
                await userRef.update({ level: newLevel });
                showAppToast(
                    'Level Up!', 
                    `Congratulations, you've reached Level ${newLevel}!`, 
                    'success'
                );
                // Re-render UI to show new shield and benefits
                updateLevelUI(newLevel, newPoints);
            } catch(error) {
                console.error("Failed to update user level in Firestore:", error);
                currentUserData.level = oldLevel; // Revert state on failure
            }
        }
    }


    async function applyReferral(referrerCode, newAddress) {
        if (airdropSettings?.isSnapshotActive) {
            showAppToast('Halted', 'Point-earning activities are paused due to the snapshot.', 'warning');
            return;
        }
        if (!referrerCode || !newAddress) return;

        if (referrerCode === newAddress || (telegramUserData && referrerCode === String(telegramUserData.id))) {
             showAppToast('Error', 'You cannot refer yourself.', 'warning');
             return;
        }

        console.log(`Attempting to apply referral code "${referrerCode}" for new user ${newAddress}`);

        let referrerQuery;
        if (!isNaN(referrerCode)) {
            referrerQuery = db.collection('users').where('telegramId', '==', parseInt(referrerCode, 10));
        } else {
            referrerQuery = db.collection('users').where('address', '==', referrerCode);
        }

        try {
            const snapshot = await referrerQuery.get();
            if (snapshot.empty) {
                showAppToast('Error', 'Invalid referral code.', 'error');
                return;
            }

            const referrerDoc = snapshot.docs[0];
            const referrerRef = referrerDoc.ref;
            
            if (referrerDoc.data().address === newAddress) {
                showAppToast('Error', 'You cannot refer yourself.', 'warning');
                return;
            }

            await db.runTransaction(async (transaction) => {
                const freshReferrerDoc = await transaction.get(referrerRef);
                const newUserDoc = await transaction.get(db.collection('users').doc(newAddress));

                if (!freshReferrerDoc.exists) throw "Referrer does not exist in the transaction";
                if (!newUserDoc.exists) throw "New user does not exist in the transaction";

                const referrerData = freshReferrerDoc.data();
                const newUserData = newUserDoc.data();
                
                const newTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                const newReferralCount = (referrerData.referralCount || 0) + 1;
                let totalRewardForReferrer = rewardConfig.baseReferralExp;
                let milestoneBonus = 0;
                
                const milestoneReached = rewardConfig.referralMilestones.find(m => m.required === newReferralCount);
                if (milestoneReached) {
                    milestoneBonus = milestoneReached.bonus;
                    totalRewardForReferrer += milestoneBonus;
                }

                // Calculate referrer's new points and level
                const referrerNewPoints = (referrerData.points || 0) + totalRewardForReferrer;
                const referrerNewLevel = calculateLevel(referrerNewPoints);
                
                transaction.update(referrerRef, {
                    points: firebase.firestore.FieldValue.increment(totalRewardForReferrer),
                    referralCount: firebase.firestore.FieldValue.increment(1),
                    level: referrerNewLevel // Update referrer's level
                });
                
                const referrerHistoryRef = referrerRef.collection('task_history').doc();
                transaction.set(referrerHistoryRef, {
                    taskName: 'Invited a friend',
                    exp: rewardConfig.baseReferralExp,
                    timestamp: newTimestamp,
                    referredUser: newAddress 
                });

                if (milestoneBonus > 0) {
                    const milestoneHistoryRef = referrerRef.collection('task_history').doc();
                    transaction.set(milestoneHistoryRef, {
                        taskName: `Referral Milestone (${newReferralCount} invites)`,
                        exp: milestoneBonus,
                        timestamp: newTimestamp
                    });
                }
                
                // Calculate new user's new points and level
                const newUserNewPoints = (newUserData.points || 0) + rewardConfig.baseReferralExp;
                const newUserNewLevel = calculateLevel(newUserNewPoints);

                transaction.update(db.collection('users').doc(newAddress), { 
                    referredBy: String(referrerCode),
                    points: firebase.firestore.FieldValue.increment(rewardConfig.baseReferralExp),
                    level: newUserNewLevel // Update new user's level
                });

                const newUserHistoryRef = db.collection('users').doc(newAddress).collection('task_history').doc();
                transaction.set(newUserHistoryRef, {
                    taskName: 'Entered referral code',
                    exp: rewardConfig.baseReferralExp,
                    timestamp: newTimestamp,
                    referrer: String(referrerCode)
                });
            });
            
            showAppToast(`Referral Bonus!`, `You and your referrer both received rewards.`, 'success');

        } catch (error) {
            console.error("Failed to apply referral:", error);
            showAppToast('Error', 'Could not apply referral code. Please try again.', 'error');
        }
    }
    
function updateUIAfterLogin() {
    if (!currentUserData) return;
    
    // [NEW] CẬP NHẬT ĐỘNG HIỂN THỊ EXP THƯỞNG CHO CHECK-IN
    const checkinExpDisplay = document.getElementById('checkin-exp-display');
    if (checkinExpDisplay) {
        checkinExpDisplay.textContent = `+${(rewardConfig.checkinExp || 1000).toLocaleString()} EXP`;
    }

    headerExpDisplay.classList.remove('d-none');
    updateExpBalances(currentUserData.points || 0);
    updateCheckinUI(currentUserData);
    fetchTaskHistory();
    renderAccountSection();
    renderReferralSection();
    updateLevelUI(currentUserData.level, currentUserData.points); // [NEW] Update level UI on login
    
    handleRouteChange(); 
    
    if (isCurrentUserAdmin()) {
        navAdmin.style.display = 'block';
    } else {
        navAdmin.style.display = 'none';
    }
}
    
    function updateExpBalances(newExp) {
        taskExpBalanceEl.textContent = newExp.toLocaleString();
        headerExpBalanceEl.textContent = newExp.toLocaleString();
    }

    function updateCheckinUI(userData) {
        if (!userData) return;

        if (airdropSettings?.isSnapshotActive) {
            checkinButton.disabled = true;
            checkinButton.innerHTML = `<i class="fas fa-pause-circle me-2"></i>Snapshot Taken`;
            if (checkinInterval) clearInterval(checkinInterval);
            return;
        }

        if (checkinInterval) clearInterval(checkinInterval);
        
        const { lastCheckin } = userData;
        const isEligible = !lastCheckin || (Date.now() - lastCheckin.toDate().getTime() >= CHECKIN_COOLDOWN);

        if (isEligible) {
            checkinButton.disabled = false;
            checkinButton.innerHTML = `<i class="fas fa-calendar-check me-2"></i> Claim Reward`;
        } else {
            checkinButton.disabled = true;
            const lastCheckinTime = lastCheckin.toDate().getTime();

            const updateCountdown = () => {
                const now = Date.now();
                const newRemaining = CHECKIN_COOLDOWN - (now - lastCheckinTime);
                if (newRemaining <= 0) {
                    clearInterval(checkinInterval);
                    checkinButton.disabled = false;
                    checkinButton.innerHTML = `<i class="fas fa-calendar-check me-2"></i> Claim Reward`;
                } else {
                    const hours = Math.floor((newRemaining / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
                    const minutes = Math.floor((newRemaining / 1000 / 60) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((newRemaining / 1000) % 60).toString().padStart(2, '0');
                    checkinButton.innerHTML = `<i class="fas fa-hourglass-half me-2"></i> ${hours}:${minutes}:${seconds}`;
                }
            };
            updateCountdown();
            checkinInterval = setInterval(updateCountdown, 1000);
        }
    }

    async function handleCheckin() {
        if (airdropSettings?.isSnapshotActive) {
            showAppToast('Halted', 'Point-earning activities are paused due to the snapshot.', 'warning');
            return;
        }
        if (!connectedWalletAddress || !db) {
            showAppToast('Error', 'Please connect your wallet to check in.', 'error');
            return;
        };
        
        checkinPopupModal.hide();
        checkinButton.disabled = true;
        popupCheckinButton.disabled = true;
        checkinButton.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Processing...`;
        
        const userRef = db.collection('users').doc(connectedWalletAddress);
        
        try {
            let newTotalPoints;
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) throw "User document not found!";

                const userData = userDoc.data();
                const lastCheckin = userData.lastCheckin;

                if (lastCheckin && (Date.now() - lastCheckin.toDate().getTime() < CHECKIN_COOLDOWN)) {
                    showAppToast('Notice', 'You have already checked in today. Please come back later.', 'warning');
                    return;
                }

                newTotalPoints = (userData.points || 0) + rewardConfig.checkinExp;
                // No need to calculate level here, checkAndUpdateLevel will be called after
                const newTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                transaction.update(userRef, {
                    points: firebase.firestore.FieldValue.increment(rewardConfig.checkinExp),
                    lastCheckin: newTimestamp,
                    checkinCount: firebase.firestore.FieldValue.increment(1)
                });
            
                const historyRef = userRef.collection('task_history').doc();
                transaction.set(historyRef, {
                    taskName: 'Daily Check-in',
                    exp: rewardConfig.checkinExp,
                    timestamp: newTimestamp
                });
            });

            showAppToast('Success!', `You've received ${rewardConfig.checkinExp} EXP.`, 'success');
            // Update current user data and then check for level up
            currentUserData.points = newTotalPoints;
            checkAndUpdateLevel(connectedWalletAddress, newTotalPoints);
             
        } catch (error) {
            console.error("Check-in failed: ", error);
            showAppToast('Failed', 'An error occurred. Please try again.', 'error');
        } finally {
            // Refetch data to ensure UI consistency
            const updatedDoc = await userRef.get();
            if(updatedDoc.exists) {
                currentUserData = updatedDoc.data();
                updateUIAfterLogin();
            }
            popupCheckinButton.disabled = false;
        }
    }
    
    async function fetchTaskHistory() {
        if (!connectedWalletAddress || !db) return;

        const historyRef = db.collection('users').doc(connectedWalletAddress).collection('task_history').orderBy('timestamp', 'desc').limit(20);

        try {
            const snapshot = await historyRef.get();
            if (snapshot.empty) {
                taskHistoryContent.innerHTML = `<p class="text-secondary text-center p-3">No activity yet.</p>`;
                return;
            }
            
            let historyHtml = '';
            snapshot.forEach((doc, index) => {
                const item = doc.data();
                const date = item.timestamp ? item.timestamp.toDate().toLocaleString('en-US') : 'N/A';
                
                let iconClass;
                switch (item.taskName) {
                    case 'Daily Check-in': iconClass = 'fa-calendar-check'; break;
                    case 'Invited a friend': iconClass = 'fa-user-group'; break;
                    case 'Entered referral code': iconClass = 'fa-gift'; break;
                    case 'Partner Task': iconClass = 'fa-handshake'; break;
                    default: iconClass = item.exp >= 0 ? 'fa-user-plus' : 'fa-user-minus';
                }

                const expAmount = item.exp;
                const expClass = expAmount >= 0 ? 'amount-in' : 'amount-out';
                const expSign = expAmount > 0 ? '+' : '';
                const expDisplay = `<strong class="${expClass}">${expSign}${expAmount.toLocaleString()} EXP</strong>`;
                const taskTitle = item.taskName === 'Partner Task' ? `${item.taskName}: ${item.projectName}` : item.taskName;

                historyHtml += `
                    <div class="task-history-item" style="animation-delay: ${index * 50}ms">
                        <i class="fas ${iconClass} task-history-icon" style="color: ${expAmount < 0 ? 'var(--color-out)' : 'var(--accent-secondary)'};"></i>
                        <div class="flex-grow-1">
                            <p class="m-0 fw-bold">${taskTitle}</p>
                            <p class="m-0 text-secondary" style="font-size: 0.8rem;">${date}</p>
                        </div>
                        ${expDisplay}
                    </div>
                `;
            });
            taskHistoryContent.innerHTML = historyHtml;
        } catch(error) {
            console.error("Error fetching task history:", error);
            taskHistoryContent.innerHTML = `<p class="text-danger text-center p-3">Error loading history.</p>`;
        }
    }

async function fetchAndRenderLeaderboard() {
    if (!db) initializeFirebase();

    const listContainer = document.getElementById('leaderboard-list');
    const totalParticipantsContainer = document.getElementById('leaderboard-total-users');
    const totalUsersCountSpan = totalParticipantsContainer.querySelector('.total-users-count');
    
    const skeletonItem = `<div class="leaderboard-item"><div class="skeleton-loader leaderboard-rank" style="height: 24px; width: 40px; border-radius: 25px;"></div><img class="skeleton-loader leaderboard-avatar"><div class="flex-grow-1"><div class="skeleton-loader skeleton-line w-50"></div></div><div class="skeleton-loader skeleton-line" style="width: 80px;"></div></div>`;
    listContainer.innerHTML = skeletonItem.repeat(7);
    totalUsersCountSpan.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

    try {
        const [leaderboardSnapshot, metadataDoc] = await Promise.all([
            db.collection('users').orderBy('points', 'desc').limit(50).get(),
            db.collection('admin_settings').doc('metadata').get()
        ]);
        
        if (metadataDoc.exists) {
            totalUsersCountSpan.textContent = (metadataDoc.data().userCount || 0).toLocaleString();
        } else {
            totalUsersCountSpan.textContent = 'N/A';
        }

        listContainer.innerHTML = '';

        if (leaderboardSnapshot.empty) {
            listContainer.innerHTML = `<p class="text-secondary text-center p-3">No one is on the leaderboard yet. Be the first!</p>`;
            return;
        }
        
        let rank = 1;
        leaderboardSnapshot.forEach(doc => {
            const user = doc.data();
            const displayName = user.fullName || (user.username ? `@${user.username}`: shortenAddress(user.address));
            const avatarUrl = user.photoUrl || GENERIC_WALLET_ICON;
            const isCurrentUser = connectedWalletAddress && user.address === connectedWalletAddress;

            let rankDisplay, rankClass = ''; 
            if (rank === 1) { rankClass = 'rank-1'; rankDisplay = `<i class="fas fa-medal rank-icon"></i>`; } 
            else if (rank === 2) { rankClass = 'rank-2'; rankDisplay = `<i class="fas fa-medal rank-icon"></i>`; } 
            else if (rank === 3) { rankClass = 'rank-3'; rankDisplay = `<i class="fas fa-medal rank-icon"></i>`; } 
            else { rankDisplay = `#${rank}`; }

            const item = document.createElement('div');
            item.className = `leaderboard-item ${isCurrentUser ? 'current-user' : ''} ${rankClass}`;
            
            // [NEW] Add Level next to the name
            const levelBadge = `<span class="badge ms-2" style="background-color: var(--accent-primary);">LV ${user.level || 1}</span>`;

            item.innerHTML = `
                <div class="leaderboard-rank">${rankDisplay}</div>
                <img src="${avatarUrl}" class="leaderboard-avatar" onerror="this.src='${GENERIC_WALLET_ICON}'">
                <div class="leaderboard-name text-truncate d-flex align-items-center">
                    <span class="text-truncate">${displayName}</span>
                    ${levelBadge}
                </div>
                <div class="leaderboard-exp">${(user.points || 0).toLocaleString()} EXP</div>
            `;
            
            listContainer.appendChild(item);
            rank++;
        });

    } catch (error) {
        console.error("Error fetching leaderboard:", error);
        listContainer.innerHTML = `<p class="text-danger text-center p-3">Could not load the leaderboard. Please try again later.</p>`;
        totalUsersCountSpan.textContent = 'Error';
    }
}
    
    async function fetchAndRenderAdminUserList(isInitialLoad = true) {
        if (!adminUserListContainer || !db) return;

        adminLoadMoreBtn.disabled = true;
        adminLoadMoreBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading...`;

        if (isInitialLoad) {
            lastVisibleAdminUser = null;
            // [UPDATED] Added Level column header
            adminUserListContainer.innerHTML = `<table class="table table-hover table-sm align-middle" style="font-size: 0.85rem;" id="admin-user-table"><thead><tr><th scope="col">User</th><th scope="col">Wallet Address</th><th scope="col">UID</th><th scope="col">Lượt mời</th><th scope="col">Check-in</th><th scope="col">N.vụ Partner HT</th><th scope="col">N.vụ Bắt buộc</th><th scope="col">Level</th><th scope="col">EXP</th><th scope="col">Account Status</th><th scope="col">Joined</th></tr></thead><tbody></tbody></table>`;
        }
        
        const tableBody = adminUserListContainer.querySelector('tbody');
        if (isInitialLoad) {
            tableBody.innerHTML = ''; 
        }
        
        try {
            const mandatoryTasksSnapshot = await db.collection('partner_tasks').where('taskType', '==', 'mandatory').get();
            const mandatoryTaskIds = new Set(mandatoryTasksSnapshot.docs.map(doc => doc.id));

            const searchQuery = adminUserSearchInput.value.trim();
            let query;

            if (searchQuery) {
                adminLoadMoreBtn.style.display = 'none'; 
                let queries = [];
                if (!isNaN(searchQuery)) {
                    queries.push(db.collection('users').where('telegramId', '==', parseInt(searchQuery, 10)).get());
                } else if (searchQuery.length > 40 && searchQuery.includes(':')) {
                    queries.push(db.collection('users').where('address', '==', searchQuery).get());
                } else {
                    const nameQuery = db.collection('users').orderBy('fullName').startAt(searchQuery).endAt(searchQuery + '\uf8ff').limit(ADMIN_LIST_PER_PAGE).get();
                    queries.push(nameQuery);
                }

                const snapshots = await Promise.all(queries);
                const usersMap = new Map();
                snapshots.forEach(snapshot => {
                    snapshot.forEach(doc => {
                        if (!usersMap.has(doc.id)) {
                            usersMap.set(doc.id, doc);
                        }
                    });
                });
                
                const userDocs = Array.from(usersMap.values());
                 if (userDocs.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="11" class="text-center text-secondary p-3">Không tìm thấy người dùng.</td></tr>`;
                    return;
                }
                renderAdminUserRows(userDocs, tableBody, mandatoryTaskIds);
                
            } else {
                query = db.collection('users').orderBy('createdAt', 'desc').limit(ADMIN_LIST_PER_PAGE);

                if (!isInitialLoad && lastVisibleAdminUser) {
                    query = query.startAfter(lastVisibleAdminUser);
                }

                const snapshot = await query.get();

                if (snapshot.empty && isInitialLoad) {
                    adminUserListContainer.innerHTML = `<p class="text-secondary text-center p-3">No users found.</p>`;
                    adminLoadMoreBtn.style.display = 'none';
                    return;
                }

                lastVisibleAdminUser = snapshot.docs[snapshot.docs.length - 1];
                renderAdminUserRows(snapshot.docs, tableBody, mandatoryTaskIds);

                if (snapshot.docs.length < ADMIN_LIST_PER_PAGE) {
                    adminLoadMoreBtn.style.display = 'none';
                } else {
                    adminLoadMoreBtn.style.display = 'block';
                }
            }

        } catch (error) {
            console.error("Error fetching user list for admin:", error);
            tableBody.innerHTML = `<tr><td colspan="11" class="text-center text-danger p-3">Lỗi khi tải danh sách người dùng.</td></tr>`;
        } finally {
            adminLoadMoreBtn.disabled = false;
            adminLoadMoreBtn.innerHTML = `Tải thêm`;
        }
    }

    async function renderAdminUserRows(docs, tableBody, mandatoryTaskIds) {
         const completedTasksPromises = docs.map(doc => 
            db.collection('users').doc(doc.id).collection('completed_partner_tasks').get()
         );
         const completedTasksSnapshots = await Promise.all(completedTasksPromises);
         
         docs.forEach((doc, index) => {
            const user = doc.data();
            const displayName = user.fullName || (user.username ? `@${user.username}` : 'N/A');
            const avatarUrl = user.photoUrl || GENERIC_WALLET_ICON;
            const joinDate = user.createdAt ? user.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A';
            
            let statusHtml;
            if (user.disabledUntil && user.disabledUntil.toDate() > new Date()) {
                statusHtml = `<span class="badge bg-danger">Disabled</span>`;
            } else {
                statusHtml = `<span class="badge bg-success">Active</span>`;
            }
            
            let mandatoryStatusHtml;
            if (mandatoryTaskIds.size === 0) {
                 mandatoryStatusHtml = `<span class="badge bg-secondary">N/A</span>`;
            } else {
                const completedSnapshot = completedTasksSnapshots[index];
                const completedIds = new Set(completedSnapshot.docs.map(d => d.id));
                let allMandatoryDone = true;
                for (const mid of mandatoryTaskIds) {
                    if (!completedIds.has(mid)) {
                        allMandatoryDone = false;
                        break;
                    }
                }
                if (allMandatoryDone) {
                    mandatoryStatusHtml = `<span class="badge bg-success">Đã xong</span>`;
                } else {
                    mandatoryStatusHtml = `<span class="badge bg-warning text-dark">Chưa xong</span>`;
                }
            }
            
            const row = tableBody.insertRow();
            // [UPDATED] Added Level cell, removed tx/request switches
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${avatarUrl}" class="me-2 flex-shrink-0 table-img-preview" onerror="this.src='${GENERIC_WALLET_ICON}'">
                        <div class="text-truncate" style="min-width: 120px;">
                            <strong class="d-block text-truncate">${displayName}</strong>
                        </div>
                    </div>
                </td>
                <td><code class="copyable-address" data-address="${user.address}" title="Click to copy Raw Address">${shortenAddress(user.address, 6, 6)}</code></td>
                <td>${user.telegramId || 'N/A'}</td>
                <td>${user.referralCount || 0}</td>
                <td>${user.checkinCount || 0}</td>
                <td>${user.partnerTasksCompletedCount || 0}</td>
                <td>${mandatoryStatusHtml}</td>
                <td class="fw-bold">${user.level || 1}</td>
                <td class="fw-bold" style="color: var(--accent-secondary);">${(user.points || 0).toLocaleString()}</td>
                <td>${statusHtml}</td>
                <td>${joinDate}</td>
            `;
        });
    }

    async function handleAdminExpUpdate(e) {
        e.preventDefault();
        if (airdropSettings?.isSnapshotActive) {
            showAppToast('Đã dừng', 'Không thể chỉnh sửa EXP sau khi Snapshot.', 'error');
            return;
        }
        if (!db) { showAppToast('Lỗi', 'Chưa kết nối cơ sở dữ liệu.', 'error'); return; }
        
        const targetType = document.getElementById('admin-target-type').value;
        const targetValue = document.getElementById('admin-target-value').value.trim();
        const actionType = document.getElementById('admin-action-type').value;
        const expAmount = parseInt(document.getElementById('admin-exp-amount').value, 10);
        const taskName = document.getElementById('admin-task-name').value.trim();

        if (!targetValue || !taskName || isNaN(expAmount) || expAmount <= 0) {
            showAppToast('Lỗi', 'Vui lòng điền đầy đủ và chính xác thông tin.', 'error');
            return;
        }
        
        const submitBtn = document.getElementById('admin-submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...`;
        
        let userQuery;
        if (targetType === 'uid') {
            userQuery = db.collection('users').where('telegramId', '==', parseInt(targetValue, 10)).limit(1);
        } else {
            userQuery = db.collection('users').where('address', '==', targetValue).limit(1);
        }

        try {
            const snapshot = await userQuery.get();
            if (snapshot.empty) { throw new Error(`Không tìm thấy người dùng với ${targetType}: ${targetValue}`); }
            
            const userDoc = snapshot.docs[0];
            const userRef = userDoc.ref;
            const finalExpChange = actionType === 'add' ? expAmount : -expAmount;
            
            await db.runTransaction(async (transaction) => {
                const freshUserDoc = await transaction.get(userRef);
                if (!freshUserDoc.exists) throw "User document not found in transaction!";
                
                const userData = freshUserDoc.data();
                const newTotalPoints = (userData.points || 0) + finalExpChange;
                const newLevel = calculateLevel(newTotalPoints);
                const newTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                transaction.update(userRef, { 
                    points: firebase.firestore.FieldValue.increment(finalExpChange),
                    level: newLevel // Update level in transaction
                });
                
                const historyRef = userRef.collection('task_history').doc();
                transaction.set(historyRef, {
                    taskName: taskName,
                    exp: finalExpChange,
                    timestamp: newTimestamp
                });
            });
            
            showAppToast('Thành công', `Đã cập nhật EXP cho người dùng ${userDoc.data().fullName || targetValue}.`, 'success');
            adminExpForm.reset();
            fetchAndRenderAdminUserList(true); 

        } catch (error) {
            console.error("Admin EXP Update Failed: ", error);
            showAppToast('Thất bại', error.message, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class="fas fa-check me-2"></i>Xác nhận`;
        }
    }
    
    async function handleMassAward(e) {
        e.preventDefault();
        if (!db) { showAppToast('Lỗi', 'Chưa kết nối cơ sở dữ liệu.', 'error'); return; }
        if (airdropSettings?.isSnapshotActive) {
            showAppToast('Đã dừng', 'Không thể thưởng EXP sau khi Snapshot.', 'error');
            return;
        }

        const conditionType = document.getElementById('admin-mass-condition-type').value;
        const operator = document.getElementById('admin-mass-operator').value;
        const conditionValue = parseInt(document.getElementById('admin-mass-condition-value').value, 10);
        const expAmount = parseInt(document.getElementById('admin-mass-exp-amount').value, 10);
        const taskName = document.getElementById('admin-mass-task-name').value.trim();

        if (!taskName || isNaN(expAmount) || expAmount <= 0) {
            showAppToast('Lỗi', 'Vui lòng nhập số EXP và lý do thưởng hợp lệ.', 'error');
            return;
        }

        if (conditionType !== 'all' && isNaN(conditionValue)) {
            showAppToast('Lỗi', 'Vui lòng nhập giá trị điều kiện hợp lệ.', 'error');
            return;
        }
        
        const confirmationMessage = `Bạn có chắc chắn muốn cộng ${expAmount} EXP với lý do "${taskName}" cho tất cả người dùng thỏa mãn điều kiện không? Hành động này KHÔNG THỂ hoàn tác.`;
        if (!confirm(confirmationMessage)) {
            return;
        }

        adminMassAwardSubmitBtn.disabled = true;
        adminMassAwardStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Bắt đầu quá trình thưởng...`;

        try {
            let query = db.collection('users');
            if (conditionType !== 'all') {
                query = query.where(conditionType, operator, conditionValue);
            }

            let lastVisible = null;
            let totalProcessed = 0;
            
            while (true) {
                let batchQuery;
                if (conditionType !== 'all') {
                    // Firestore requires the first orderBy to be on the same field as the where filter
                    batchQuery = query.orderBy(conditionType).orderBy(firebase.firestore.FieldPath.documentId()).limit(BATCH_SIZE);
                } else {
                    batchQuery = query.orderBy(firebase.firestore.FieldPath.documentId()).limit(BATCH_SIZE);
                }
                
                if (lastVisible) {
                    batchQuery = batchQuery.startAfter(lastVisible);
                }
                
                const snapshot = await batchQuery.get();
                if (snapshot.empty) {
                    break; 
                }
                
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                const writeBatch = db.batch();
                const newTimestamp = firebase.firestore.FieldValue.serverTimestamp();

                snapshot.forEach(doc => {
                    const userRef = doc.ref;
                    const userData = doc.data();
                    const newTotalPoints = (userData.points || 0) + expAmount;
                    const newLevel = calculateLevel(newTotalPoints);

                    writeBatch.update(userRef, { 
                        points: firebase.firestore.FieldValue.increment(expAmount),
                        level: newLevel
                    });

                    const historyRef = userRef.collection('task_history').doc();
                    writeBatch.set(historyRef, {
                        taskName: taskName,
                        exp: expAmount,
                        timestamp: newTimestamp
                    });
                });

                await writeBatch.commit();
                totalProcessed += snapshot.size;
                adminMassAwardStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đã xử lý ${totalProcessed} người dùng...`;
            }
            
            adminMassAwardStatus.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Hoàn tất! Đã thưởng cho ${totalProcessed} người dùng.</span>`;
            showAppToast('Thành Công', `Đã hoàn tất việc thưởng EXP hàng loạt.`, 'success');
            adminMassAwardForm.reset();
            adminMassConditionWrapper.style.display = 'none';

        } catch (error) {
            console.error("Mass EXP award failed:", error);
            adminMassAwardStatus.innerHTML = `<span class="text-danger">Đã xảy ra lỗi: ${error.message}</span>`;
            showAppToast('Thất bại', `Quá trình thưởng hàng loạt đã thất bại.`, 'error');
        } finally {
            adminMassAwardSubmitBtn.disabled = false;
            setTimeout(() => { adminMassAwardStatus.innerHTML = ''; }, 5000);
        }
    }
    
    async function updateUserStatus(enable) {
        if (!db) { showAppToast('Lỗi', 'Chưa kết nối cơ sở dữ liệu.', 'error'); return; }

        const targetType = document.getElementById('admin-disable-target-type').value;
        const targetValue = document.getElementById('admin-disable-target-value').value.trim();
        const durationDaysInput = document.getElementById('admin-disable-duration');
        const durationDays = parseInt(durationDaysInput.value, 10);

        if (!targetValue) {
            showAppToast('Lỗi', 'Vui lòng nhập giá trị định danh người dùng.', 'error');
            return;
        }
        if (!enable && (isNaN(durationDays) || durationDays <= 0)) {
            showAppToast('Lỗi', 'Vui lòng nhập số ngày vô hiệu hoá hợp lệ.', 'error');
            return;
        }

        adminDisableBtn.disabled = true;
        adminEnableBtn.disabled = true;

        let userQuery;
        if (targetType === 'uid') {
            userQuery = db.collection('users').where('telegramId', '==', parseInt(targetValue, 10)).limit(1);
        } else {
            userQuery = db.collection('users').where('address', '==', targetValue).limit(1);
        }
        
        try {
            const snapshot = await userQuery.get();
            if (snapshot.empty) { throw new Error(`Không tìm thấy người dùng với ${targetType}: ${targetValue}`); }
            
            const userDoc = snapshot.docs[0];
            const userRef = userDoc.ref;
            
            let updateData;
            let successMessage;
            
            if (enable) {
                updateData = { disabledUntil: null };
                successMessage = `Đã mở khoá tài khoản ${userDoc.data().fullName || targetValue}.`;
            } else {
                const banEndMillis = Date.now() + (durationDays * 24 * 60 * 60 * 1000);
                const banEndTimestamp = firebase.firestore.Timestamp.fromMillis(banEndMillis);
                updateData = { disabledUntil: banEndTimestamp };
                successMessage = `Đã vô hiệu hoá tài khoản ${userDoc.data().fullName || targetValue} trong ${durationDays} ngày.`;
            }
            
            await userRef.update(updateData);
            showAppToast('Thành công', successMessage, 'success');
            adminDisableForm.reset();
            fetchAndRenderAdminUserList(true);

        } catch (error) {
            console.error("Admin user status update failed:", error);
            showAppToast('Thất bại', error.message, 'error');
        } finally {
            adminDisableBtn.disabled = false;
            adminEnableBtn.disabled = false;
        }
    }
    
    async function handleNotificationToggle(e) {
        if (!currentUserData || !db) return;

        const toggle = e.target;
        const newStatus = toggle.checked;
        toggle.disabled = true;

        try {
            const userRef = db.collection('users').doc(currentUserData.address);
            await userRef.update({ notificationsEnabled: newStatus });
            currentUserData.notificationsEnabled = newStatus;
            showAppToast('Settings Saved', `Notifications have been ${newStatus ? 'enabled' : 'disabled'}.`, 'success');
        } catch (error) {
            console.error('Failed to update notification settings:', error);
            showAppToast('Error', 'Could not save your setting. Please try again.', 'error');
            toggle.checked = !newStatus;
        } finally {
            toggle.disabled = false;
        }
    }
    
    async function sendBulkTelegramMessage(customMessageGenerator = null) {
        const delay = ms => new Promise(res => setTimeout(res, ms));
        const apiTokenInput = document.getElementById('telegram-api-token-input');
        const statusEl = customMessageGenerator ? adminClaimSettingsStatusEl : telegramSenderStatus;

        const apiToken = apiTokenInput.value.trim();
        if (!apiToken) { 
            showAppToast('Lỗi', 'Vui lòng nhập API Token của bot tại tab Messenger.', 'error');
            if (customMessageGenerator) { // If called from claim management, provide status
                 statusEl.innerHTML = `<span class="text-danger">Vui lòng nhập API Token trước.</span>`;
            }
            return;
        }
        
        let targetUsersQuery;
        let confirmationMessage;
        
        if (customMessageGenerator) {
             // Logic for sending claim notifications
            targetUsersQuery = db.collection('airdrop_claims');
            confirmationMessage = `Bạn có chắc chắn muốn gửi thông báo "đã nhận airdrop" tới tất cả người dùng đã claim không?`;

        } else {
            // Logic for general bulk messages
            targetUsersQuery = db.collection('users').where('notificationsEnabled', '!=', false);
            confirmationMessage = `CẢNH BÁO: Bạn sắp gửi tin nhắn này cho tất cả người dùng đã bật thông báo. Hành động này KHÔNG THỂ hoàn tác. Bạn có chắc chắn muốn tiếp tục?`;
        }

        if (!confirm(confirmationMessage)) {
            return;
        }

        if (!customMessageGenerator) sendBulkTelegramMessageBtn.disabled = true;
        statusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang lấy danh sách người dùng...`;

        try {
            const usersWithUid = new Map();
            let lastVisible = null;
            while (true) {
                let query = targetUsersQuery.orderBy(firebase.firestore.FieldPath.documentId()).limit(FIRESTORE_FETCH_BATCH_SIZE);
                if (lastVisible) {
                    query = query.startAfter(lastVisible);
                }
                const snapshot = await query.get();
                if (snapshot.empty) break;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId && !usersWithUid.has(data.userId)) {
                        usersWithUid.set(data.userId, data);
                    } else if (data.telegramId && !usersWithUid.has(data.telegramId)) {
                        usersWithUid.set(data.telegramId, data);
                    }
                });
                lastVisible = snapshot.docs[snapshot.docs.length - 1];
                statusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đã lấy được ${usersWithUid.size} người dùng...`;
            }

            const usersToNotify = Array.from(usersWithUid.values());
            const totalToNotify = usersToNotify.length;

            if (totalToNotify === 0) {
                statusEl.innerHTML = `<span class="text-warning">Không có người dùng nào để thông báo.</span>`;
                return;
            }
            
            let sentCount = 0;
            let failedCount = 0;
            const baseUrl = `https://api.telegram.org/bot${apiToken}/`;
            
            for (let i = 0; i < totalToNotify; i++) {
                const user = usersToNotify[i];
                statusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi tin ${i + 1}/${totalToNotify}...`;

                let body, method;
                if (customMessageGenerator) {
                    ({ body, method } = customMessageGenerator(user));
                } else {
                     const text = document.getElementById('telegram-message-text-input').value.trim();
                    const imageUrl = document.getElementById('telegram-image-url-input').value.trim();
                    const buttonText = document.getElementById('telegram-button-text-input').value.trim();
                    const buttonUrl = document.getElementById('telegram-button-url-input').value.trim();
                     body = {};
                     if (buttonText && buttonUrl) {
                        body.reply_markup = JSON.stringify({
                            inline_keyboard: [[{ text: buttonText, url: buttonUrl }]]
                        });
                    }
                    if (imageUrl) {
                        method = 'sendPhoto';
                        body.photo = imageUrl;
                        if (text) body.caption = text;
                    } else {
                        method = 'sendMessage';
                        body.text = text;
                    }
                }
                
                body.chat_id = user.userId || user.telegramId;
                
                try {
                    const response = await fetch(baseUrl + method, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                    });
                    const result = await response.json();
                    if (result.ok) {
                        sentCount++;
                    } else {
                        failedCount++;
                        console.error(`Failed to send to UID ${body.chat_id}: ${result.description}`);
                    }
                } catch (error) {
                    failedCount++;
                    console.error(`Network error sending to UID ${body.chat_id}:`, error);
                }

                await delay(TELEGRAM_SEND_DELAY_MS);
            }

            statusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Hoàn tất! Đã gửi: ${sentCount}. Thất bại: ${failedCount}.</span>`;
            showAppToast('Hoàn tất gửi hàng loạt', `Thành công: ${sentCount}, Thất bại: ${failedCount}`, 'success');

        } catch (error) {
            console.error("Telegram bulk sender error:", error);
            statusEl.innerHTML = `<span class="text-danger">Gửi hàng loạt thất bại: ${error.message}</span>`;
            showAppToast('Thất bại', error.message, 'error');
        } finally {
            if (!customMessageGenerator) sendBulkTelegramMessageBtn.disabled = false;
            setTimeout(() => { statusEl.innerHTML = ''; }, 10000);
        }
    }

    function handleFullLogout(e) {
        if (e) e.preventDefault();
        console.log("Logging out completely...");
        
        localStorage.removeItem(USER_SESSION_KEY);
        sessionStorage.removeItem(REFERRAL_SESSION_KEY);

        if (tonConnectUI.connected) {
            tonConnectUI.disconnect();
        } else {
            window.location.reload();
        }
    }

    function handleDisconnectWallet(e) {
        if (e) e.preventDefault();
        if (tonConnectUI.connected) {
            tonConnectUI.disconnect();
        }
        walletDropdown.style.display = 'none';
    }
    
    function renderAccountSection() {
        const profilePhoto = document.getElementById('profile-photo');
        const profileFullname = document.getElementById('profile-fullname');
        const profileUsername = document.getElementById('profile-username');
        const profileDetails = document.getElementById('profile-details');
    
        if (!currentUserData) return;
    
        const displayName = currentUserData.fullName || currentUserData.temporaryFullName || 'Anonymous User';
        const displayPhoto = currentUserData.photoUrl || currentUserData.temporaryPhotoUrl || DEFAULT_LOGO_SRC;
        const displayUsername = currentUserData.username ? `@${currentUserData.username}` : (currentUserData.isTemporaryProfile ? 'Web User' : 'No username');
    
        profilePhoto.src = displayPhoto;
        profileFullname.textContent = displayName;
        profileUsername.textContent = displayUsername;
    
        const emailDisplay = currentUserData.email
            ? `<span>${currentUserData.email}</span>`
            : `<span class="text-secondary">Not set</span>`;
    
        profileDetails.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="metadata-key">Address:</span>
                <span class="copyable-address" data-address="${currentUserData.address}" title="Click to copy">${shortenAddress(currentUserData.address)}</span>
            </div>
            ${currentUserData.telegramId ? `
            <div class="d-flex justify-content-between mb-2">
                <span class="metadata-key">Telegram ID:</span>
                <span>${currentUserData.telegramId}</span>
            </div>` : ''}
            <hr style="border-color: var(--border-color); opacity: 0.5; margin: 1rem 0;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-envelope fa-fw me-2 metadata-key"></i>
                    <span class="metadata-key">Email</span>
                </div>
                <div>
                    ${emailDisplay}
                    <button id="edit-email-btn" class="btn btn-sm btn-link p-0 ms-2"><i class="fas fa-pencil-alt"></i></button>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bell fa-fw me-2 metadata-key"></i>
                    <span class="metadata-key">Notifications</span>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="notifications-toggle" style="width: 3.5em; height: 1.75em; cursor: pointer;" ${!currentUserData.telegramId ? 'disabled' : ''}>
                </div>
            </div>
        `;
        
        const notificationsToggle = document.getElementById('notifications-toggle');
        if (notificationsToggle) {
            notificationsToggle.checked = currentUserData.notificationsEnabled !== false;
        }
    
        document.getElementById('edit-email-btn').addEventListener('click', () => {
            document.getElementById('email-input').value = currentUserData.email || '';
            emailUpdateModal.show();
        });

        // [NEW] Update level UI when rendering account section
        updateLevelUI(currentUserData.level, currentUserData.points);
    }

    // [NEW] Function to update all Level-related UI elements
    function updateLevelUI(level, exp) {
        if (!accountSectionEl.style.display === 'none') return; // Only update if visible
        
        const currentLevel = level || 1;
        const currentExp = exp || 0;
        
        const levelInfo = levelConfig.find(l => l.level === currentLevel) || levelConfig[0];
        const nextLevelInfo = (currentLevel < levelConfig.length) ? levelConfig.find(l => l.level === currentLevel + 1) : null;

        // Update Avatar Shield
        const shield = document.getElementById('profile-avatar-shield');
        if (shield) {
            shield.className = 'avatar-shield'; // Reset classes
            shield.classList.add(levelInfo.shieldClass || 'level-shield-1');
        }

        // Update Progress Bar and Text
        const currentLevelDisplay = document.getElementById('current-level-display');
        const nextLevelDisplay = document.getElementById('next-level-display');
        const progressBar = document.getElementById('level-progress-bar');
        const expDisplay = document.getElementById('level-exp-display');
        const perkContainer = document.getElementById('next-level-perk-container');
        const perkText = document.getElementById('next-level-perk');

        currentLevelDisplay.textContent = `LV ${currentLevel}`;

        if (nextLevelInfo) {
            // Not max level
            const expForNextLevel = nextLevelInfo.expRequired - levelInfo.expRequired;
            const expProgress = currentExp - levelInfo.expRequired;
            const progressPercentage = (expForNextLevel > 0) ? Math.min((expProgress / expForNextLevel) * 100, 100) : 100;

            nextLevelDisplay.textContent = `LV ${nextLevelInfo.level}`;
            progressBar.style.width = `${progressPercentage}%`;
            expDisplay.textContent = `${expProgress.toLocaleString()} / ${expForNextLevel.toLocaleString()} EXP`;
            perkText.textContent = nextLevelInfo.benefit;
            perkContainer.style.display = 'block';

        } else {
            // Max level
            nextLevelDisplay.textContent = 'MAX';
            progressBar.style.width = '100%';
            expDisplay.textContent = 'You have reached the maximum level!';
            perkContainer.style.display = 'none';
        }
    }
    
    async function handleEmailUpdate() {
        if (!currentUserData || !db) return;
    
        const emailInput = document.getElementById('email-input');
        const newEmail = emailInput.value.trim();
        const statusEl = document.getElementById('email-update-status');
    
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (newEmail && !emailRegex.test(newEmail)) {
            statusEl.innerHTML = `<span class="text-danger">Invalid email format.</span>`;
            return;
        }
    
        saveEmailBtn.disabled = true;
        statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    
        try {
            const userRef = db.collection('users').doc(currentUserData.address);
            await userRef.update({ email: newEmail || null }); 
            currentUserData.email = newEmail || null;
            showAppToast('Success', 'Email updated successfully.', 'success');
            emailUpdateModal.hide();
            renderAccountSection(); 
        } catch (error) {
            console.error('Failed to update email:', error);
            statusEl.innerHTML = `<span class="text-danger">Failed to save. Please try again.</span>`;
            showAppToast('Error', 'Could not update your email.', 'error');
        } finally {
            saveEmailBtn.disabled = false;
        }
    }
    
    async function handleTempProfileSave() {
        if (!currentUserData || !storage) return;
    
        const nameInput = document.getElementById('temp-fullname-input');
        const avatarFile = document.getElementById('temp-avatar-upload').files[0];
        const statusEl = document.getElementById('profile-setup-status');
    
        const newName = nameInput.value.trim();
        if (!newName) {
            statusEl.innerHTML = `<span class="text-danger">Display name is required.</span>`;
            return;
        }
    
        saveTempProfileBtn.disabled = true;
        statusEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
    
        try {
            const updates = { temporaryFullName: newName };
    
            if (avatarFile) {
                const storageRef = storage.ref(`temp_avatars/${currentUserData.address}/${Date.now()}_${avatarFile.name}`);
                const uploadTask = await storageRef.put(avatarFile);
                updates.temporaryPhotoUrl = await uploadTask.ref.getDownloadURL();
            }
    
            const userRef = db.collection('users').doc(currentUserData.address);
            await userRef.update(updates);
    
            currentUserData = { ...currentUserData, ...updates };
            profileSetupModal.hide();
            
            showAppToast('Profile Set!', 'Welcome to Bmass!', 'success');
            const referrerCode = sessionStorage.getItem(REFERRAL_SESSION_KEY);
            if (referrerCode) {
                await applyReferral(referrerCode, currentUserData.address);
                // Re-fetch user data after referral to get updated points
                const doc = await userRef.get();
                currentUserData = doc.data();
            }
            await onUserAuthenticated();
    
        } catch (error) {
            console.error("Failed to save temporary profile:", error);
            statusEl.innerHTML = `<span class="text-danger">Save failed. Please try again.</span>`;
            showAppToast('Error', 'Could not save your profile.', 'error');
        } finally {
            saveTempProfileBtn.disabled = false;
        }
    }

    
    async function fetchAndRenderInvitedUsers() {
        const invitedListPane = document.getElementById('invited-list-pane');
        if (!currentUserData || !db || !invitedListPane) return;

        invitedListPane.innerHTML = skeletonTx.repeat(3);
        
        try {
            const queryByAddress = db.collection('users').where('referredBy', '==', currentUserData.address);
            const queryByUID = currentUserData.telegramId ? db.collection('users').where('referredBy', '==', String(currentUserData.telegramId)) : null;

            const [addressSnapshot, uidSnapshot] = await Promise.all([
                queryByAddress.get(),
                queryByUID ? queryByUID.get() : Promise.resolve({ docs: [] })
            ]);
            
            const invitedUsers = new Map();
            addressSnapshot.forEach(doc => invitedUsers.set(doc.id, doc.data()));
            uidSnapshot.forEach(doc => invitedUsers.set(doc.id, doc.data()));

            if (invitedUsers.size === 0) {
                invitedListPane.innerHTML = `<p class="text-secondary text-center p-3">You haven't invited anyone yet.</p>`;
                return;
            }

            let listHtml = '';
            invitedUsers.forEach(user => {
                const displayName = user.fullName || (user.username ? `@${user.username}` : shortenAddress(user.address));
                const avatarUrl = user.photoUrl || GENERIC_WALLET_ICON;
                const joinDate = user.createdAt ? user.createdAt.toDate().toLocaleDateString('en-US') : 'N/A';
                listHtml += `
                    <div class="d-flex align-items-center p-2 mb-2" style="background: rgba(0,0,0,0.2); border-radius: 25px;">
                        <img src="${avatarUrl}" class="me-3" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;" onerror="this.src='${GENERIC_WALLET_ICON}'">
                        <div class="flex-grow-1">
                            <p class="m-0 fw-bold">${displayName}</p>
                            <p class="m-0 text-secondary" style="font-size: 0.8rem;">Joined on: ${joinDate}</p>
                        </div>
                    </div>
                `;
            });
            invitedListPane.innerHTML = listHtml;
            
        } catch(error) {
            console.error("Error fetching invited users:", error);
            invitedListPane.innerHTML = `<p class="text-danger text-center p-3">Error loading invited users list.</p>`;
        }
    }
    
async function renderReferralSection() {
    if (!currentUserData) return;
    const linksContainer = document.getElementById('referral-links-container');
    const codesContainer = document.getElementById('referral-codes-container');
    const referralCountEl = document.getElementById('referral-count');
    const referredByContainer = document.getElementById('referred-by-container');
    const referralInputContainer = document.getElementById('referral-input-container');
    
    linksContainer.innerHTML = '';
    codesContainer.innerHTML = '';

    const webLink = `${YOUR_WEB_APP_URL}?ref=${currentUserData.address}`;
    linksContainer.innerHTML = `
        <h6 class="mb-2"><i class="fas fa-link me-2"></i>Your Referral Link</h6>
        <div class="mb-3">
            <label class="form-label small text-secondary">Web Referral Link:</label>
            <div class="input-group">
                <input type="text" class="form-control" value="${webLink}" readonly>
                <button class="btn btn-outline-secondary copyable-code" data-code="${webLink}" title="Copy Link"><i class="fas fa-copy"></i></button>
            </div>
        </div>`;
    codesContainer.innerHTML = `
        <h6 class="mb-2"><i class="fas fa-barcode me-2"></i>Your Referral Code</h6>
         <div class="mb-2">
            <label class="form-label small text-secondary">Referral Code (Wallet Address):</label>
            <div class="input-group">
                <input type="text" class="form-control" value="${currentUserData.address}" readonly>
                <button class="btn btn-outline-secondary copyable-code" data-code="${currentUserData.address}" title="Copy Code"><i class="fas fa-copy"></i></button>
            </div>
        </div>`;
    
    if (currentUserData.telegramId) {
        const miniAppLink = `https://t.me/${YOUR_TELEGRAM_BOT_NAME}/${YOUR_MINI_APP_NAME}?startapp=${currentUserData.telegramId}`;
         linksContainer.innerHTML += `
            <div class="mb-2">
                <label class="form-label small text-secondary">Mini App Referral Link:</label>
                <div class="input-group">
                    <input type="text" class="form-control" value="${miniAppLink}" readonly>
                    <button class="btn btn-outline-secondary copyable-code" data-code="${miniAppLink}" title="Copy Link"><i class="fas fa-copy"></i></button>
                </div>
            </div>`;
        codesContainer.innerHTML += `
            <div class="mb-2">
                <label class="form-label small text-secondary">Referral Code (UID):</label>
                <div class="input-group">
                    <input type="text" class="form-control" value="${currentUserData.telegramId}" readonly>
                    <button class="btn btn-outline-secondary copyable-code" data-code="${currentUserData.telegramId}" title="Copy Code"><i class="fas fa-copy"></i></button>
                </div>
            </div>`;
    }
    
    if (currentUserData.referredBy) {
        referralInputContainer.style.display = 'none';
        referredByContainer.style.display = 'block';
        referredByContainer.innerHTML = `<div class="skeleton-loader skeleton-line w-75"></div>`;
        
        const referrerCode = currentUserData.referredBy;
        let referrerQuery;
        if (!isNaN(referrerCode)) {
            referrerQuery = db.collection('users').where('telegramId', '==', parseInt(referrerCode, 10));
        } else {
            referrerQuery = db.collection('users').where('address', '==', referrerCode);
        }
        
        try {
            const snapshot = await referrerQuery.get();
            let referrerName = shortenAddress(referrerCode);
            if (!snapshot.empty) {
                const referrerData = snapshot.docs[0].data();
                referrerName = referrerData.fullName || (referrerData.username ? `@${referrerData.username}` : shortenAddress(referrerData.address));
            }
            referredByContainer.innerHTML = `
                <hr style="border-color: var(--border-color); opacity: 0.5;">
                <h6 class="mb-2 text-secondary"><i class="fas fa-user-check me-2"></i>Your Referrer</h6>
                <div class="d-flex align-items-center p-2" style="background: rgba(43, 203, 196, 0.1); border-radius: 25px;">
                    <i class="fas fa-award me-3" style="color: var(--accent-secondary); font-size: 1.5rem;"></i>
                    <p class="m-0">You were referred by <strong style="color: var(--accent-secondary);">${referrerName}</strong>.</p>
                </div>`;
        } catch (error) {
            console.error("Could not fetch referrer's name", error);
            referredByContainer.innerHTML = '';
        }

    } else {
        referredByContainer.style.display = 'none';
        if (!airdropSettings?.isSnapshotActive) {
            referralInputContainer.style.display = 'block';
        }
    }
    
    referralCountEl.textContent = `${currentUserData.referralCount || 0}`;

    fetchAndRenderInvitedUsers();
    renderReferralMilestones(); 
}




function renderReferralMilestones() {
    const container = document.getElementById('referral-milestones-list-container');
    if (!container) return; 

    const baseExpDisplay = document.getElementById('referral-base-exp-display');
    if (baseExpDisplay) {
        baseExpDisplay.textContent = `${(rewardConfig.baseReferralExp || 5000).toLocaleString()} EXP`;
    }

    if (!rewardConfig.referralMilestones || rewardConfig.referralMilestones.length === 0) {
        container.innerHTML = `<p class="text-secondary text-center">No milestones available right now.</p>`;
        return;
    }

    let html = '';
    const userReferralCount = currentUserData?.referralCount || 0;

    rewardConfig.referralMilestones.forEach(milestone => {
        const isCompleted = userReferralCount >= milestone.required;

        html += `
        <div class="d-flex align-items-center justify-content-between p-3 mb-2" 
             style="background: rgba(145, 94, 255, 0.05); border-radius: 12px; border-left: 4px solid ${isCompleted ? 'var(--color-verified)' : 'var(--accent-primary)'}; opacity: ${isCompleted ? '0.7' : '1'};">
            
            <div class="d-flex align-items-center">
                <i class="fas ${isCompleted ? 'fa-check-circle' : 'fa-users'} fa-fw me-3 fs-4" style="color: ${isCompleted ? 'var(--color-verified)' : 'var(--accent-primary)'};"></i>
                <div>
                    <h6 class="mb-0">Invite ${milestone.required} Friends</h6>
                    <small class="text-secondary">${isCompleted ? 'Completed' : `Your progress: ${userReferralCount} / ${milestone.required}`}</small>
                </div>
            </div>

            <div class="text-end">
                <strong class="d-block" style="color: var(--gold);">+${(milestone.bonus).toLocaleString()} EXP</strong>
                <small class="text-secondary">Bonus Reward</small>
            </div>
        </div>
        `;
    });

    container.innerHTML = html;
}

    // [UPDATED] Function to fetch settings for BOTH scoring and claiming
    async function fetchAirdropSettings() {
        if (airdropSettings) return airdropSettings;
        try {
            const docRef = db.collection('admin_settings').doc('airdrop_criteria');
            const doc = await docRef.get();
            if (doc.exists) { 
                airdropSettings = doc.data(); 
            } else {
                // Default settings if none are found
                airdropSettings = { 
                    isAirdropLive: false,
                    isSnapshotActive: false,
                    minCheckins: 0, minReferrals: 0, minExp: 0,
                    refMultiplier: 50, checkinMultiplier: 30, expMultiplier: 1,
                    levelMultipliers: [],
                    onchainClaimEnabled: false,
                    offchainClaimEnabled: false,
                    allowClaimInfoEdit: true,
                    notifyAirdropSent: false,
                    enabledExchanges: []
                };
            }
            return airdropSettings;
        } catch (error) {
            console.error("Error fetching airdrop settings:", error);
            return null; // Return null on error
        }
    }
    
    // [RESTRUCTURED] Main function to render the airdrop section
    async function renderAirdropSection() {
        const airdropWrapper = document.getElementById('airdrop-content-wrapper');
        const comingSoonEl = document.getElementById('airdrop-coming-soon');
        const loadingEl = document.getElementById('airdrop-content-loading');
        const loggedInContent = document.getElementById('airdrop-content-logged-in');
        const loggedOutContent = document.getElementById('airdrop-content-logged-out');

        loadingEl.style.display = 'block';
        [loggedInContent, loggedOutContent, airdropWrapper, comingSoonEl].forEach(el => el.style.display = 'none');

        const settings = await fetchAirdropSettings();
        if (!settings) {
            loadingEl.style.display = 'none';
            airdropWrapper.style.display = 'block';
            loggedInContent.style.display = 'block';
            document.getElementById('airdrop-claim-container').innerHTML = `<p class="text-danger text-center">Could not load Airdrop settings. Please try again later.</p>`;
            return;
        }

        if (!settings.isAirdropLive) {
            loadingEl.style.display = 'none';
            comingSoonEl.style.display = 'block';
            return;
        }
        
        airdropWrapper.style.display = 'block';

        if (!currentUserData) {
            loadingEl.style.display = 'none';
            loggedOutContent.style.display = 'block';
            return;
        }
        
        // Fetch user's existing claim data
        const claimDoc = await db.collection('airdrop_claims').doc(currentUserData.address).get();
        userAirdropClaimData = claimDoc.exists ? claimDoc.data() : null;

        const mandatoryTasksCompleted = await checkMandatoryTasksCompletion(currentUserData.address);
        
        const isEligibleByStats = (currentUserData.referralCount || 0) >= settings.minReferrals &&
                           (currentUserData.checkinCount || 0) >= settings.minCheckins &&
                           (currentUserData.points || 0) >= settings.minExp;
        
        const isFullyEligible = isEligibleByStats && mandatoryTasksCompleted;
        const finalReward = isFullyEligible ? await calculateBmassReward(currentUserData, settings) : 0;

        document.getElementById('airdrop-ref-count').textContent = (currentUserData.referralCount || 0).toLocaleString();
        document.getElementById('airdrop-checkin-count').textContent = (currentUserData.checkinCount || 0).toLocaleString();
        document.getElementById('airdrop-exp-count').textContent = (currentUserData.points || 0).toLocaleString();
        document.getElementById('airdrop-level-display').textContent = (currentUserData.level || 1);
        document.getElementById('airdrop-reward-value').textContent = finalReward.toLocaleString();

        const eligibilityStatusEl = document.getElementById('airdrop-eligibility-status');
        const claimContainer = document.getElementById('airdrop-claim-container');
        claimContainer.innerHTML = ''; // Clear previous content
        
        if (!isEligibleByStats) {
            eligibilityStatusEl.textContent = 'YOU ARE NOT ELIGIBLE';
            eligibilityStatusEl.className = 'fw-bold mt-2 mb-0 fs-5 ineligible';
            claimContainer.innerHTML = `<p class="text-white-50 mt-3">Continue completing tasks to become eligible.</p>`;
        } else if (!mandatoryTasksCompleted) {
            eligibilityStatusEl.textContent = 'YOU ARE NOT ELIGIBLE';
            eligibilityStatusEl.className = 'fw-bold mt-2 mb-0 fs-5 ineligible';
            claimContainer.innerHTML = `<p class="text-warning mt-3">You need to complete all <a href="#partner" style="color: var(--gold); font-weight: bold;">mandatory partner tasks</a> to claim rewards.</p>`;
        } else if (settings.notifyAirdropSent && userAirdropClaimData) {
            eligibilityStatusEl.textContent = 'AIRDROP SENT';
            eligibilityStatusEl.className = 'fw-bold mt-2 mb-0 fs-5 eligible';
            claimContainer.innerHTML = `<p class="text-white mt-3">Your $BMASS tokens have been sent to the address you provided. Thank you for participating!</p>`;
        } else {
             eligibilityStatusEl.textContent = `YOU ARE ELIGIBLE`;
             eligibilityStatusEl.className = 'fw-bold mt-2 mb-0 fs-5 eligible';
             renderClaimUI(claimContainer, settings, finalReward);
        }
        
        loadingEl.style.display = 'none';
        loggedInContent.style.display = 'block';
    }

    // [NEW] Renders the core UI for claiming
    function renderClaimUI(container, settings, rewardAmount) {
        if (!settings.isSnapshotActive) {
            container.innerHTML = `<p class="text-white-50 mt-3 fst-italic">The claim process will begin after the snapshot. Stay tuned!</p>`;
            return;
        }

        // User has already submitted their claim info
        if (userAirdropClaimData) {
            let detailsHtml = '';
            if (userAirdropClaimData.method === 'onchain') {
                detailsHtml = `
                    <p class="m-0"><strong>Method:</strong> On-chain</p>
                    <p class="m-0"><strong>Your Wallet:</strong> <code class="copyable-address" data-address="${userAirdropClaimData.claimAddress}">${shortenAddress(userAirdropClaimData.claimAddress)}</code></p>
                `;
            } else { // offchain
                 detailsHtml = `
                    <p class="m-0"><strong>Method:</strong> Off-chain</p>
                    <p class="m-0"><strong>Exchange:</strong> ${userAirdropClaimData.exchange}</p>
                    <p class="m-0"><strong>Address:</strong> <code>${shortenAddress(userAirdropClaimData.claimAddress, 10, 10)}</code></p>
                    ${userAirdropClaimData.memo ? `<p class="m-0"><strong>Memo:</strong> <code>${userAirdropClaimData.memo}</code></p>` : ''}
                `;
            }

            container.innerHTML = `
                <div class="card-glass p-3 mt-3" style="background: rgba(43, 203, 196, 0.1);">
                    <h6 class="text-secondary"><i class="fas fa-check-circle me-2 text-success"></i>Claim Information Submitted</h6>
                    ${detailsHtml}
                </div>
                ${settings.allowClaimInfoEdit ? '<button id="edit-claim-info-btn" class="btn btn-sm btn-outline-light mt-3">Edit Information</button>' : '<p class="text-secondary small mt-3">Editing is no longer possible.</p>'}
            `;

             if (settings.allowClaimInfoEdit) {
                document.getElementById('edit-claim-info-btn').addEventListener('click', () => {
                    userAirdropClaimData = null; // Reset to allow re-rendering of claim options
                    renderClaimUI(container, settings, rewardAmount);
                });
            }
            return;
        }
        
        // User has NOT submitted claim info yet, show options
        let html = '<p class="text-white mt-3">Please select your preferred method to receive the airdrop:</p>';
        
        if (settings.onchainClaimEnabled) {
            html += `<button id="claim-onchain-btn" class="airdrop-claim-btn claim-btn-onchain"><i class="fas fa-wallet me-2"></i>Claim On-chain (Costs ${ONCHAIN_CLAIM_FEE_TON} TON gas)</button>`;
        }

        if (settings.offchainClaimEnabled) {
            html += `<button id="claim-offchain-btn" class="airdrop-claim-btn claim-btn-offchain mt-2"><i class="fas fa-building-columns me-2"></i>Claim via Exchange (Off-chain)</button>`;
        }

        html += `<div id="offchain-claim-details" class="mt-4" style="display: none;"></div>`;

        container.innerHTML = html;

        if (settings.onchainClaimEnabled) {
            document.getElementById('claim-onchain-btn').addEventListener('click', () => handleOnchainClaim(rewardAmount));
        }

        if (settings.offchainClaimEnabled) {
            document.getElementById('claim-offchain-btn').addEventListener('click', () => renderOffchainForm(settings.enabledExchanges, rewardAmount));
        }
    }

    // [NEW] Renders the Off-chain specific form
    function renderOffchainForm(enabledExchanges, rewardAmount) {
        const offchainContainer = document.getElementById('offchain-claim-details');
        if (!offchainContainer) return;

        document.getElementById('claim-onchain-btn')?.remove();
        document.getElementById('claim-offchain-btn')?.remove();

        const availableExchanges = exchanges.filter(ex => enabledExchanges.includes(ex.id));

        if (availableExchanges.length === 0) {
            offchainContainer.innerHTML = `<p class="text-warning text-center">No exchanges are currently enabled by the admin.</p>`;
            offchainContainer.style.display = 'block';
            return;
        }

        let exchangesHtml = availableExchanges.map(ex => `
            <button type="button" class="exchange-btn" data-exchange-id="${ex.id}" data-exchange-name="${ex.name}" title="${ex.name}">
                <img src="${ex.logo}" alt="${ex.name} logo">
            </button>
        `).join('');

        offchainContainer.innerHTML = `
            <div class="card-glass p-3">
                <h6 class="text-secondary text-center">1. Select Exchange</h6>
                <div class="exchange-selector">${exchangesHtml}</div>
                <h6 class="text-secondary text-center mt-4">2. Enter Details</h6>
                <form id="offchain-form" class="mt-3">
                    <div class="mb-3">
                        <label for="offchain-address" class="form-label">Deposit Address</label>
                        <input type="text" id="offchain-address" class="form-control" placeholder="Enter your deposit address from the exchange" required>
                    </div>
                     <div class="mb-3">
                        <label for="offchain-memo" class="form-label">Memo / Tag (If required)</label>
                        <input type="text" id="offchain-memo" class="form-control" placeholder="Enter the memo/tag if the exchange requires one">
                         <div class="form-text">Leave blank if not required by your exchange.</div>
                    </div>
                    <button type="submit" id="submit-offchain-claim" class="airdrop-claim-btn claim-btn-onchain">Submit Off-chain Info</button>
                </form>
            </div>
        `;
        offchainContainer.style.display = 'block';

        document.querySelector('.exchange-selector').addEventListener('click', (e) => {
            const btn = e.target.closest('.exchange-btn');
            if (btn) {
                document.querySelectorAll('.exchange-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            }
        });

        document.getElementById('offchain-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleOffchainSubmit(rewardAmount);
        });
    }

    // [UPDATED] Handles the On-chain claim process with new parameters and NO payload
    async function handleOnchainClaim(rewardAmount) {
        const claimBtn = document.getElementById('claim-onchain-btn');
        if (!claimBtn) return;
        
        claimBtn.disabled = true;
        claimBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Processing...`;
        
        // Transaction object matches the user's requested format, without the payload
        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 60, // 60 seconds
            messages: [{
                address: ONCHAIN_CLAIM_WALLET_ADDRESS,
                amount: ONCHAIN_CLAIM_FEE_NANOTONS // "20000000"
            }]
        };

        try {
            // Send the transaction using TonConnectUI
            const result = await tonConnectUI.sendTransaction(transaction);
            
            // On success, save the claim data to Firestore
            const claimData = {
                userId: currentUserData.telegramId,
                userName: currentUserData.fullName || currentUserData.username,
                method: 'onchain',
                claimAddress: currentUserData.address, // For on-chain, claim address is the user's own wallet
                bmassAmount: rewardAmount,
                transactionBoc: result.boc, // Store the transaction boc for verification
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('airdrop_claims').doc(currentUserData.address).set(claimData);

            showAppToast('Success', 'On-chain claim transaction sent! Your information is saved.', 'success');
            await renderAirdropSection(); // Re-render to show completion status

        } catch (error) {
            console.error("On-chain claim transaction failed:", error);
            showAppToast('Transaction Failed', 'Your claim was not submitted. Please try again.', 'error');
            claimBtn.disabled = false;
            claimBtn.innerHTML = `<i class="fas fa-wallet me-2"></i>Claim On-chain (Costs ${ONCHAIN_CLAIM_FEE_TON} TON gas)`;
        }
    }

    // [NEW] Handles the Off-chain claim submission
    async function handleOffchainSubmit(rewardAmount) {
        const submitBtn = document.getElementById('submit-offchain-claim');
        const selectedExchangeEl = document.querySelector('.exchange-btn.selected');
        const addressInput = document.getElementById('offchain-address');
        const memoInput = document.getElementById('offchain-memo');

        if (!selectedExchangeEl) {
            showAppToast('Error', 'Please select an exchange.', 'error');
            return;
        }
        if (!addressInput.value.trim()) {
            showAppToast('Error', 'Please enter your deposit address.', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Saving...`;

        const claimData = {
            userId: currentUserData.telegramId,
            userName: currentUserData.fullName || currentUserData.username,
            method: 'offchain',
            exchange: selectedExchangeEl.dataset.exchangeName,
            claimAddress: addressInput.value.trim(),
            memo: memoInput.value.trim() || null,
            bmassAmount: rewardAmount,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('airdrop_claims').doc(currentUserData.address).set(claimData);
            showAppToast('Success', 'Your off-chain claim information has been saved.', 'success');
            await renderAirdropSection(); // Re-render to show completion status
        } catch (error) {
            console.error("Failed to save off-chain claim data:", error);
            showAppToast('Error', 'Could not save your information. Please try again.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Off-chain Info';
        }
    }


    function identifyTelegramUser() {
        try {
             if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();

                if(tg.initDataUnsafe && tg.initDataUnsafe.user){
                    telegramUserData = tg.initDataUnsafe.user;
                    const session = { userData: telegramUserData, expiresAt: Date.now() + (24 * 60 * 60 * 1000) };
                    localStorage.setItem(USER_SESSION_KEY, JSON.stringify(session));
                    
                    appLogoImg.src = telegramUserData.photo_url || DEFAULT_LOGO_SRC;
                    appLogoImg.style.borderRadius = '50%';
                    appLogoText.textContent = `@${telegramUserData.username}` || telegramUserData.first_name || 'Telegram User';
                    
                    const startParam = tg.initDataUnsafe.start_param;
                    if (startParam) {
                        if (startParam.startsWith('route-')) {
                            const route = startParam.split('-')[1];
                            if (route) {
                                console.log(`Deep link to route: #${route}`);
                                window.location.hash = route; 
                            }
                        } 
                        else {
                            console.log(`Referral code found: ${startParam}`);
                            sessionStorage.setItem(REFERRAL_SESSION_KEY, startParam);
                        }
                    }
                    
                    if(tonConnectUI.connected) {
                        loadOrCreateUserByAddress(tonConnectUI.account.address);
                    }
                }
            }
        } catch (e) { console.error("Could not initialize Telegram Web App:", e); }
    }
    
    function checkUserSession() {
        const sessionJSON = localStorage.getItem(USER_SESSION_KEY);
        if (!sessionJSON) return;
        try {
            const session = JSON.parse(sessionJSON);
            if (Date.now() > session.expiresAt) {
                localStorage.removeItem(USER_SESSION_KEY);
                return;
            }
            telegramUserData = session.userData;
            appLogoImg.src = telegramUserData.photo_url || DEFAULT_LOGO_SRC;
            appLogoImg.style.borderRadius = '50%';
            appLogoText.textContent = `@${telegramUserData.username}` || telegramUserData.first_name || 'Telegram User';
        } catch (error) {
            localStorage.removeItem(USER_SESSION_KEY);
        }
    }
    
    function captureWebReferral() {
        try {
             const params = new URLSearchParams(window.location.search);
             const refCode = params.get('ref');
             if (refCode) {
                sessionStorage.setItem(REFERRAL_SESSION_KEY, refCode);
                const newUrl = window.location.pathname + window.location.hash;
                history.replaceState(null, '', newUrl);
             }
        } catch(e) { console.error("Error capturing web referral:", e); }
    }

    async function initializeApp() {
        showLoadingOverlay('Initializing...');
        initializeFirebase();
    
        await fetchSystemStatus();
    
        checkUserSession();
        captureWebReferral();
        identifyTelegramUser(); 
        applyPlatformSpecificStyling();
        
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.BackButton.onClick(() => {
                window.location.hash = '#dashboard';
            });
        }
        
        if (!telegramUserData) {
            appLogoText.textContent = 'Bmass';
        }
        
        await fetchAirdropSettings();
        await fetchRewardSettings();
        await fetchLevelConfig(); // [NEW] Fetch level settings on init

        if (!applyMaintenanceMode(tonConnectUI.account?.address)) {
            handleRouteChange(); 
        }
        hideLoadingOverlay();
    }
    
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ 
        manifestUrl: 'https://bmass.vercel.app/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-button-root' 
    });
    
    tonConnectUI.onStatusChange(async (wallet) => {
        clearInterval(activityRefreshInterval);
    
        if (applyMaintenanceMode(wallet ? wallet.account.address : null)) {
            if (wallet) {
                tonConnectUI.disconnect();
            }
            hideLoadingOverlay();
            return;
        }

        if (wallet) {
            showLoadingOverlay('Connecting wallet...');
            connectedWalletAddress = wallet.account.address;
            const friendlyAddress = await getFriendlyAddress(connectedWalletAddress);
            
            referralInputContainerHero.style.display = 'none';

            tonConnectButtonRoot.style.display = 'none';
            customWalletContainer.style.display = 'block';
            customWalletButton.textContent = shortenAddress(friendlyAddress);
            copyAddressBtn.dataset.address = friendlyAddress;
            myAccountBtn.href = `https://tonviewer.com/${friendlyAddress}`;

            await loadOrCreateUserByAddress(connectedWalletAddress);
            
        } else {
            connectedWalletAddress = null;
            lastFetchedAddress = null;
            currentUserData = null;
            currentActivityLogs = [];
            userAirdropClaimData = null; // [NEW] Clear on disconnect

            tonConnectButtonRoot.style.display = 'block';
            customWalletContainer.style.display = 'none';
            headerExpDisplay.classList.add('d-none');
            navAdmin.style.display = 'none';
            
            if (!sessionStorage.getItem(REFERRAL_SESSION_KEY)){
                 referralInputContainerHero.style.display = 'block';
            }
            
            handleRouteChange();
            hideLoadingOverlay();
        }
    });
    
    const switchView = (viewToShow) => {
        [dashboardEl, heroEl, newsSection, appStoreSection, taskSectionEl, partnerSectionEl, accountSectionEl, leaderboardSectionEl, adminSectionEl, referralSectionEl, airdropSectionEl].forEach(section => {
            if(section) section.style.display = 'none';
        });
        [navDashboard, navApps, navTask, navPartner, navLeaderboard, navAccount, navAdmin, navReferral, navAirdrop].forEach(nav => nav.classList.remove('active'));

        const isLoggedIn = !!connectedWalletAddress;
        [navTask, navPartner, navAccount, navReferral, navAirdrop].forEach(nav => nav.style.display = isLoggedIn ? 'flex' : 'none');

        if (viewToShow === 'account' && isLoggedIn) { accountSectionEl.style.display = 'block'; navAccount.classList.add('active'); } 
        else if (viewToShow === 'apps') { appStoreSection.style.display = 'block'; navApps.classList.add('active'); } 
        else if (viewToShow === 'task' && isLoggedIn) { taskSectionEl.style.display = 'block'; navTask.classList.add('active'); } 
        else if (viewToShow === 'partner' && isLoggedIn) { partnerSectionEl.style.display = 'block'; navPartner.classList.add('active'); renderPartnerSection(); } 
        else if (viewToShow === 'referral' && isLoggedIn) { referralSectionEl.style.display = 'block'; navReferral.classList.add('active'); } 
        else if (viewToShow === 'airdrop') { airdropSectionEl.style.display = 'block'; navAirdrop.classList.add('active'); renderAirdropSection(); } 
        else if (viewToShow === 'leaderboard') { leaderboardSectionEl.style.display = 'block'; navLeaderboard.classList.add('active'); fetchAndRenderLeaderboard(); } 
        else if (viewToShow === 'admin' && isLoggedIn && isCurrentUserAdmin()){
            adminSectionEl.style.display = 'block';
            navAdmin.classList.add('active');
            // Lazy load admin data when the section is shown
            const adminUserPanel = document.getElementById('admin-panel-users');
            if (adminUserPanel.style.display !== 'none') {
                fetchAndRenderAdminUserList(true); 
            }
             const adminClaimPanel = document.getElementById('admin-panel-claim-list');
            if (adminClaimPanel.style.display !== 'none') {
                renderAdminClaimFilters();
                fetchAndRenderAdminClaimList(true);
            }
            const adminPartnerPanel = document.getElementById('admin-panel-partner-tasks');
             if (adminPartnerPanel.style.display !== 'none') {
                 renderAdminPartnerTasks();
             }
            maintenanceModeSwitch.checked = systemStatus.isMaintenanceMode;
            // Fetch and populate airdrop settings
            fetchAirdropSettings().then(settings => {
                 if (!settings) return;
                 // Scoring Tab
                 document.getElementById('ref-multiplier-input').value = settings.refMultiplier ?? 50;
                 document.getElementById('checkin-multiplier-input').value = settings.checkinMultiplier ?? 30;
                 document.getElementById('exp-multiplier-input').value = settings.expMultiplier ?? 1;
                 document.getElementById('min-checkins-input').value = settings.minCheckins || 0;
                 document.getElementById('min-referrals-input').value = settings.minReferrals || 0;
                 document.getElementById('min-exp-input').value = settings.minExp || 0;
                 renderLevelMultipliersUI(settings.levelMultipliers);
                 // Claim Tab
                 document.getElementById('airdrop-live-switch').checked = settings.isAirdropLive || false;
                 document.getElementById('snapshot-active-switch').checked = settings.isSnapshotActive || false;
                 document.getElementById('claim-edit-switch').checked = settings.allowClaimInfoEdit === true;
                 document.getElementById('notify-sent-switch').checked = settings.notifyAirdropSent || false;
                 document.getElementById('onchain-claim-enabled-switch').checked = settings.onchainClaimEnabled || false;
                 offchainClaimEnabledSwitch.checked = settings.offchainClaimEnabled || false;
                 renderAdminExchangeCheckboxes(settings.enabledExchanges || []);
                 offchainSettingsContainer.style.display = offchainClaimEnabledSwitch.checked ? 'block' : 'none';
            });
        } else { 
            if (isLoggedIn) { dashboardEl.style.display = 'block'; } 
            else { heroEl.style.display = 'flex'; }
            if (newsSection) newsSection.style.display = 'block';
            navDashboard.classList.add('active');
        }
        if (sidebarMenu.classList.contains('open')) toggleSidebar();
    };
    
    const handleRouteChange = () => {
        let hash = window.location.hash.substring(1) || 'dashboard';
        const [path, queryString] = hash.split('?');
        const tg = window.Telegram?.WebApp;
        
        const protectedRoutes = ['task', 'partner', 'account', 'admin', 'referral', 'airdrop', 'leaderboard'];
        if (!connectedWalletAddress && protectedRoutes.includes(path)) {
             showAppToast('Wallet Connection Required', 'This feature requires a connected wallet.', 'warning');
             window.location.hash = '#dashboard';
             hash = 'dashboard';
        }
         
        if (path === 'admin' && !isCurrentUserAdmin()){
             showAppToast('Access Denied', 'You do not have permission to access this page.', 'error');
             window.location.hash = '#dashboard';
             hash = 'dashboard'; 
        }

        if (tg) {
            if (path === 'dashboard' || path === '') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
            }
        }

        switchView(path);

        if (path === 'apps') {
            const params = new URLSearchParams(queryString || '');
            const searchQuery = params.get('search');
            appSearchInput.value = searchQuery ? decodeURIComponent(searchQuery) : '';
            renderApps();
        }
    };

    const shortenAddress = (addr, start = 6, end = 6) => addr ? (addr.includes('.') ? addr : `${addr.slice(0, start)}...${addr.slice(-end)}`) : 'Unknown';
    
    const handleManualReferralInput = async (e) => {
        let inputEl, btnEl;
        if(e.currentTarget.id.includes('hero')) {
            inputEl = referralCodeInputHero; btnEl = referralCodeSubmitHero;
        } else {
            inputEl = referralCodeInput; btnEl = referralCodeSubmit;
        }

        const code = inputEl.value.trim();
        if (!code) { showAppToast('Error', 'Please enter an invitation code.', 'warning'); return; }

        if(connectedWalletAddress) { 
             btnEl.disabled = true;
             btnEl.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
             await applyReferral(code, connectedWalletAddress);
             const updatedDoc = await db.collection('users').doc(connectedWalletAddress).get();
             if(updatedDoc.exists) {
                currentUserData = updatedDoc.data();
                updateUIAfterLogin();
             }
             btnEl.disabled = false;
             btnEl.textContent = 'Confirm';
             inputEl.value = '';

        } else {
            sessionStorage.setItem(REFERRAL_SESSION_KEY, code);
            showAppToast('Code Saved', 'Your referral code has been saved. Connect your wallet to complete the process.', 'info');
            inputEl.value = '';
            referralInputContainerHero.style.display = 'none';
        }
    };
    
    const formatBalance = (bigIntString, decimals, symbol = '') => {
        try {
            const validDecimals = (typeof decimals === 'number' && !isNaN(decimals)) ? decimals : 9;
            const balance = parseFloat(BigInt(bigIntString)) / (10 ** validDecimals);
            const formattedNumber = balance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 6
            });
            return `${formattedNumber} ${symbol}`;
        } catch (e) {
            return `0 ${symbol}`;
        }
    };

    async function getFriendlyAddress(address) {
        if (!address || typeof address !== 'string' || address.includes('.') || !address.includes(':')) return address;
        if (addressCache[address]) return addressCache[address];
        try {
            const response = await fetch(`https://toncenter.com/api/v2/detectAddress?address=${encodeURIComponent(address)}`);
            if (!response.ok) throw new Error('API response not OK');
            const data = await response.json();
            const friendlyAddress = data?.result?.non_bounceable?.b64url || address;
            addressCache[address] = friendlyAddress;
            return friendlyAddress;
        } catch (error) {
            console.warn(`Could not convert address ${address}:`, error);
            return address;
        }
    }
    
    const getRaw = (addrObj) => addrObj?.raw_form || (typeof addrObj?.address === 'string' ? addrObj.address : null);
    
    const setSkeletonLoaders = (isInitial = true) => {
        portfolioSkeleton.style.display = 'block';
        portfolioContent.style.display = 'none';
        mainAssetsContent.innerHTML = skeletonAsset;
        otherTokensContent.innerHTML = skeletonTx.repeat(3);
        nftGalleryContent.innerHTML = `<div class="row g-2">${Array(4).fill('<div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 25px;"></div></div>').join('')}</div>`;
        if (isInitial) {
            activityFeedContent.innerHTML = skeletonTx.repeat(5);
        }
    };
    
    async function renderMainAssets(accountInfo, tonPriceUsd, tonValueUsd, tonValueVnd) {
        if (!accountInfo) {
            mainAssetsContent.innerHTML = `<p class="text-danger">Could not load account data.</p>`;
            return;
        }
        const userFriendlyAddress = await getFriendlyAddress(accountInfo.address);
        const tonBalance = accountInfo.balance / 1e9;
        const formattedTonBalance = tonBalance.toLocaleString('en-US', { maximumFractionDigits: 6 });
        const formattedPriceUsd = tonPriceUsd ? `$${tonPriceUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 4 })}` : 'N/A';
        const formattedValueUsd = tonValueUsd ? `$${tonValueUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A';
        const formattedValueVnd = tonValueVnd ? `${tonValueVnd.toLocaleString('vi-VN')} VND` : 'N/A';
        
        mainAssetsContent.innerHTML = `
            <div class="d-flex align-items-center mb-3">
                <img src="https://ton.org/download/ton_symbol.png" class="me-3" style="width: 48px;">
                <div><h5 class="m-0">TON</h5><p class="m-0 text-secondary">The Open Network</p></div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-secondary">Balance</span><strong style="font-size: 1.1rem;">${formattedTonBalance}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-secondary">Current Price</span><strong>${formattedPriceUsd}</strong>
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <span class="text-secondary">Total Value</span>
                <div class="text-end">
                    <strong style="font-size: 1.1rem;">${formattedValueUsd}</strong><br>
                    <small class="text-secondary">${formattedValueVnd}</small>
                </div>
            </div>
            <hr style="border-color: var(--border-color); opacity: 0.5;">
            <div class="d-flex align-items-center justify-content-between mt-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-wallet me-3" style="width: 48px; font-size: 24px; text-align: center; color: var(--accent-secondary);"></i>
                    <div><h5 class="m-0">Address</h5><p class="m-0 text-secondary">Wallet</p></div>
                </div>
                <h6><code class="copyable-address" data-address="${userFriendlyAddress}" title="Click to copy">${shortenAddress(userFriendlyAddress)}</code></h6>
            </div>
        `;
    }

    function renderOtherTokens(jettons) {
        otherTokensContent.innerHTML = '';
        if (jettons?.length > 0) {
            jettons.forEach(j => {
                const balance = Number(BigInt(j.balance)) / (10 ** (j.jetton.decimals || 9));
                const verifiedTick = j.jetton.verification === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
                let valueDisplayHtml;
                const priceUsdt = j.price?.prices?.USDT;
                if (priceUsdt) {
                    const valueUsd = balance * priceUsdt;
                    valueDisplayHtml = `
                        <div class="text-end">
                            <h6 class="m-0">$${valueUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</h6>
                            <small class="text-secondary">${balance.toLocaleString('en-US', { maximumFractionDigits: 4 })} ${j.jetton.symbol}</small>
                        </div>`;
                } else {
                    valueDisplayHtml = `<h6 class="m-0">${balance.toLocaleString('en-US', { maximumFractionDigits: 4 })}</h6>`;
                }
                otherTokensContent.innerHTML += `
                    <div class="d-flex align-items-center justify-content-between mb-3 p-2 jetton-item" data-jetton-address="${j.jetton.address}">
                        <div class="d-flex align-items-center">
                            <img src="${j.jetton.image}" class="me-3 jetton-item-img" onerror="this.src='https://ton.org/download/ton_symbol.png'">
                            <div><h6 class="m-0">${j.jetton.symbol}${verifiedTick}</h6></div>
                        </div>
                        ${valueDisplayHtml}
                    </div>`;
            });
        } else { otherTokensContent.innerHTML = `<p class="text-secondary">No tokens found.</p>`; }
    }

    function renderNFTs(nfts) {
        nftGalleryContent.innerHTML = '';
        if (nfts?.length > 0) {
            let html = '<div class="row g-2">';
            nfts.slice(0, 18).forEach(nft => {
                const imgUrl = nft.previews?.[nft.previews.length - 1]?.url || nft.metadata?.image || 'https://via.placeholder.com/100';
                html += `<div class="col-3"><div title="${nft.metadata?.name || 'NFT'}" style="cursor: pointer;"><img src="${imgUrl}" style="width: 100%; border-radius: 25px; aspect-ratio: 1/1; object-fit: cover;" onerror="this.src='https://via.placeholder.com/100'"></div></div>`;
            });
            nftGalleryContent.innerHTML = html + '</div>';
        } else { nftGalleryContent.innerHTML = `<p class="text-secondary">No NFTs found.</p>`; }
    }

    function renderSingleActivityItem(log) {
        const statusIcon = log.status === 'ok' ? `<i class="fas fa-check-circle status-icon status-ok"></i>` : `<i class="fas fa-exclamation-circle status-icon status-failed"></i>`;
        const titleText = log.status !== 'ok' ? `<span class="text-warning">${log.title} (Failed)</span>` : log.title;
        const colorClass = log.direction === 'in' ? 'amount-in' : 'amount-out';
        const amountDisplay = log.amount !== null ? `<p class="m-0 fw-bold ${colorClass}">${log.sign} ${log.amount.toLocaleString('en-US', {maximumFractionDigits: 4})} ${log.symbol}</p>` : `<p class="m-0 fw-bold">${log.symbol} Transfer</p>`;
        const commentDisplay = log.comment ? `<div class="w-100 mt-2"><p class="m-0 text-secondary" style="font-size: 0.8rem; font-style: italic;"><i class="fas fa-comment-dots me-2"></i>${log.comment}</p></div>` : '';
        const partyAddressHtml = `<code class="copyable-address" data-address="${log.party_full}" title="Click to copy">${log.party}</code>`;
        return `
         <div class="d-flex flex-wrap align-items-center py-3 border-bottom border-secondary border-opacity-25">
            <img src="${log.image}" class="activity-item-icon me-3" onerror="this.src='https://ton.org/download/ton_symbol.png'"/>
            <div class="flex-grow-1"><p class="m-0 fw-bold">${statusIcon}${titleText}</p><p class="m-0 text-secondary" style="font-size: 0.8rem;">${log.party_title}: ${partyAddressHtml}</p></div>
            <div class="text-end">${amountDisplay}<p class="m-0 text-secondary" style="font-size: 0.8rem;">${new Date(log.timestamp).toLocaleString()}</p></div>
            ${commentDisplay}
         </div>`;
    }

async function fetchAndDisplayAccountData(addressToFetch) {
    const isNewAddress = addressToFetch !== lastFetchedAddress;
    if (isNewAddress) {
        currentActivityLogs = [];
        activityFeedContent.innerHTML = '';
        lastFetchedAddress = addressToFetch;
        setSkeletonLoaders(true);
    } else {
        setSkeletonLoaders(false);
    }
    searchResultsContainer.style.display = 'none';
    searchInput.value = '';
    const isMyWallet = connectedWalletAddress && addressToFetch === connectedWalletAddress;
    backToMyWalletBtn.style.display = isMyWallet ? 'none' : 'block';
    if (!isMyWallet) clearInterval(activityRefreshInterval);
    try {
        const [tonapiResults, coingeckoResult] = await Promise.allSettled([
            Promise.allSettled([
                fetch(`${TON_API_BASE}/accounts/${addressToFetch}`),
                fetch(`${TON_API_BASE}/accounts/${addressToFetch}/jettons?currencies=usdt`),
                fetch(`${TON_API_BASE}/accounts/${addressToFetch}/nfts?limit=100&indirect_ownership=false`),
                fetch(`${TON_API_BASE}/accounts/${addressToFetch}/events?limit=100`)
            ]),
            fetch(`${COINGECKO_API_BASE}/simple/price?ids=the-open-network&vs_currencies=usd,vnd`)
        ]);
        const [accountResult, jettonsResult, nftsResult, eventsResult] = tonapiResults.value;
        if (accountResult.status === 'rejected' || !accountResult.value.ok) throw new Error(`Could not fetch account info.`);
        const accountInfo = await accountResult.value.json();
        const jettonsInfo = (jettonsResult.status === 'fulfilled' && jettonsResult.value.ok) ? await jettonsResult.value.json() : { balances: [] };
        const nftsInfo = (nftsResult.status === 'fulfilled' && nftsResult.value.ok) ? await nftsResult.value.json() : { nft_items: [] };
        const eventsInfo = (eventsResult.status === 'fulfilled' && eventsResult.value.ok) ? await eventsResult.value.json() : { events: [] };
        const priceData = (coingeckoResult.status === 'fulfilled' && coingeckoResult.value.ok) ? await coingeckoResult.value.json() : {};
        let totalValueUsd = 0, totalValueVnd = 0, tonValueUsd = 0, tonValueVnd = 0;
        const tonPriceInfo = priceData['the-open-network'];
        if (tonPriceInfo && tonPriceInfo.usd && tonPriceInfo.vnd) {
            const tonBalance = accountInfo.balance / 1e9;
            tonValueUsd = tonBalance * tonPriceInfo.usd;
            tonValueVnd = tonBalance * tonPriceInfo.vnd;
            totalValueUsd += tonValueUsd;
        totalValueVnd += tonValueVnd;
        }
        const usdToVndRate = (tonPriceInfo?.vnd && tonPriceInfo?.usd) ? tonPriceInfo.vnd / tonPriceInfo.usd : 25450;
        if (jettonsInfo.balances.length > 0) {
            jettonsInfo.balances.forEach(j => {
                const priceUsdt = j.price?.prices?.USDT;
                if (priceUsdt) {
                    const jettonBalance = Number(BigInt(j.balance)) / (10 ** (j.jetton.decimals || 9));
                    const jettonValueUsd = jettonBalance * priceUsdt;
                    totalValueUsd += jettonValueUsd;
                    totalValueVnd += jettonValueUsd * usdToVndRate;
                }
            });
        }
        totalValueUsdEl.textContent = `$${totalValueUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        totalValueVndEl.textContent = `${totalValueVnd.toLocaleString('vi-VN')} VND`;
        portfolioSkeleton.style.display = 'none';
        portfolioContent.style.display = 'block';
        const newLogs = (eventsInfo.events ?? []).flatMap((event) => parseEvent(event, accountInfo.address));
        processNewActivity(newLogs);
        await renderMainAssets(accountInfo, tonPriceInfo?.usd, tonValueUsd, tonValueVnd);
        renderOtherTokens(jettonsInfo.balances);
        renderNFTs(nftsInfo.nft_items ?? []);
        if (nftsResult.status === 'rejected') nftGalleryContent.innerHTML = `<p class="text-warning">Could not load NFTs.</p>`;
    } catch (error) {
        console.error("Error fetching account data:", error);
        mainAssetsContent.innerHTML = `<p class="text-danger"><strong>Error:</strong> ${error.message}</p>`;
        [otherTokensContent, nftGalleryContent, activityFeedContent].forEach(el => el.innerHTML = `<p class="text-secondary">Data unavailable.</p>`);
        portfolioSkeleton.style.display = 'none';
        portfolioContent.style.display = 'block';
        totalValueUsdEl.textContent = '$ -';
        totalValueVndEl.textContent = '- VND';
    }
}

function processNewActivity(newLogs) {
    const existingHashes = new Set(currentActivityLogs.map(log => log.hash));
    const genuinelyNewLogs = newLogs.filter(log => !existingHashes.has(log.hash));
    if (genuinelyNewLogs.length > 0) {
        const newLogsHtml = genuinelyNewLogs.map(log => renderSingleActivityItem(log)).join('');
        activityFeedContent.insertAdjacentHTML('afterbegin', newLogsHtml);
        currentActivityLogs = [...genuinelyNewLogs, ...currentActivityLogs];
        showTransactionPopup(genuinelyNewLogs);
    } else if (currentActivityLogs.length === 0) {
        const initialLogsHtml = newLogs.slice(0, 50).map(log => renderSingleActivityItem(log)).join('');
        activityFeedContent.innerHTML = initialLogsHtml;
        currentActivityLogs = newLogs.slice(0, 50);
        if (currentActivityLogs.length === 0) {
            activityFeedContent.innerHTML = `<p class="text-secondary">No recent activity found.</p>`;
        }
    }
}

function showTransactionPopup(log) {
     const amountDisplay = log.amount !== null ? `<strong class="${log.direction === 'in' ? 'amount-in' : 'amount-out'}">${log.sign} ${log.amount.toLocaleString('en-US', {maximumFractionDigits: 4})} ${log.symbol}</strong>` : `a ${log.symbol} transfer`;
    const actionText = log.direction === 'in' ? `Received ${amountDisplay} from` : `Sent ${amountDisplay} to`;
    const message = `${actionText} ${log.party}`;
    showAppToast('New Transaction', message);
}

function parseEvent(event, viewingRawAddress) {
    const logs = [];
    if (!event?.actions) return logs;
    event.actions.forEach((action, actionIndex) => {
        try {
            const log = { hash: `${event.event_id}-${actionIndex}`, timestamp: event.timestamp * 1000, status: action.status, amount: null };
            const isViewingAddress = (partyObj) => getRaw(partyObj) === viewingRawAddress;
            const processParty = (partyObj) => ({ short: partyObj?.name || shortenAddress(partyObj?.address), full: partyObj?.address });
            if (action.type === 'TonTransfer' && action.TonTransfer) {
                const t = action.TonTransfer;
                log.direction = isViewingAddress(t.sender) ? 'out' : 'in';
                log.title = "TON Transfer"; log.sign = log.direction === 'in' ? '+' : '-';
                log.amount = Number(t.amount) / 1e9;
                log.symbol = 'TON'; log.party_title = log.direction === 'out' ? 'To' : 'From';
                const partyInfo = processParty(log.direction === 'out' ? t.recipient : t.sender);
                log.party = partyInfo.short; log.party_full = partyInfo.full;
                log.image = 'https://ton.org/download/ton_symbol.png'; log.comment = t.comment || null;
                if (log.party) logs.push(log);
            } else if (action.type === 'JettonTransfer' && action.JettonTransfer) {
                const t = action.JettonTransfer;
                log.direction = isViewingAddress(t.sender) ? 'out' : 'in';
                log.title = "Jetton Transfer"; log.sign = log.direction === 'in' ? '+' : '-';
                log.amount = Number(BigInt(t.amount)) / (10 ** (t.jetton?.decimals || 9));
                log.symbol = t.jetton?.symbol || 'Token'; log.party_title = log.direction === 'out' ? 'To' : 'From';
                const partyInfo = processParty(log.direction === 'out' ? t.recipient : t.sender);
                log.party = partyInfo.short; log.party_full = partyInfo.full;
                log.image = t.jetton?.image || 'https://ton.org/download/ton_symbol.png'; log.comment = t.comment || null;
                if (log.party) logs.push(log);
            }
        } catch (e) { console.warn("Could not parse an action:", action, "Error:", e); }
    });
    return logs;
}

async function fetchCryptoNews() {
    if (!newsContentArea) return;
    newsContentArea.innerHTML = `<div class="news-grid">${skeletonTx.repeat(3)}</div>`;
    try {
        const response = await fetch('https://min-api.cryptocompare.com/data/v2/news/?lang=EN&limit=6');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const newsData = await response.json();
        newsContentArea.innerHTML = '';
        if (newsData.Type === 100 && newsData.Data?.length > 0) {
            let newsHtml = '<div class="news-grid">';
            newsData.Data.forEach(article => {
                newsHtml += `
                <a href="${article.url}" target="_blank" rel="noopener noreferrer" class="news-card">
                    <img src="${article.imageurl}" class="news-card-img" onerror="this.style.display='none'">
                    <div class="news-card-body">
                        <h3 class="news-card-title">${article.title}</h3>
                        <p class="news-card-source">${article.source} - ${new Date(article.published_on * 1000).toLocaleDateString()}</p>
                    </div>
                </a>`;
            });
            newsContentArea.innerHTML = newsHtml + '</div>';
        } else { newsContentArea.innerHTML = '<p class="text-secondary text-center">No news found.</p>'; }
    } catch (error) {
        console.error("Error fetching crypto news:", error);
        newsContentArea.innerHTML = '<p class="text-danger text-center">Could not load news feed.</p>';
    }
}

async function handleFastSearch() {
    const query = searchInput.value.trim();
    if (!query) { searchResultsContainer.style.display = 'none'; return; }
    if ((query.length >= 48 && query.includes(':')) || query.length === 48 || query.endsWith('.ton')) { fetchAndDisplayAccountData(query); return; }
    searchResultsContainer.style.display = 'block';
    searchResultsContainer.innerHTML = `<div class="p-2 text-center text-secondary">${skeletonTx}</div>`;
    try {
        const response = await fetch(`${TON_API_BASE}/accounts/search?name=${encodeURIComponent(query)}`);
        if (!response.ok) throw new Error('Search API failed');
        const data = await response.json();
        const results = data.addresses || [];
        searchResultsContainer.innerHTML = '';
        if (results.length > 0) {
            for (const res of results) {
                const friendlyAddress = await getFriendlyAddress(res.address);
                const isJetton = res.name && res.name.toLowerCase().includes('jetton');
                const item = document.createElement('div');
                item.className = 'd-flex align-items-center p-2 mb-1 search-result-item';
                item.dataset.address = res.address;
                item.dataset.type = isJetton ? 'jetton' : 'account';
                const imageUrl = res.preview || res.icon || 'https://ton.org/download/ton_symbol.png';
                const verifiedTick = res.trust === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
                const addressHtml = `<code class="copyable-address" data-address="${friendlyAddress}" title="Click to copy">${shortenAddress(friendlyAddress)}</code>`;
                item.innerHTML = `
                    <img src="${imageUrl}" class="me-3 search-result-item-img" onerror="this.src='https://ton.org/download/ton_symbol.png'"/>
                    <div class="flex-grow-1">
                        <p class="m-0 fw-bold">${res.name || 'Unnamed'} ${verifiedTick}</p>
                        <p class="m-0 text-secondary" style="font-size: 0.8rem;">${addressHtml}</p>
                    </div>`;
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('copyable-address')) return;
                    searchResultsContainer.style.display = 'none';
                    searchInput.value = '';
                    if (item.dataset.type === 'jetton') {
                        showJettonDetails(item.dataset.address);
                    } else {
                        fetchAndDisplayAccountData(item.dataset.address);
                    }
                });
                searchResultsContainer.appendChild(item);
            }
        } else { searchResultsContainer.innerHTML = '<p class="text-secondary text-center p-3">No results.</p>'; }
    } catch (error) {
        console.error('Error during search:', error);
        searchResultsContainer.innerHTML = '<p class="text-danger text-center p-3">Search failed.</p>';
    }
}

async function showJettonDetails(jettonAddress) {
    jettonDetailModal.show();
    const headerEl = document.getElementById('jetton-modal-header-content');
    const metadataEl = document.getElementById('metadata-tab-pane');
    const historyEl = document.getElementById('history-tab-pane');
    const holdersEl = document.getElementById('holders-tab-pane');
    const holdersTabBtn = document.getElementById('holders-tab');
    if (holdersTabBtn) holdersTabBtn.textContent = 'Holders';
    headerEl.innerHTML = `<h5 class="modal-title">Loading Jetton...</h5>`;
    [metadataEl, historyEl, holdersEl].forEach(el => el.innerHTML = `<div class="w-100 text-center p-5">${skeletonTx}</div>`);
    const [metadataRes, historyRes, holdersRes] = await Promise.allSettled([
        fetch(`${TON_API_BASE}/jettons/${jettonAddress}`),
        fetch(`${TON_API_BASE}/accounts/${jettonAddress}/events?limit=100`),
        fetch(`${TON_API_BASE}/jettons/${jettonAddress}/holders?limit=100`)
    ]);
    let jettonMetadata = null;
    if (metadataRes.status === 'fulfilled' && metadataRes.value.ok) {
        const data = await metadataRes.value.json();
        jettonMetadata = data.metadata;
        if (holdersTabBtn && data.holders_count) holdersTabBtn.textContent = `Holders (${data.holders_count.toLocaleString('en-US')})`;
        const friendlyJettonAddress = await getFriendlyAddress(jettonMetadata.address);
        const verifiedTick = data.verification === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
        headerEl.innerHTML = `<img src="${jettonMetadata.image}" class="me-3 jetton-item-img" onerror="this.src='https://ton.org/download/ton_symbol.png'"><h5 class="modal-title">${jettonMetadata.name} (${jettonMetadata.symbol}) ${verifiedTick}</h5>`;
        const addressHtml = `<code class="copyable-address" data-address="${friendlyJettonAddress}" title="Click to copy">${shortenAddress(friendlyJettonAddress, 10, 10)}</code>`;
        const totalSupply = formatBalance(data.total_supply, jettonMetadata.decimals, jettonMetadata.symbol);
        metadataEl.innerHTML = `<p class="mb-3">${jettonMetadata.description || 'No description.'}</p><div class="row g-3"><div class="col-12"><span class="metadata-key">Address:</span> <span class="fs-sm text-break">${addressHtml}</span></div><div class="col-md-6"><span class="metadata-key">Decimals:</span> ${jettonMetadata.decimals}</div><div class="col-md-6"><span class="metadata-key">Mintable:</span> ${data.mintable ? 'Yes' : 'No'}</div><div class="col-12"><span class="metadata-key">Total Supply:</span> ${totalSupply}</div></div>`;
    } else { metadataEl.innerHTML = `<p class="text-danger">Failed to load metadata.</p>`; }

    if (historyRes.status === 'fulfilled' && historyRes.value.ok) {
        const data = await historyRes.value.json();
        const historyLogs = (data.events ?? []).flatMap((e) => parseEvent(e, jettonAddress));
        if (historyLogs.length > 0) {
            historyEl.innerHTML = '';
            historyLogs.slice(0, 50).forEach(log => {
               const partyAddressHtml = `<code class="copyable-address" data-address="${log.party_full}" title="Click to copy">${shortenAddress(log.party)}</code>`;
               historyEl.innerHTML += `<div class="d-flex flex-wrap justify-content-between align-items-center p-2 border-bottom border-secondary border-opacity-25"><div><small>${log.title} to/from ${partyAddressHtml}</small></div><div class="text-end"><small class="${log.direction === 'in' ? 'amount-in' : 'amount-out'}">${log.sign} ${log.amount.toLocaleString()}</small><br><small class="text-secondary">${new Date(log.timestamp).toLocaleDateString()}</small></div></div>`;
            });
        } else { historyEl.innerHTML = `<p class="text-secondary text-center p-3">No history.</p>`; }
    } else { historyEl.innerHTML = `<p class="text-danger">Failed to load history.</p>`; }

    if (holdersRes.status === 'fulfilled' && holdersRes.value.ok) {
        const data = await holdersRes.value.json();
        const decimals = jettonMetadata?.decimals;
        const symbol = jettonMetadata?.symbol || '';
        if (data.addresses?.length > 0) {
            let tableHtml = `<table class="table table-hover align-middle"><thead><tr><th scope="col" style="width: 5%;">#</th><th scope="col">Holder</th><th scope="col" class="text-end">Balance</th></tr></thead><tbody>`;
            for (const [index, holder] of data.addresses.entries()) {
                const ownerWalletAddress = holder.owner.address;
                const friendlyDisplayAddress = await getFriendlyAddress(ownerWalletAddress);
                const displayName = holder.owner.name ? `<strong>${holder.owner.name}</strong>` : `<code class="copyable-address" data-address="${friendlyDisplayAddress}" title="Click to copy">${shortenAddress(friendlyDisplayAddress)}</code>`;
                const fullAddressHtml = holder.owner.name ? `<br><small class="text-secondary"><code class="copyable-address" data-address="${friendlyDisplayAddress}" title="Click to copy">${shortenAddress(friendlyDisplayAddress, 10, 10)}</code></small>` : '';
                tableHtml += `<tr><th scope="row">${index + 1}</th><td>${displayName}${fullAddressHtml}</td><td class="text-end fw-bold">${formatBalance(holder.balance, decimals, symbol)}</td></tr>`;
            }
            tableHtml += `</tbody></table>`;
            holdersEl.innerHTML = tableHtml;
        } else { holdersEl.innerHTML = `<p class="text-secondary text-center p-3">No holders.</p>`; }
    } else { holdersEl.innerHTML = `<p class="text-danger">Failed to load holders.</p>`; }
}

const renderApps = () => {
    if (!appGrid || typeof appsData === 'undefined') return;
    const searchTerm = appSearchInput.value.toLowerCase();
    const activeFilter = appFilterControls.querySelector('.app-filter-btn.active').dataset.filter;
    let filteredApps = appsData.filter(app => 
        (activeFilter === 'all' || app.category.includes(activeFilter)) &&
        (!searchTerm || app.name.toLowerCase().includes(searchTerm))
    );
    appGrid.innerHTML = '';
    if (filteredApps.length === 0) {
        appGrid.innerHTML = `<div class="col-12 text-center mt-4"><p class="text-secondary fs-5">No applications found.</p></div>`;
        return;
    }
    filteredApps.forEach(app => {
        const appCard = document.createElement('div');
        appCard.className = 'col';
        appCard.innerHTML = `<a href="${app.link}" target="_blank" rel="noopener noreferrer" class="app-item"><div class="app-item-img-wrapper"><img src="${app.image}" alt="${app.name} logo" class="app-item-img" onerror="this.src='https://via.placeholder.com/90?text=App';"></div><span class="app-item-name">${app.name}</span></a>`;
        appGrid.appendChild(appCard);
    });
};

function showAppToast(header, message, type = 'info') {
    document.querySelector('.toast-notification')?.remove();
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    let iconClass = 'fas fa-info-circle';
    if (type === 'success') iconClass = 'fas fa-check-circle';
    if (type === 'error') iconClass = 'fas fa-times-circle';
    if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
    toast.innerHTML = `<div class="toast-notification-header"><i class="${iconClass} me-2"></i> ${header}</div><p class="m-0">${message}</p>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    const hideTimeout = setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); }, 5000);
    toast.addEventListener('click', () => { clearTimeout(hideTimeout); toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); }, { once: true });
}

const toggleSidebar = () => {
    hamburgerBtn.classList.toggle('open');
    sidebarMenu.classList.toggle('open');
    sidebarOverlay.classList.toggle('open');
};

// [NEW] Save Airdrop SCORING Settings
async function saveAirdropScoringSettings() {
    const refMultiplier = parseFloat(document.getElementById('ref-multiplier-input').value) || 0;
    const checkinMultiplier = parseFloat(document.getElementById('checkin-multiplier-input').value) || 0;
    const expMultiplier = parseFloat(document.getElementById('exp-multiplier-input').value) || 0;
    const minCheckins = parseInt(document.getElementById('min-checkins-input').value, 10);
    const minReferrals = parseInt(document.getElementById('min-referrals-input').value, 10);
    const minExp = parseInt(document.getElementById('min-exp-input').value, 10);

    const levelMultipliers = [];
    document.querySelectorAll('.level-multiplier-item').forEach(item => {
        const level = parseInt(item.dataset.level, 10);
        const multiplier = parseFloat(item.querySelector('input').value);
        if (!isNaN(level) && !isNaN(multiplier)) {
            levelMultipliers.push({ level, multiplier });
        }
    });
    
    if ([minCheckins, minReferrals, minExp, refMultiplier, checkinMultiplier, expMultiplier].some(isNaN)) {
         showAppToast('Lỗi', 'Vui lòng nhập giá trị số hợp lệ.', 'error');
         return;
    }

    saveScoringSettingsBtn.disabled = true;
    adminScoringSettingsStatusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...`;
    
    try {
        const settingsRef = db.collection('admin_settings').doc('airdrop_criteria');
        const newSettings = { minCheckins, minReferrals, minExp, refMultiplier, checkinMultiplier, expMultiplier, levelMultipliers };
        await settingsRef.set(newSettings, { merge: true });
        airdropSettings = { ...airdropSettings, ...newSettings }; // Update local cache
        adminScoringSettingsStatusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Đã lưu thành công!</span>`;
        showAppToast('Thành công', 'Đã lưu cài đặt tính điểm.', 'success');
    } catch(error) {
         console.error("Error saving airdrop scoring settings:", error);
        adminScoringSettingsStatusEl.innerHTML = `<span class="text-danger">Lưu thất bại.</span>`;
        showAppToast('Lỗi', 'Không thể lưu cài đặt tính điểm.', 'error');
    } finally {
        saveScoringSettingsBtn.disabled = false;
        setTimeout(() => { adminScoringSettingsStatusEl.innerHTML = ''; }, 3000);
    }
}

// [NEW] Save Airdrop CLAIM Settings
async function saveAirdropClaimSettings() {
    const isAirdropLive = document.getElementById('airdrop-live-switch').checked;
    const isSnapshotActive = document.getElementById('snapshot-active-switch').checked;
    const allowClaimInfoEdit = document.getElementById('claim-edit-switch').checked;
    const notifyAirdropSent = document.getElementById('notify-sent-switch').checked;
    const onchainClaimEnabled = document.getElementById('onchain-claim-enabled-switch').checked;
    const offchainClaimEnabled = document.getElementById('offchain-claim-enabled-switch').checked;
    
    if (isSnapshotActive && !airdropSettings?.isSnapshotActive) {
        if (!confirm("CẢNH BÁO: Bạn sắp kích hoạt Snapshot. Hành động này sẽ DỪNG tất cả các hoạt động kiếm điểm và cho phép người dùng bắt đầu claim. Hành động này không thể hoàn tác. Bạn có chắc chắn muốn tiếp tục không?")) {
            document.getElementById('snapshot-active-switch').checked = false;
            return;
        }
    }

    const enabledExchanges = [];
    document.querySelectorAll('#exchange-checkboxes-container input[type="checkbox"]:checked').forEach(checkbox => {
        enabledExchanges.push(checkbox.value);
    });
    
    saveClaimSettingsBtn.disabled = true;
    adminClaimSettingsStatusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...`;

    try {
        const settingsRef = db.collection('admin_settings').doc('airdrop_criteria');
        const newSettings = { isAirdropLive, isSnapshotActive, allowClaimInfoEdit, notifyAirdropSent, onchainClaimEnabled, offchainClaimEnabled, enabledExchanges };
         await settingsRef.set(newSettings, { merge: true });
        
         // Check if the notifyAirdropSent status has just been flipped to true
        const shouldNotify = notifyAirdropSent && (!airdropSettings || !airdropSettings.notifyAirdropSent);

        airdropSettings = { ...airdropSettings, ...newSettings }; // Update local cache
        adminClaimSettingsStatusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Đã lưu thành công!</span>`;
        showAppToast('Thành công', 'Đã lưu cài đặt Claim.', 'success');

         if (shouldNotify) {
            handleNotifyAirdropSent();
        }

    } catch (error) {
        console.error("Error saving airdrop claim settings:", error);
        adminClaimSettingsStatusEl.innerHTML = `<span class="text-danger">Lưu thất bại.</span>`;
        showAppToast('Lỗi', 'Không thể lưu cài đặt Claim.', 'error');
    } finally {
        saveClaimSettingsBtn.disabled = false;
        setTimeout(() => { adminClaimSettingsStatusEl.innerHTML = ''; }, 4000);
    }
}

// [NEW] Function to trigger notification sending for claimed users
function handleNotifyAirdropSent() {
    const messageGenerator = (user) => {
        let memoText = user.memo ? ` (memo: ${user.memo})` : '';
        const text = `🎉 Congratulations! Your $BMASS airdrop has been sent to your specified address: \n\n${user.claimAddress}${memoText}\n\nThank you for being a part of the Bmass community!`;
        return {
            body: { text: text },
            method: 'sendMessage'
        };
    };
    sendBulkTelegramMessage(messageGenerator);
}

// [UPDATED] Export Airdrop CLAIM Data to Excel
async function exportAirdropClaimData() {
    exportClaimExcelBtn.disabled = true;
    adminClaimSettingsStatusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang chuẩn bị dữ liệu...`;
    
    try {
        const snapshot = await db.collection('airdrop_claims').get();
        if (snapshot.empty) {
             showAppToast('Thông báo', 'Không có dữ liệu claim nào để xuất.', 'info');
            adminClaimSettingsStatusEl.innerHTML = `<span class="text-warning">Không có dữ liệu.</span>`;
            return;
        }

        adminClaimSettingsStatusEl.innerHTML = `<i class="fas fa-file-excel me-2"></i>Đang tạo file Excel...`;

        const claimsBySheet = {};
        
        snapshot.forEach(doc => {
            const item = doc.data();
            const sheetName = item.method === 'onchain' ? 'On-chain' : item.exchange;
            if (!sheetName) return; // Skip if exchange name is missing

            if (!claimsBySheet[sheetName]) {
                claimsBySheet[sheetName] = [];
            }
            
            claimsBySheet[sheetName].push({
                'địa_chỉ_ví': item.claimAddress,
                'số_lượng': item.bmassAmount
            });
        });

        const wb = XLSX.utils.book_new();
        for (const sheetName in claimsBySheet) {
            const ws = XLSX.utils.json_to_sheet(claimsBySheet[sheetName]);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }

        const exportDate = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `bmass-airdrop-claims-${exportDate}.xlsx`);
        
        showAppToast('Thành công', `Đã xuất ${snapshot.size} bản ghi claim.`, 'success');
        adminClaimSettingsStatusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Đã xuất file thành công!</span>`;

    } catch (error) {
        console.error("Error exporting airdrop claim data:", error);
        showAppToast('Lỗi', 'Không thể xuất dữ liệu.', 'error');
        adminClaimSettingsStatusEl.innerHTML = `<span class="text-danger">Xuất file thất bại.</span>`;
    } finally {
        exportClaimExcelBtn.disabled = false;
        setTimeout(() => { adminClaimSettingsStatusEl.innerHTML = ''; }, 4000);
    }
}

async function renderPartnerSection() {
    if (!partnerTasksContainer || !db || !connectedWalletAddress) return;
    partnerTasksContainer.innerHTML = skeletonTx.repeat(3);
    
    try {
        const tasksSnapshot = await db.collection('partner_tasks').orderBy('createdAt', 'desc').get();
        const completedTasksSnapshot = await db.collection('users').doc(connectedWalletAddress).collection('completed_partner_tasks').get();
        
        const completedTaskIds = new Set(completedTasksSnapshot.docs.map(doc => doc.id));
        
        if (tasksSnapshot.empty) {
            partnerTasksContainer.innerHTML = `<p class="text-secondary text-center p-3">No partner tasks available yet.</p>`;
            return;
        }
        
        let mandatoryHtml = '';
        let normalHtml = '';
        
        tasksSnapshot.forEach((doc, index) => {
            const task = doc.data();
            task.id = doc.id;
            const isCompleted = completedTaskIds.has(task.id);
            const isDescLong = task.description.length > 100;

            const cardHtml = `
                <div 
                   class="partner-task-card ${task.taskType === 'mandatory' ? 'mandatory' : ''} ${isCompleted ? 'completed' : ''}"
                   data-task-id="${task.id}" data-exp="${task.expReward}" data-name="${task.projectName}" data-link="${task.taskLink}" style="animation-delay: ${index * 70}ms">
                    
                    <div class="partner-task-top">
                        <img src="${task.imageUrl || GENERIC_TASK_ICON}" class="partner-task-img" onerror="this.src='${GENERIC_TASK_ICON}'">
                        
                        <div class="partner-task-body">
                            <h4 class="partner-task-title">
                                ${task.projectName}
                                ${task.taskType === 'mandatory' ? '<i class="fas fa-star mandatory-icon" title="Mandatory Task"></i>' : ''}
                            </h4>
                            <p class="partner-task-desc">${task.description}</p>
                            ${isDescLong ? '<button class="task-details-toggle">View Details</button>' : ''}
                        </div>
                    </div>
                    
                    <div class="partner-task-action-bar">
                        ${isCompleted ? '<i class="fas fa-check-circle me-2"></i>Completed' : `+${task.expReward.toLocaleString()} EXP`}
                    </div>
                </div>
            `;
            
            if (task.taskType === 'mandatory') {
                mandatoryHtml += cardHtml;
            } else {
                normalHtml += cardHtml;
            }
        });
        
        partnerTasksContainer.innerHTML = mandatoryHtml + normalHtml;
        
    } catch (error) {
        console.error("Error rendering partner tasks:", error);
        partnerTasksContainer.innerHTML = `<p class="text-danger text-center p-3">Error loading partner tasks.</p>`;
    }
}

function handlePartnerCardClick(e) {
    const toggleBtn = e.target.closest('.task-details-toggle');
    const taskCard = e.target.closest('.partner-task-card');

    if (toggleBtn) {
        e.preventDefault();
        e.stopPropagation();

        const desc = toggleBtn.previousElementSibling;
        desc.classList.toggle('expanded');
        toggleBtn.textContent = desc.classList.contains('expanded') ? 'Collapse' : 'View Details';
        return;
    }

    if (taskCard) {
        handlePartnerTaskCompletion(e, taskCard);
    }
}

async function handlePartnerTaskCompletion(e, taskCard) {
    if (airdropSettings?.isSnapshotActive) {
        showAppToast('Halted', 'Point-earning activities are paused.', 'warning');
        e.preventDefault();
        return;
    }
    
    if (taskCard.classList.contains('completed')) {
        e.preventDefault();
        return;
    }

    e.preventDefault();

    const taskId = taskCard.dataset.taskId;
    const expReward = parseInt(taskCard.dataset.exp, 10);
    const projectName = taskCard.dataset.name;
    const taskLink = taskCard.dataset.link;

    if (!taskId || isNaN(expReward)) return;

    const actionBar = taskCard.querySelector('.partner-task-action-bar');
    actionBar.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    
    try {
        const userRef = db.collection('users').doc(connectedWalletAddress);
        const completedTaskRef = userRef.collection('completed_partner_tasks').doc(taskId);
        
        let newTotalPoints;
        await db.runTransaction(async (transaction) => {
            const [userDoc, completedDoc] = await Promise.all([
                transaction.get(userRef),
                transaction.get(completedTaskRef)
            ]);

            if (!userDoc.exists) throw new Error("User not found.");
            if (completedDoc.exists) throw new Error("Task already completed.");

            const userData = userDoc.data();
            newTotalPoints = (userData.points || 0) + expReward;
            const newTimestamp = firebase.firestore.FieldValue.serverTimestamp();

            transaction.update(userRef, {
                points: firebase.firestore.FieldValue.increment(expReward),
                partnerTasksCompletedCount: firebase.firestore.FieldValue.increment(1)
            });
            transaction.set(completedTaskRef, { completedAt: newTimestamp });
            const historyRef = userRef.collection('task_history').doc();
            transaction.set(historyRef, {
                taskName: 'Partner Task',
                projectName: projectName,
                exp: expReward,
                timestamp: newTimestamp
            });
        });
        
        showAppToast('Success!', `You received +${expReward} EXP from the ${projectName} task.`, 'success');
        
        // Update current user data then check for level up
        currentUserData.points = newTotalPoints;
        checkAndUpdateLevel(connectedWalletAddress, newTotalPoints);

        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.openLink(taskLink);
        } else {
            window.open(taskLink, '_blank');
        }
        
        const updatedDoc = await userRef.get();
        currentUserData = updatedDoc.data();
        updateUIAfterLogin(); 
        taskCard.classList.add('completed');
        actionBar.innerHTML = '<i class="fas fa-check-circle me-2"></i>Completed';

    } catch (error) {
        if (error.message.includes("Task already completed.")) {
             taskCard.classList.add('completed');
             actionBar.innerHTML = '<i class="fas fa-check-circle me-2"></i>Completed';
        } else {
            console.error("Failed to complete partner task:", error);
            showAppToast('Error', 'Could not complete the task. Please try again.', 'error');
            actionBar.innerHTML = `+${expReward.toLocaleString()} EXP`; 
        }
    }
}

async function handleAdminPartnerTaskSave(e) {
    e.preventDefault();
    if (!db || !storage) return;

    const taskId = partnerTaskIdInput.value.trim();
    const projectName = document.getElementById('partner-task-name-input').value.trim();
    const description = document.getElementById('partner-task-desc-input').value.trim();
    const imageUpload = document.getElementById('partner-task-img-upload').files;
    const imageUrlInput = document.getElementById('partner-task-img-url').value.trim();
    const taskLink = document.getElementById('partner-task-link-input').value.trim();
    const expReward = parseInt(document.getElementById('partner-task-exp-input').value, 10);
    const taskType = document.getElementById('partner-task-type-select').value;
    
    if (!projectName || !description || !taskLink || isNaN(expReward)) {
        showAppToast('Lỗi', 'Vui lòng điền đầy đủ các trường bắt buộc.', 'error');
        return;
    }
    if (!imageUpload && !imageUrlInput && !taskId) {
         showAppToast('Lỗi', 'Vui lòng tải lên ảnh hoặc cung cấp URL ảnh.', 'error');
        return;
    }

    partnerTaskSaveBtn.disabled = true;
    adminPartnerTaskStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...`;
    
    try {
        let imageUrl = imageUrlInput;
        if (imageUpload) {
            const storageRef = storage.ref(`partner_tasks/${Date.now()}_${imageUpload.name}`);
            const uploadTask = await storageRef.put(imageUpload);
            imageUrl = await uploadTask.ref.getDownloadURL();
        }
        
        const taskData = {
            projectName, description, taskLink, expReward, taskType
        };
        
        if (imageUrl) { taskData.imageUrl = imageUrl; }

        if (taskId) {
            await db.collection('partner_tasks').doc(taskId).update(taskData);
            showAppToast('Thành công', 'Đã cập nhật nhiệm vụ đối tác.', 'success');
        } else {
            taskData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('partner_tasks').add(taskData);
            showAppToast('Thành công', 'Đã thêm nhiệm vụ đối tác mới.', 'success');
        }
        
        clearPartnerTaskForm();
        renderAdminPartnerTasks();

    } catch (error) {
        console.error("Error saving partner task:", error);
        showAppToast('Thất bại', 'Đã xảy ra lỗi khi lưu nhiệm vụ.', 'error');
    } finally {
        partnerTaskSaveBtn.disabled = false;
        adminPartnerTaskStatus.innerHTML = '';
    }
}

function clearPartnerTaskForm() {
    adminPartnerTaskForm.reset();
    partnerTaskIdInput.value = '';
    partnerTaskSaveBtn.textContent = 'Lưu Nhiệm Vụ';
}

async function renderAdminPartnerTasks() {
    if (!adminPartnerTasksList || !db) return;
    adminPartnerTasksList.innerHTML = skeletonTx;
    
    try {
        const snapshot = await db.collection('partner_tasks').orderBy('createdAt', 'desc').get();
        if (snapshot.empty) {
            adminPartnerTasksList.innerHTML = `<p class="text-secondary text-center p-3">Chưa có nhiệm vụ nào.</p>`;
            return;
        }
        
        let tableHtml = `<table class="table table-hover table-sm align-middle" style="font-size: 0.85rem; white-space: normal;">
            <thead><tr>
                <th>Ảnh</th><th>Tên dự án</th><th>Loại</th><th>EXP</th><th>Hành động</th>
            </tr></thead><tbody>`;
        
        snapshot.forEach(doc => {
            const task = doc.data();
            const typeBadge = task.taskType === 'mandatory'
                ? `<span class="badge" style="background-color: var(--gold); color: #000;">Bắt buộc</span>`
                : `<span class="badge bg-secondary">Thường</span>`;
                
            tableHtml += `
                <tr data-id="${doc.id}">
                    <td><img src="${task.imageUrl || GENERIC_TASK_ICON}" class="table-img-preview" onerror="this.src='${GENERIC_TASK_ICON}'"></td>
                    <td style="white-space: normal;"><strong>${task.projectName}</strong><br><small class="text-secondary">${task.description}</small></td>
                    <td>${typeBadge}</td>
                    <td class="fw-bold">${task.expReward.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-light admin-edit-partner-task-btn" title="Chỉnh sửa"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-sm btn-outline-danger admin-delete-partner-task-btn" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table>';
        adminPartnerTasksList.innerHTML = tableHtml;

    } catch (error) {
        console.error("Error rendering admin partner tasks:", error);
        adminPartnerTasksList.innerHTML = `<p class="text-danger text-center p-3">Lỗi tải danh sách nhiệm vụ.</p>`;
    }
}

async function handleAdminPartnerTaskActions(e) {
    const editBtn = e.target.closest('.admin-edit-partner-task-btn');
    const deleteBtn = e.target.closest('.admin-delete-partner-task-btn');

    if (!editBtn && !deleteBtn) return;
    
    const row = e.target.closest('tr');
    const taskId = row.dataset.id;
    
    if (deleteBtn) {
        if (!confirm(`Bạn có chắc chắn muốn xóa nhiệm vụ này?`)) {
            return;
        }
        try {
            await db.collection('partner_tasks').doc(taskId).delete();
            showAppToast('Thành công', 'Đã xóa nhiệm vụ.', 'success');
            renderAdminPartnerTasks();
        } catch (error) {
            console.error("Error deleting partner task:", error);
            showAppToast('Lỗi', 'Không thể xóa nhiệm vụ.', 'error');
        }
    } else if (editBtn) {
        try {
            const docSnap = await db.collection('partner_tasks').doc(taskId).get();
            if (docSnap.exists) {
                const task = docSnap.data();
                partnerTaskIdInput.value = taskId;
                document.getElementById('partner-task-name-input').value = task.projectName || '';
                document.getElementById('partner-task-desc-input').value = task.description || '';
                document.getElementById('partner-task-img-url').value = task.imageUrl || '';
                document.getElementById('partner-task-link-input').value = task.taskLink || '';
                document.getElementById('partner-task-exp-input').value = task.expReward || 0;
                document.getElementById('partner-task-type-select').value = task.taskType || 'normal';
                
                partnerTaskSaveBtn.textContent = 'Cập nhật Nhiệm Vụ';
                adminPartnerTaskForm.scrollIntoView({ behavior: 'smooth' });
            }
        } catch (error) {
            console.error("Error fetching task for edit:", error);
            showAppToast('Lỗi', 'Không thể tải dữ liệu để chỉnh sửa.', 'error');
        }
    }
}

async function handleMaintenanceToggle(e) {
    const isEnabled = e.target.checked;
    const confirmationMessage = isEnabled
        ? "CẢNH BÁO: Bạn sắp bật chế độ bảo trì. Tất cả người dùng sẽ bị chặn truy cập. Tiếp tục?"
        : "Bạn có chắc muốn tắt chế độ bảo trì và cho phép người dùng truy cập lại không?";

    if (!confirm(confirmationMessage)) {
        e.target.checked = !isEnabled; 
        return;
    }
    
    maintenanceModeSwitch.disabled = true;
    adminSystemStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Cập nhật...`;
    try {
        await db.collection('admin_settings').doc('system_status').set({ isMaintenanceMode: isEnabled });
        systemStatus.isMaintenanceMode = isEnabled;
        showAppToast('Thành công', `Chế độ bảo trì đã được ${isEnabled ? 'BẬT' : 'TẮT'}.`, 'success');
        adminSystemStatus.innerHTML = `<span class="text-success">Đã cập nhật thành công!</span>`;
        setTimeout(() => window.location.reload(), 1500);
    } catch (error) {
        console.error("Error updating maintenance mode:", error);
        showAppToast('Lỗi', 'Không thể cập nhật trạng thái hệ thống.', 'error');
        adminSystemStatus.innerHTML = `<span class="text-danger">Cập nhật thất bại.</span>`;
        e.target.checked = !isEnabled;
    } finally {
        maintenanceModeSwitch.disabled = false;
    }
}

// [FIX-BUG] Function to recalculate total users
async function recalculateTotalUsers() {
    if (!db) {
        showAppToast('Lỗi', 'Chưa kết nối cơ sở dữ liệu.', 'error');
        return;
    }
    recalculateUsersBtn.disabled = true;
    recalculateStatusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang đếm...`;

    try {
        const snapshot = await db.collection('users').get();
        const totalUsers = snapshot.size;

        await db.collection('admin_settings').doc('metadata').set({
            userCount: totalUsers
        }, { merge: true });

        recalculateStatusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Hoàn tất! Tổng số người dùng: ${totalUsers.toLocaleString()}</span>`;
        showAppToast('Thành công', `Đã cập nhật tổng số người dùng thành ${totalUsers.toLocaleString()}.`, 'success');

    } catch (error) {
        console.error("Error recalculating users:", error);
        recalculateStatusEl.innerHTML = `<span class="text-danger">Đã xảy ra lỗi: ${error.message}</span>`;
        showAppToast('Thất bại', 'Không thể đếm lại người dùng.', 'error');
    } finally {
        recalculateUsersBtn.disabled = false;
        setTimeout(() => { recalculateStatusEl.innerHTML = ''; }, 5000);
    }
}

// [NEW-FEATURE] Function to handle Audit & Award
async function handleAuditAndAward(e) {
    e.preventDefault();
    if (!db) { showAppToast('Lỗi', 'Chưa kết nối cơ sở dữ liệu.', 'error'); return; }
    if (airdropSettings?.isSnapshotActive) {
        showAppToast('Đã dừng', 'Không thể thưởng EXP sau khi Snapshot.', 'error');
        return;
    }

    const eventId = document.getElementById('admin-audit-event-id').value.trim();
    const conditionType = document.getElementById('admin-audit-condition-type').value;
    const operator = document.getElementById('admin-audit-operator').value;
    const conditionValue = parseInt(document.getElementById('admin-audit-condition-value').value, 10);
    const expAmount = parseInt(document.getElementById('admin-audit-exp-amount').value, 10);
    const taskName = eventId; // Use eventId as task name for history

    if (!eventId || !taskName || isNaN(expAmount) || expAmount <= 0) {
        showAppToast('Lỗi', 'Vui lòng điền đầy đủ và chính xác các trường.', 'error');
        return;
    }

    if (conditionType !== 'all' && isNaN(conditionValue)) {
        showAppToast('Lỗi', 'Vui lòng nhập giá trị điều kiện hợp lệ.', 'error');
        return;
    }
    
    const confirmationMessage = `Bạn có chắc chắn muốn chạy rà soát cho sự kiện "${eventId}" và cộng ${expAmount} EXP cho những người dùng đủ điều kiện nhưng chưa nhận thưởng không? Hành động này KHÔNG THỂ hoàn tác.`;
    if (!confirm(confirmationMessage)) {
        return;
    }

    adminAuditAwardSubmitBtn.disabled = true;
    adminAuditAwardStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Bắt đầu quá trình rà soát...`;

    try {
        let query = db.collection('users');
        if (conditionType !== 'all') {
            query = query.where(conditionType, operator, conditionValue);
        }

        let lastVisible = null;
        let totalProcessed = 0;
        let totalAwarded = 0;
        
        while (true) {
            let batchQuery;
             if (conditionType !== 'all') {
                batchQuery = query.orderBy(conditionType).orderBy(firebase.firestore.FieldPath.documentId()).limit(BATCH_SIZE);
            } else {
                batchQuery = query.orderBy(firebase.firestore.FieldPath.documentId()).limit(BATCH_SIZE);
            }
            
            if (lastVisible) {
                batchQuery = batchQuery.startAfter(lastVisible);
            }
            
            const snapshot = await batchQuery.get();
            if (snapshot.empty) break;
            
            lastVisible = snapshot.docs[snapshot.docs.length - 1];
            
            const usersToProcess = snapshot.docs;
            const newTimestamp = firebase.firestore.FieldValue.serverTimestamp();

            // Process users in the current batch
            for (const userDoc of usersToProcess) {
                const userRef = userDoc.ref;
                const historyCheckQuery = userRef.collection('task_history').where('eventId', '==', eventId).limit(1);
                const historySnapshot = await historyCheckQuery.get();

                if (historySnapshot.empty) {
                    // User hasn't received this award yet, so grant it
                    const userData = userDoc.data();
                    const newTotalPoints = (userData.points || 0) + expAmount;
                    const newLevel = calculateLevel(newTotalPoints);
                    
                    const writeBatch = db.batch();
                    writeBatch.update(userRef, { 
                        points: firebase.firestore.FieldValue.increment(expAmount),
                        level: newLevel
                    });

                    const historyRef = userRef.collection('task_history').doc();
                    writeBatch.set(historyRef, {
                        taskName: taskName,
                        exp: expAmount,
                        timestamp: newTimestamp,
                        eventId: eventId // IMPORTANT: Store the eventId for future checks
                    });

                    await writeBatch.commit();
                    totalAwarded++;
                }
            }

            totalProcessed += snapshot.size;
            adminAuditAwardStatus.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đã xử lý ${totalProcessed} người dùng... Đã thưởng cho ${totalAwarded} người.`;
        }
        
        adminAuditAwardStatus.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Hoàn tất! Đã rà soát ${totalProcessed} người dùng và thưởng bổ sung cho ${totalAwarded} người.</span>`;
        showAppToast('Thành Công', `Đã hoàn tất rà soát.`, 'success');

    } catch (error) {
        console.error("Audit and Award failed:", error);
        adminAuditAwardStatus.innerHTML = `<span class="text-danger">Đã xảy ra lỗi: ${error.message}</span>`;
        showAppToast('Thất bại', `Quá trình rà soát đã thất bại.`, 'error');
    } finally {
        adminAuditAwardSubmitBtn.disabled = false;
    }
}


// --- Event Listeners ---
hamburgerBtn.addEventListener('click', toggleSidebar);
sidebarOverlay.addEventListener('click', toggleSidebar);
fullLogoutBtn.addEventListener('click', handleFullLogout);
disconnectWalletBtn.addEventListener('click', handleDisconnectWallet);
checkinButton.addEventListener('click', handleCheckin);
popupCheckinButton.addEventListener('click', handleCheckin);
if (adminExpForm) adminExpForm.addEventListener('submit', handleAdminExpUpdate);

// [UPDATED] Use the same function for both bulk messaging types
if (sendBulkTelegramMessageBtn) sendBulkTelegramMessageBtn.addEventListener('click', () => sendBulkTelegramMessage(null));

if (adminMassAwardForm) adminMassAwardForm.addEventListener('submit', handleMassAward);
if (adminMassConditionType) {
    adminMassConditionType.addEventListener('change', (e) => {
        adminMassConditionWrapper.style.display = (e.target.value === 'all') ? 'none' : 'block';
    });
}
 // [NEW-FEATURE] Audit form listener
if (adminAuditAwardForm) adminAuditAwardForm.addEventListener('submit', handleAuditAndAward);
if (adminAuditConditionType) {
    adminAuditConditionType.addEventListener('change', (e) => {
        adminAuditConditionWrapper.style.display = (e.target.value === 'all') ? 'none' : 'block';
    });
}

if (adminLoadMoreBtn) adminLoadMoreBtn.addEventListener('click', () => fetchAndRenderAdminUserList(false));
if (adminLoadMoreClaimsBtn) adminLoadMoreClaimsBtn.addEventListener('click', () => fetchAndRenderAdminClaimList(false));
if (adminClaimFilterControls) adminClaimFilterControls.addEventListener('click', (e) => {
    const target = e.target.closest('.app-filter-btn');
    if (target) {
        adminClaimFilterControls.querySelector('.active').classList.remove('active');
        target.classList.add('active');
        fetchAndRenderAdminClaimList(true); // Re-fetch with new filter
    }
});

referralCodeSubmit.addEventListener('click', handleManualReferralInput);
referralCodeSubmitHero.addEventListener('click', handleManualReferralInput);
if(saveScoringSettingsBtn) saveScoringSettingsBtn.addEventListener('click', (e) => { e.preventDefault(); saveAirdropScoringSettings(); });
if(saveClaimSettingsBtn) saveClaimSettingsBtn.addEventListener('click', (e) => { e.preventDefault(); saveAirdropClaimSettings(); });
if(exportClaimExcelBtn) exportClaimExcelBtn.addEventListener('click', exportAirdropClaimData);
if (adminUserSearchInput) {
    adminUserSearchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            fetchAndRenderAdminUserList(true);
        }, 500); 
    });
}

if (partnerTasksContainer) partnerTasksContainer.addEventListener('click', handlePartnerCardClick);
if (adminPartnerTaskForm) adminPartnerTaskForm.addEventListener('submit', handleAdminPartnerTaskSave);
if (partnerTaskClearBtn) partnerTaskClearBtn.addEventListener('click', clearPartnerTaskForm);
if (adminPartnerTasksList) adminPartnerTasksList.addEventListener('click', handleAdminPartnerTaskActions);
if (offchainClaimEnabledSwitch) {
    offchainClaimEnabledSwitch.addEventListener('change', (e) => {
        offchainSettingsContainer.style.display = e.target.checked ? 'block' : 'none';
    });
}

customWalletButton.addEventListener('click', () => { walletDropdown.style.display = walletDropdown.style.display === 'block' ? 'none' : 'block'; });
copyAddressBtn.addEventListener('click', (e) => { e.preventDefault(); const address = e.currentTarget.dataset.address; const textSpan = e.currentTarget.querySelector('span'); if (address) navigator.clipboard.writeText(address).then(() => { textSpan.textContent = 'Copied!'; setTimeout(() => { textSpan.textContent = 'Copy Address'; }, 2000); }); });
searchButton.addEventListener('click', handleFastSearch);
searchInput.addEventListener('keyup', (e) => { clearTimeout(searchTimeout); if (e.key === 'Enter') handleFastSearch(); else searchTimeout = setTimeout(handleFastSearch, 300); });
backToMyWalletBtn.addEventListener('click', () => { if (connectedWalletAddress) fetchAndDisplayAccountData(connectedWalletAddress); });
otherTokensContent.addEventListener('click', (e) => { const jettonItem = e.target.closest('.jetton-item'); if (jettonItem) showJettonDetails(jettonItem.dataset.jettonAddress); });

if (saveEmailBtn) saveEmailBtn.addEventListener('click', handleEmailUpdate);
if (saveTempProfileBtn) saveTempProfileBtn.addEventListener('click', handleTempProfileSave);
if (maintenanceModeSwitch) maintenanceModeSwitch.addEventListener('change', handleMaintenanceToggle);
if (recalculateUsersBtn) recalculateUsersBtn.addEventListener('click', recalculateTotalUsers); // [FIX-BUG]

document.getElementById('temp-avatar-upload').addEventListener('change', (e) => {
    const file = e.target.files;
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('temp-avatar-preview').src = event.target.result;
        };
        reader.readAsDataURL(file);
    }
});

document.body.addEventListener('click', (e) => { 
    const copyAddressTarget = e.target.closest('.copyable-address');
    const copyCodeTarget = e.target.closest('.copyable-code');

    if (copyAddressTarget?.dataset?.address) { 
        const target = copyAddressTarget;
        navigator.clipboard.writeText(target.dataset.address).then(() => { const originalText = target.textContent; target.textContent = 'Copied!'; target.classList.add('copied'); setTimeout(() => { target.textContent = originalText; target.classList.remove('copied'); }, 1500); }); 
    } else if (copyCodeTarget?.dataset?.code) {
         const target = copyCodeTarget;
         navigator.clipboard.writeText(target.dataset.code).then(() => { showAppToast('Success', 'Copied to clipboard!', 'success') }); 
    }
    
    if (!customWalletContainer?.contains(e.target)) walletDropdown.style.display = 'none'; 
    if (!document.getElementById('account-search-section')?.contains(e.target)) searchResultsContainer.style.display = 'none'; 
});

document.body.addEventListener('change', e => {
    if (e.target.id === 'notifications-toggle') {
        handleNotificationToggle(e);
    }
});

[navDashboard, navApps, navTask, navPartner, navLeaderboard, navAccount, navAdmin, navReferral, navAirdrop].forEach(link => link.addEventListener('click', (e) => { if (sidebarMenu.classList.contains('open')) toggleSidebar(); }));
appSearchInput.addEventListener('input', () => { renderApps(); const searchTerm = appSearchInput.value.trim(); const newUrl = searchTerm ? `#apps?search=${encodeURIComponent(searchTerm)}` : '#apps'; history.replaceState(null, '', newUrl); });
appSearchButton.addEventListener('click', renderApps);
appSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') renderApps(); });
appFilterControls.addEventListener('click', (e) => { const target = e.target.closest('.app-filter-btn'); if (target) { appFilterControls.querySelector('.active').classList.remove('active'); target.classList.add('active'); renderApps(); } });
window.addEventListener('hashchange', handleRouteChange);

contactAdminBtn.addEventListener('click', () => contactAdminModal.show());

const heroConnectButton = document.createElement('button');
heroConnectButton.className = 'btn px-5 py-3';
heroConnectButton.style = 'background-color: var(--accent-primary); color: white; font-weight: 600;';
heroConnectButton.textContent = 'Connect Wallet';
heroConnectButton.addEventListener('click', () => tonConnectUI.openModal());
connectWalletHeroBtnContainer.appendChild(heroConnectButton);

function applyPlatformSpecificStyling() {
    if (window.Telegram && window.Telegram.WebApp) {
        const platform = window.Telegram.WebApp.platform;
        const body = document.body;
        body.classList.remove('platform-ios', 'platform-android', 'platform-desktop');
        
        console.log(`Detected platform: ${platform}`);
        switch (platform) {
            case 'ios': body.classList.add('platform-ios'); break;
            case 'android': body.classList.add('platform-android'); break;
            default: body.classList.add('platform-desktop'); break;
        }
    }
}

async function fetchRewardSettings() {
    if (!db) return;
    try {
        const docRef = db.collection('admin_settings').doc('reward_config');
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            if (data.referralMilestones && Array.isArray(data.referralMilestones)) {
                data.referralMilestones.sort((a, b) => a.required - b.required);
            }
            rewardConfig = data;
            console.log("Reward settings loaded from Firestore:", rewardConfig);
        } else {
            await docRef.set(rewardConfig);
            console.log("No reward settings in Firestore, created with defaults.");
        }
    } catch (error) {
        console.error("Error fetching reward settings:", error);
    }
}

function renderRewardSettingsUI() {
    const adminPanel = document.getElementById('admin-panel-reward-settings');
    if (!adminPanel) return;

    document.getElementById('checkin-exp-input').value = rewardConfig.checkinExp;
    document.getElementById('base-referral-exp-input').value = rewardConfig.baseReferralExp;
    
    const container = document.getElementById('referral-milestones-container');
    container.innerHTML = ''; 

    (rewardConfig.referralMilestones || []).forEach((milestone) => {
        addMilestoneRow(milestone.required, milestone.bonus);
    });
}

function addMilestoneRow(required = '', bonus = '') {
    const container = document.getElementById('referral-milestones-container');
    const milestoneDiv = document.createElement('div');
    milestoneDiv.className = 'row g-3 align-items-center mb-2 milestone-item';
    milestoneDiv.innerHTML = `
        <div class="col">
            <label class="form-label small d-md-none">Mốc (lượt mời)</label>
            <input type="number" class="form-control milestone-required" value="${required}" placeholder="Số lượt mời" min="1">
        </div>
        <div class="col">
            <label class="form-label small d-md-none">Thưởng thêm (EXP)</label>
            <input type="number" class="form-control milestone-bonus" value="${bonus}" placeholder="EXP thưởng thêm" min="0">
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-sm btn-outline-danger remove-milestone-btn mt-md-4"><i class="fas fa-trash"></i></button>
        </div>
    `;
    container.appendChild(milestoneDiv);
}

// ===================================================================
// [NEW] LEVEL SETTINGS FUNCTIONS
// ===================================================================

async function fetchLevelConfig() {
    if (!db) return;
    try {
        const docRef = db.collection('admin_settings').doc('level_config');
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            if (data.levels && Array.isArray(data.levels)) {
                levelConfig = data.levels.sort((a, b) => a.level - b.level);
                console.log("Level config loaded from Firestore:", levelConfig);
            }
        } else {
            // If not found, save the default config to Firestore
            await docRef.set({ levels: levelConfig });
            console.log("No level config in Firestore, created with defaults.");
        }
    } catch (error) {
        console.error("Error fetching level config, using defaults:", error);
    }
}

function renderLevelSettingsUI() {
    const adminPanel = document.getElementById('admin-panel-level-settings');
    if (!adminPanel) return;

    const container = document.getElementById('level-settings-container');
    container.innerHTML = ''; // Clear existing rows

    (levelConfig || []).forEach((levelData) => {
        addLevelRow(levelData);
    });
}

// [NEW] Render Level Multipliers in Airdrop Settings
function renderLevelMultipliersUI(savedMultipliers = []) {
    const container = document.getElementById('admin-level-multipliers-container');
    container.innerHTML = '';

    levelConfig.forEach(levelInfo => {
        const savedData = savedMultipliers.find(m => m.level === levelInfo.level);
        const multiplierValue = savedData ? savedData.multiplier : 1.0;

        const row = document.createElement('div');
        row.className = 'row g-3 align-items-center mb-2 level-multiplier-item';
        row.dataset.level = levelInfo.level;
        row.innerHTML = `
            <div class="col-4">
                <label class="form-label mb-0">Level ${levelInfo.level}</label>
            </div>
            <div class="col-8">
                <div class="input-group">
                    <span class="input-group-text">x</span>
                    <input type="number" class="form-control" value="${multiplierValue}" step="0.1" min="0">
                </div>
            </div>
        `;
        container.appendChild(row);
    });
}

// [NEW] Render Exchange Checkboxes in Admin Panel
function renderAdminExchangeCheckboxes(enabledExchanges = []) {
    const container = document.getElementById('exchange-checkboxes-container');
    container.innerHTML = '';
    exchanges.forEach(ex => {
        const isChecked = enabledExchanges.includes(ex.id);
        container.innerHTML += `
             <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${ex.id}" id="ex-check-${ex.id}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="ex-check-${ex.id}">
                    ${ex.name}
                </label>
            </div>
        `;
    });
}


function addLevelRow(levelData = {}) {
    const container = document.getElementById('level-settings-container');
    const levelDiv = document.createElement('div');
    levelDiv.className = 'row g-3 align-items-center mb-3 level-item';
    
    const currentLevel = levelData.level || (container.children.length + 1);
    const expRequired = levelData.expRequired ?? '';
    const benefit = levelData.benefit ?? '';

    levelDiv.innerHTML = `
        <div class="col-2 col-md-1">
            <input type="number" class="form-control text-center level-number" value="${currentLevel}" readonly>
        </div>
        <div class="col-5 col-md-4">
            <div class="input-group">
                <span class="input-group-text">EXP ≥</span>
                <input type="number" class="form-control level-exp" value="${expRequired}" placeholder="EXP yêu cầu" min="0">
            </div>
        </div>
        <div class="col-5 col-md-6">
             <input type="text" class="form-control level-benefit" value="${benefit}" placeholder="Mô tả quyền lợi">
        </div>
        <div class="col-12 col-md-1 text-end">
            <button type="button" class="btn btn-sm btn-outline-danger remove-level-btn"><i class="fas fa-trash"></i></button>
        </div>
    `;
    container.appendChild(levelDiv);
    
    // Disable editing for Level 1
    if (currentLevel === 1) {
        levelDiv.querySelector('.level-exp').readOnly = true;
        levelDiv.querySelector('.remove-level-btn').style.display = 'none';
    }
}

function renumberLevels() {
    const items = document.querySelectorAll('#level-settings-container .level-item');
    items.forEach((item, index) => {
        const levelInput = item.querySelector('.level-number');
        levelInput.value = index + 1;
    });
}


// --- Event Listeners specific to new features ---

document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'add-milestone-btn') {
        addMilestoneRow();
    }
    if (e.target && e.target.closest('.remove-milestone-btn')) {
        e.target.closest('.milestone-item').remove();
    }
    
    // [NEW] Level Settings Listeners
    if (e.target && e.target.id === 'add-level-btn') {
        addLevelRow();
    }
    if (e.target && e.target.closest('.remove-level-btn')) {
        e.target.closest('.level-item').remove();
        renumberLevels();
    }
    
    const adminNavButton = e.target.closest('#admin-nav-tabs .nav-link');
    if (adminNavButton) {
        const targetId = adminNavButton.dataset.target;
        if (!targetId) return;

        document.querySelectorAll('#admin-nav-tabs .nav-link').forEach(btn => btn.classList.remove('active'));
        adminNavButton.classList.add('active');

        document.querySelectorAll('.admin-panel-wrapper').forEach(panel => {
            panel.style.display = 'none';
        });

        const targetPanel = document.querySelector(targetId);
        if (targetPanel) {
            targetPanel.style.display = 'block';
            // Trigger render functions when a tab is shown
            if (targetId === '#admin-panel-reward-settings') {
                renderRewardSettingsUI();
            } else if (targetId === '#admin-panel-level-settings') {
                renderLevelSettingsUI();
            } else if (targetId === '#admin-panel-users') {
                fetchAndRenderAdminUserList(true);
            } else if (targetId === '#admin-panel-claim-list') { // [NEW]
                renderAdminClaimFilters();
                fetchAndRenderAdminClaimList(true);
            } else if (targetId === '#admin-panel-partner-tasks') {
                renderAdminPartnerTasks();
            } else if (targetId === '#admin-panel-airdrop') {
                // Re-fetch and render settings when tab is clicked
                fetchAirdropSettings().then(settings => {
                     if (!settings) return;
                     renderLevelMultipliersUI(settings.levelMultipliers);
                     renderAdminExchangeCheckboxes(settings.enabledExchanges || []);
                     offchainSettingsContainer.style.display = document.getElementById('offchain-claim-enabled-switch').checked ? 'block' : 'none';
                });
            }
        }
    }
});

document.addEventListener('submit', async (e) => {
    if (e.target && e.target.id === 'admin-reward-settings-form') {
        e.preventDefault();
        const saveBtn = document.getElementById('save-reward-settings-btn');
        const statusEl = document.getElementById('admin-reward-settings-status');
        
        saveBtn.disabled = true;
        statusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...`;

        const newSettings = {
            checkinExp: parseInt(document.getElementById('checkin-exp-input').value, 10) || 0,
            baseReferralExp: parseInt(document.getElementById('base-referral-exp-input').value, 10) || 0,
            referralMilestones: []
        };

        document.querySelectorAll('.milestone-item').forEach(item => {
            const required = parseInt(item.querySelector('.milestone-required').value, 10);
            const bonus = parseInt(item.querySelector('.milestone-bonus').value, 10);
            if (!isNaN(required) && required > 0 && !isNaN(bonus)) {
                newSettings.referralMilestones.push({ required, bonus });
            }
        });
        
        newSettings.referralMilestones.sort((a,b) => a.required - b.required);

        try {
            await db.collection('admin_settings').doc('reward_config').set(newSettings);
            rewardConfig = newSettings; 
            statusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Đã lưu cài đặt!</span>`;
            showAppToast('Thành công', 'Cài đặt thưởng đã được cập nhật.', 'success');
        } catch (error) {
            console.error("Error saving reward settings:", error);
            statusEl.innerHTML = `<span class="text-danger">Lỗi: ${error.message}</span>`;
        } finally {
            saveBtn.disabled = false;
            setTimeout(() => { statusEl.innerHTML = ''; }, 4000);
        }
    }
    
    // [NEW] Level Settings Form Submission
    if (e.target && e.target.id === 'admin-level-settings-form') {
        e.preventDefault();
        const saveBtn = document.getElementById('save-level-settings-btn');
        const statusEl = document.getElementById('admin-level-settings-status');
        
        saveBtn.disabled = true;
        statusEl.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...`;

        const newLevels = [];
        let isValid = true;
        let lastExp = -1;

        document.querySelectorAll('.level-item').forEach(item => {
            const level = parseInt(item.querySelector('.level-number').value, 10);
            const expRequired = parseInt(item.querySelector('.level-exp').value, 10);
            const benefit = item.querySelector('.level-benefit').value.trim();
            
            if (isNaN(level) || isNaN(expRequired)) {
                isValid = false;
            }
            
            if (level > 1 && expRequired <= lastExp) {
                showAppToast('Lỗi Cấu hình', `EXP yêu cầu cho Level ${level} phải lớn hơn Level ${level - 1}.`, 'error');
                isValid = false;
            }
            lastExp = expRequired;

            newLevels.push({ 
                level, 
                expRequired, 
                benefit,
                shieldClass: `level-shield-${level}` // Auto-generate shield class
            });
        });
        
        if (!isValid) {
             statusEl.innerHTML = `<span class="text-danger">Dữ liệu không hợp lệ. Vui lòng kiểm tra lại.</span>`;
             saveBtn.disabled = false;
             return;
        }

        try {
            await db.collection('admin_settings').doc('level_config').set({ levels: newLevels });
            levelConfig = newLevels; // Update local config
            statusEl.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-2"></i>Đã lưu cài đặt level!</span>`;
            showAppToast('Thành công', 'Cấu hình level đã được cập nhật.', 'success');
        } catch (error) {
            console.error("Error saving level settings:", error);
            statusEl.innerHTML = `<span class="text-danger">Lỗi: ${error.message}</span>`;
        } finally {
            saveBtn.disabled = false;
            setTimeout(() => { statusEl.innerHTML = ''; }, 4000);
        }
    }
});

// --- App Initialization ---
fetchCryptoNews();
initializeApp();


});
</script>

</body>
</html>
