<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEURALIS - The VIEC Experience</title>

    <!-- Meta SEO -->
    <meta name="description" content="NEURALIS: Trải nghiệm Web3 đỉnh cao. Giao diện tương lai kết hợp với sức mạnh của tonapi.io để quản lý tài sản TON của bạn một cách trực quan và đẹp mắt.">
    <link rel="icon" href="https://duccodedao.github.io/VIEC/img/logo.png" type="image/png">

    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050816;
            --card-color: rgba(23, 27, 48, 0.5);
            --border-color: rgba(145, 94, 255, 0.2);
            --accent-primary: #915EFF;
            --accent-secondary: #2BCBC4;
            --text-primary: #f1f2f6;
            --text-secondary: #aaa6c3;
            --color-in: #2BCBC4;
            --color-out: #ff6b6b;
            --color-failed: #ffcc00;
            --color-verified: #2ecc71;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            background: linear-gradient(-45deg, #050816, #120e2a, #1a163c, #0d0b1f);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow-x: hidden;
            font-size: 16px;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .main-container { max-width: 1400px; padding: 2rem 1rem; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 2rem; }
        .header-logo { display: flex; align-items: center; text-decoration: none; color: var(--text-primary); gap: 10px; }
        .header-logo img { height: 40px; width: 40px; object-fit: cover; transition: all 0.3s ease; }
        .header-logo span { font-size: 1.1rem; font-weight: 600; }
        
        .card-glass { background: var(--card-color); border: 1px solid var(--border-color); border-radius: 20px; padding: 1.5rem; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: all 0.3s ease; height: 100%; }
        .card-glass:hover { transform: translateY(-5px); box-shadow: 0 0 25px rgba(145, 94, 255, 0.3); border-color: var(--accent-primary); }
        .card-title { font-weight: 600; margin-bottom: 1.5rem; font-size: 1.25rem; }
        
        .hero-section { text-align: center; padding: 4rem 0; }
        .hero-section h1 { font-size: 2.5rem; font-weight: 700; }
        .hero-section .highlight { color: var(--accent-primary); }

        .skeleton-loader { background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size: 200% 100%; border-radius: 8px; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-line { height: 20px; margin-bottom: 10px; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        .activity-item-icon, .jetton-item-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .amount-in { color: var(--color-in); }
        .amount-out { color: var(--color-out); }
        .status-icon { font-size: 0.7rem; margin-right: 6px; }
        .status-ok { color: var(--color-in); }
        .status-failed { color: var(--color-failed); }
        .verified-tick { color: var(--color-verified); margin-left: 5px; font-size: 0.9em; }

        .jetton-item { cursor: pointer; transition: background-color 0.2s; border-radius: 8px; }
        .jetton-item:hover { background-color: rgba(145, 94, 255, 0.1); }

        #custom-wallet-button { background: var(--accent-primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; }
        #wallet-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 5px); background-color: #171b30; border: 1px solid var(--border-color); border-radius: 8px; z-index: 1056; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        #wallet-dropdown a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; }
        #wallet-dropdown a:hover { background-color: rgba(145, 94, 255, 0.2); }
        #wallet-dropdown a i { margin-right: 10px; width: 15px; text-align: center; }
        
        #search-results-container { max-height: 40vh; overflow-y: auto; }
        .search-result-item { cursor: pointer; padding: 10px; border-radius: 8px; transition: background-color 0.2s ease; }
        .search-result-item:hover { background-color: rgba(145, 94, 255, 0.1); }
        .search-result-item img { width: 32px; height: 32px; border-radius: 50%; }

        /* Modal Styles */
        .modal-content { background-color: #0c0f24; border: 1px solid var(--border-color); color: var(--text-primary); }
        .modal-header { border-bottom: 1px solid var(--border-color); }
        .modal-footer { border-top: 1px solid var(--border-color); }
        .modal-backdrop.show { opacity: 0.7; backdrop-filter: blur(5px); }
        .nav-tabs { border-bottom-color: var(--border-color); }
        .nav-tabs .nav-link { background: transparent; border-color: transparent; color: var(--text-secondary); }
        .nav-tabs .nav-link.active { color: var(--accent-primary); background-color: rgba(145, 94, 255, 0.1); border-color: var(--border-color); }
        .tab-content { max-height: 50vh; overflow-y: auto; }
        .metadata-key { color: var(--text-secondary); font-weight: 500; }

        @media (min-width: 768px) {
            .hero-section h1 { font-size: 3.5rem; }
            .card-glass { padding: 2rem; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <header class="header">
            <a href="#" class="header-logo" id="app-logo-container">
                <img id="app-logo-img" src="https://duccodedao.github.io/VIEC/img/logo_viewc.png" alt="App Logo">
                <span id="app-logo-text"></span>
            </a>
            <div class="position-relative">
                <div id="ton-connect-button-root"></div>
                <div id="custom-wallet-button-container" style="display: none;">
                    <button id="custom-wallet-button"></button>
                    <div id="wallet-dropdown">
                        <a href="#" id="copy-address-btn"><i class="fas fa-copy"></i><span>Copy Address</span></a>
                        <a href="#" id="disconnect-btn"><i class="fas fa-sign-out-alt"></i>Disconnect</a>
                    </div>
                </div>
            </div>
        </header>

        <main id="dashboard" style="display: none;">
            <div id="account-search-section" class="mb-4">
                <div class="input-group">
                    <input type="text" id="account-search-input" class="form-control" placeholder="Search by name or paste an address" style="background-color: rgba(23, 27, 48, 0.8); border-color: var(--border-color); color: var(--text-primary); border-right: 0;">
                    <button id="account-search-button" class="btn" style="background-color: rgba(23, 27, 48, 0.8); border-color: var(--border-color); color: var(--accent-primary);"><i class="fas fa-search"></i></button>
                </div>
                <div id="search-results-container" class="mt-2 card-glass" style="padding: 1rem; display: none;"></div>
            </div>

             <div class="row g-4">
                <div class="col-lg-7">
                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="card-glass">
                                <h5 class="card-title d-flex justify-content-between align-items-center">
                                    <span>Core Assets</span>
                                    <button id="back-to-my-wallet-btn" class="btn btn-sm" style="display: none; background-color: var(--accent-secondary); color: white;">
                                        <i class="fas fa-arrow-left me-1"></i> Back to My Wallet
                                    </button>
                                </h5>
                                <div id="main-assets-content"></div>
                            </div>
                        </div>
                        <div class="col-md-12"><div class="card-glass"><h5 class="card-title">NFT Gallery</h5><div id="nft-gallery-content" style="max-height: 420px; overflow-y: auto;"></div></div></div>
                    </div>
                </div>
                <div class="col-lg-5">
                     <div class="row g-4">
                         <div class="col-12"><div class="card-glass"><h5 class="card-title">Token Portfolio</h5><div id="other-tokens-content" style="max-height: 250px; overflow-y: auto; padding-right: 10px;"></div></div></div>
                        <div class="col-12"><div class="card-glass"><h5 class="card-title">Activity Feed</h5><div id="activity-feed-content" style="max-height: 525px; overflow-y: auto; padding-right: 10px;"></div></div></div>
                     </div>
                </div>
            </div>
        </main>
        
        <section id="hero-section" class="hero-section">
            <div class="container">
                <h1 class="mb-4">Welcome to the <span class="highlight">Neuralis</span><br/>Web3 Experience</h1>
                <p class="lead text-secondary col-md-8 mx-auto mb-4">Connect your wallet to visualize your assets and interact with the VIEC ecosystem in a stunning, next-generation interface.</p>
                <button id="connect-wallet-hero-btn" class="btn px-5 py-3" style="background-color: var(--accent-primary); color: white; font-weight: 600;">Connect Wallet</button>
            </div>
        </section>

        <!-- Crypto News Feed Section, initially hidden -->
        <section id="crypto-news-feed" style="display:none;">
            <h2 class="card-title" style="font-size: 1.75rem; text-align: center; margin-bottom: 2rem;">Latest Crypto News</h2>
            <div id="news-content-area"></div>
        </section>
    </div>

    <!-- Jetton Details Modal -->
    <div class="modal fade" id="jettonDetailModal" tabindex="-1" aria-labelledby="jettonDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <div id="jetton-modal-header-content" class="d-flex align-items-center">
                <!-- Header content will be injected here -->
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="jettonDetailTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata-tab-pane" type="button" role="tab">Metadata</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button" role="tab">History</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="holders-tab" data-bs-toggle="tab" data-bs-target="#holders-tab-pane" type="button" role="tab">Holders</button>
              </li>
            </ul>
            <div class="tab-content pt-3" id="jettonDetailTabContent">
              <div class="tab-pane fade show active" id="metadata-tab-pane" role="tabpanel"></div>
              <div class="tab-pane fade" id="history-tab-pane" role="tabpanel"></div>
              <div class="tab-pane fade" id="holders-tab-pane" role="tabpanel"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const TON_API_BASE = 'https://tonapi.io/v2';
        const dashboardEl = document.getElementById('dashboard');
        const heroEl = document.getElementById('hero-section');
        const connectWalletHeroBtn = document.getElementById('connect-wallet-hero-btn');
        const mainAssetsContent = document.getElementById('main-assets-content');
        const activityFeedContent = document.getElementById('activity-feed-content');
        const otherTokensContent = document.getElementById('other-tokens-content');
        const nftGalleryContent = document.getElementById('nft-gallery-content');
        const newsSection = document.getElementById('crypto-news-feed');
        const newsContentArea = document.getElementById('news-content-area');

        const tonConnectButtonRoot = document.getElementById('ton-connect-button-root');
        const customWalletContainer = document.getElementById('custom-wallet-button-container');
        const customWalletButton = document.getElementById('custom-wallet-button');
        const walletDropdown = document.getElementById('wallet-dropdown');
        const copyAddressBtn = document.getElementById('copy-address-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');

        const appLogoImg = document.getElementById('app-logo-img');
        const appLogoText = document.getElementById('app-logo-text');
        const DEFAULT_LOGO_SRC = 'https://duccodedao.github.io/VIEC/img/logo_viewc.png';

        const searchInput = document.getElementById('account-search-input');
        const searchButton = document.getElementById('account-search-button');
        const searchResultsContainer = document.getElementById('search-results-container');
        const backToMyWalletBtn = document.getElementById('back-to-my-wallet-btn');

        const jettonDetailModalEl = document.getElementById('jettonDetailModal');
        const jettonDetailModal = new bootstrap.Modal(jettonDetailModalEl);

        let telegramUserData = null;
        let connectedWalletAddress = null;

        const skeletonAsset = `<div class="d-flex align-items-center justify-content-between mb-3"><div class="d-flex align-items-center"><div class="skeleton-loader me-3" style="width: 40px; height: 40px; border-radius: 50%;"></div><div><div class="skeleton-loader skeleton-line w-50"></div><div class="skeleton-loader skeleton-line" style="width: 80px;"></div></div></div><div class="skeleton-loader skeleton-line" style="width: 100px;"></div></div>`;
        const skeletonTx = `<div class="d-flex align-items-center mb-3"><div class="skeleton-loader me-3" style="width: 40px; height: 40px; border-radius: 50%;"></div><div style="flex-grow: 1;"><div class="skeleton-loader skeleton-line"></div><div class="skeleton-loader skeleton-line w-50"></div></div></div>`;

        // --- Init ---
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    telegramUserData = tg.initDataUnsafe.user;
                }
            }
        } catch (e) { console.error("Could not initialize Telegram Web App:", e); }

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://duccodedao.github.io/VIEC/tonconnect-manifest.json', buttonRootId: 'ton-connect-button-root' });
        connectWalletHeroBtn.addEventListener('click', () => tonConnectUI.openModal());
        
        // --- Core Functions ---
        const showDashboard = (show) => {
            dashboardEl.style.display = show ? 'block' : 'none';
            heroEl.style.display = show ? 'none' : 'flex';
            newsSection.style.display = show ? 'block' : 'none';
        };
        const setSkeletonLoaders = () => {
            mainAssetsContent.innerHTML = skeletonAsset + skeletonAsset;
            otherTokensContent.innerHTML = skeletonAsset.repeat(3);
            nftGalleryContent.innerHTML = `<div class="row g-2"><div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 12px;"></div></div><div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 12px;"></div></div><div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 12px;"></div></div><div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 12px;"></div></div></div>`;
            activityFeedContent.innerHTML = skeletonTx.repeat(5);
        };

        const shortenAddress = (addr, start = 4, end = 4) => addr ? (addr.includes('.') ? addr : `${addr.slice(0, start)}...${addr.slice(-end)}`) : 'Unknown';
        const getRaw = (addrObj) => addrObj?.raw_form || (typeof addrObj?.address === 'string' ? addrObj.address : null);
        const getDisplayAddress = (addrObj) => addrObj?.bounceable?.address || addrObj?.name || getRaw(addrObj) || 'Unknown Address';
        
        async function fetchAndDisplayAccountData(addressToFetch) {
            setSkeletonLoaders();
            searchResultsContainer.style.display = 'none';
            searchInput.value = '';

            backToMyWalletBtn.style.display = (connectedWalletAddress && addressToFetch !== connectedWalletAddress) ? 'block' : 'none';

            try {
                const [accountRes, jettonsRes, nftsRes, eventsRes] = await Promise.all([
                    fetch(`${TON_API_BASE}/accounts/${addressToFetch}`),
                    fetch(`${TON_API_BASE}/accounts/${addressToFetch}/jettons`),
                    fetch(`${TON_API_BASE}/accounts/${addressToFetch}/nfts?limit=100&indirect_ownership=false`),
                    fetch(`${TON_API_BASE}/accounts/${addressToFetch}/events?limit=100`)
                ]);
                
                if (!accountRes.ok) throw new Error('Could not fetch account info.');
                
                const accountInfo = await accountRes.json();
                const jettonsInfo = jettonsRes.ok ? await jettonsRes.json() : { balances: [] };
                const nftsInfo = nftsRes.ok ? await nftsRes.json() : { nft_items: [] };
                const eventsInfo = eventsRes.ok ? await eventsRes.json() : { events: [] };

                const userFriendlyAddress = getDisplayAddress(accountInfo);
                const validLogs = (eventsInfo.events ?? []).flatMap(event => parseEvent(event, addressToFetch, userFriendlyAddress));
                
                renderMainAssets(accountInfo);
                renderOtherTokens(jettonsInfo.balances ?? []);
                renderNFTs(nftsInfo.nft_items ?? []);
                renderActivity(validLogs);
            } catch (error) {
                console.error("Error fetching account data:", error);
                mainAssetsContent.innerHTML = `<p class="text-danger"><strong>Error:</strong> Could not load data for this account. It might be uninitialized.</p>`;
                otherTokensContent.innerHTML = `<p class="text-secondary">Data unavailable.</p>`;
                nftGalleryContent.innerHTML = `<p class="text-secondary">Data unavailable.</p>`;
                activityFeedContent.innerHTML = `<p class="text-secondary">Data unavailable.</p>`;
            }
        }
        
        // --- Rendering Functions ---
        const renderMainAssets = (accountInfo) => {
            if (!accountInfo) { mainAssetsContent.innerHTML = `<p class="text-danger">Could not load account data.</p>`; return; }
            mainAssetsContent.innerHTML = `<div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center"><img src="https://ton.org/download/ton_symbol.png" class="me-3" style="width: 48px;">
                    <div><h5 class="m-0">TON</h5><p class="m-0 text-secondary">The Open Network</p></div></div>
                <h4 class="m-0">${Number((accountInfo.balance / 1e9).toPrecision(6))}</h4></div>`;
            const userFriendlyAddress = getDisplayAddress(accountInfo);
            if (userFriendlyAddress) {
                 mainAssetsContent.innerHTML += `<div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-wallet me-3" style="width: 48px; font-size: 24px; text-align: center; color: var(--accent-secondary);"></i>
                        <div><h5 class="m-0">Address</h5><p class="m-0 text-secondary">Viewing Wallet</p></div>
                    </div>
                    <h6 class="m-0" style="font-family: monospace; cursor: help;" title="${userFriendlyAddress}">${shortenAddress(userFriendlyAddress)}</h6>
                </div>`;
            }
        };
        const renderOtherTokens = (jettons) => {
            otherTokensContent.innerHTML = '';
            if (jettons && jettons.length > 0) {
                jettons.forEach(j => {
                    const displayBalance = Number((Number(BigInt(j.balance)) / (10 ** (j.jetton.decimals || 9))).toPrecision(15));
                    const verifiedTick = j.jetton.verification === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
                    otherTokensContent.innerHTML += `<div class="d-flex align-items-center justify-content-between mb-3 p-2 jetton-item" data-jetton-address="${j.jetton.address}">
                        <div class="d-flex align-items-center"><img src="${j.jetton.image}" class="me-3 jetton-item-img">
                        <div><h6 class="m-0">${j.jetton.symbol}${verifiedTick}</h6></div></div><h6 class="m-0">${displayBalance.toLocaleString('en-US')}</h6></div>`;
                });
            } else { otherTokensContent.innerHTML = `<p class="text-secondary">No tokens found.</p>`; }
        };
        const renderNFTs = (nfts) => {
            nftGalleryContent.innerHTML = '';
            if (nfts && nfts.length > 0) {
                let html = '<div class="row g-2">';
                nfts.slice(0, 18).forEach(nft => {
                    const imgUrl = nft.previews?.[nft.previews.length - 1]?.url || nft.metadata?.image || 'https://via.placeholder.com/100';
                    html += `<div class="col-3"><div title="${nft.metadata?.name || 'NFT'}" style="cursor: pointer;">
                               <img src="${imgUrl}" style="width: 100%; border-radius: 12px; aspect-ratio: 1/1; object-fit: cover;" onerror="this.src='https://via.placeholder.com/100'">
                             </div></div>`;
                });
                html += '</div>';
                nftGalleryContent.innerHTML = html;
            } else { nftGalleryContent.innerHTML = `<p class="text-secondary">No NFTs found.</p>`; }
        };
        const renderActivity = (validLogs) => { /* ... Function remains the same ... */ };

        // --- Event Listeners & Handlers ---
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet) {
                connectedWalletAddress = wallet.account.address; 
                if (telegramUserData) {
                    appLogoImg.src = telegramUserData.photo_url || DEFAULT_LOGO_SRC;
                    appLogoImg.style.borderRadius = '50%';
                    appLogoText.textContent = `@${telegramUserData.username}` || 'Telegram User';
                } else {
                    appLogoImg.src = DEFAULT_LOGO_SRC; // Or your specific BMASS logo
                    appLogoImg.style.borderRadius = '0';
                    appLogoText.textContent = 'Bmass Wallet';
                }
                showDashboard(true);
                fetchCryptoNews();
                await fetchAndDisplayAccountData(connectedWalletAddress);
                const friendlyAddress = shortenAddress(wallet.account.address);
                tonConnectButtonRoot.style.display = 'none';
                customWalletContainer.style.display = 'block';
                customWalletButton.textContent = friendlyAddress;
                copyAddressBtn.dataset.address = wallet.account.address;
            } else {
                connectedWalletAddress = null;
                showDashboard(false);
                tonConnectButtonRoot.style.display = 'block';
                customWalletContainer.style.display = 'none';
                appLogoImg.src = DEFAULT_LOGO_SRC;
                appLogoImg.style.borderRadius = '0';
                appLogoText.textContent = '';
            }
        });
        
        customWalletButton.addEventListener('click', () => { walletDropdown.style.display = walletDropdown.style.display === 'block' ? 'none' : 'block'; });
        disconnectBtn.addEventListener('click', (e) => { e.preventDefault(); tonConnectUI.disconnect(); walletDropdown.style.display = 'none'; });
        copyAddressBtn.addEventListener('click', (e) => { /* ... Function remains the same ... */ });
        window.addEventListener('click', (e) => { 
            if (!customWalletContainer.contains(e.target)) { walletDropdown.style.display = 'none'; } 
            if (!document.getElementById('account-search-section').contains(e.target)) {
                searchResultsContainer.style.display = 'none';
            }
        });

        // --- Search Functionality ---
        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) { searchResultsContainer.style.display = 'none'; return; }
            const isAddress = (query.length === 48 && (query.startsWith('UQ') || query.startsWith('EQ'))) || (query.length === 66 && query.includes(':'));
            if (isAddress) {
                fetchAndDisplayAccountData(query);
            } else {
                searchResultsContainer.style.display = 'block';
                searchResultsContainer.innerHTML = `<div class="p-2 text-center text-secondary">${skeletonTx}</div>`;
                try {
                    const response = await fetch(`${TON_API_BASE}/accounts/search?name=${query}`);
                    if (!response.ok) throw new Error('Search failed');
                    const data = await response.json();
                    searchResultsContainer.innerHTML = ''; 
                    if (data.addresses && data.addresses.length > 0) {
                        data.addresses.forEach(acc => {
                            const item = document.createElement('div');
                            item.className = 'd-flex align-items-center p-2 mb-1 search-result-item';
                            item.dataset.address = acc.address;
                            const verifiedTick = acc.trust === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
                            item.innerHTML = `
                                <img src="${acc.preview}" class="me-3" onerror="this.src='https://ton.org/download/ton_symbol.png'"/>
                                <div class="flex-grow-1">
                                    <p class="m-0 fw-bold">${acc.name || 'Unnamed'} ${verifiedTick}</p>
                                    <p class="m-0 text-secondary" style="font-family: monospace; font-size: 0.8rem;">${shortenAddress(acc.address)}</p>
                                </div>`;
                            item.addEventListener('click', () => { fetchAndDisplayAccountData(item.dataset.address); });
                            searchResultsContainer.appendChild(item);
                        });
                    } else {
                        searchResultsContainer.innerHTML = '<p class="text-secondary text-center p-3">No accounts found.</p>';
                    }
                } catch (error) { console.error('Error during account search:', error); searchResultsContainer.innerHTML = '<p class="text-danger text-center p-3">Search failed.</p>'; }
            }
        }
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearch(); });
        backToMyWalletBtn.addEventListener('click', () => { if (connectedWalletAddress) { fetchAndDisplayAccountData(connectedWalletAddress); } });

        // --- Jetton Details Modal Logic ---
        otherTokensContent.addEventListener('click', (e) => {
            const jettonItem = e.target.closest('.jetton-item');
            if (jettonItem) {
                const jettonAddress = jettonItem.dataset.jettonAddress;
                showJettonDetails(jettonAddress);
            }
        });

        async function showJettonDetails(jettonAddress) {
            // Show modal and loading state
            jettonDetailModal.show();
            const headerEl = document.getElementById('jetton-modal-header-content');
            const metadataEl = document.getElementById('metadata-tab-pane');
            const historyEl = document.getElementById('history-tab-pane');
            const holdersEl = document.getElementById('holders-tab-pane');
            
            const loadingHtml = `<div class="w-100 text-center p-5">${skeletonTx}</div>`;
            headerEl.innerHTML = `<h5 class="modal-title">Loading Jetton...</h5>`;
            metadataEl.innerHTML = loadingHtml;
            historyEl.innerHTML = loadingHtml;
            holdersEl.innerHTML = loadingHtml;

            // Fetch all data concurrently
            const [metadataRes, historyRes, holdersRes] = await Promise.allSettled([
                fetch(`${TON_API_BASE}/jettons/${jettonAddress}`),
                fetch(`${TON_API_BASE}/jettons/${jettonAddress}/history?limit=50`),
                fetch(`${TON_API_BASE}/jettons/${jettonAddress}/holders?limit=50`)
            ]);

            // Render Metadata
            if (metadataRes.status === 'fulfilled' && metadataRes.value.ok) {
                const data = await metadataRes.value.json();
                const metadata = data.metadata;
                const verifiedTick = metadata.verification === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
                headerEl.innerHTML = `
                    <img src="${metadata.image}" class="me-3 jetton-item-img" onerror="this.src='https://ton.org/download/ton_symbol.png'">
                    <h5 class="modal-title">${metadata.name} (${metadata.symbol}) ${verifiedTick}</h5>`;
                
                metadataEl.innerHTML = `
                    <p class="mb-3">${metadata.description || 'No description available.'}</p>
                    <div class="row g-3">
                        <div class="col-12"><span class="metadata-key">Address:</span> <code class="fs-sm">${metadata.address}</code></div>
                        <div class="col-md-6"><span class="metadata-key">Decimals:</span> ${metadata.decimals}</div>
                        <div class="col-md-6"><span class="metadata-key">Mintable:</span> ${data.mintable ? 'Yes' : 'No'}</div>
                        <div class="col-12"><span class="metadata-key">Total Supply:</span> ${Number(Number(BigInt(data.total_supply)) / (10 ** metadata.decimals)).toLocaleString('en-US')} ${metadata.symbol}</div>
                    </div>
                `;
            } else {
                metadataEl.innerHTML = `<p class="text-danger">Failed to load metadata.</p>`;
            }

            // Render History
            if (historyRes.status === 'fulfilled' && historyRes.value.ok) {
                const data = await historyRes.value.json();
                historyEl.innerHTML = '';
                if(data.events && data.events.length > 0) {
                    data.events.forEach(event => {
                       // Simplified history view
                       const action = event.actions[0];
                       if (!action) return;
                       let detail = 'Unknown transaction';
                       if(action.type === 'JettonTransfer' && action.JettonTransfer) {
                           const t = action.JettonTransfer;
                           detail = `Transfer <strong>${(Number(BigInt(t.amount)) / 1e9).toLocaleString()}</strong> from ${shortenAddress(t.sender.address)} to ${shortenAddress(t.recipient.address)}`;
                       } else if(action.type === 'JettonMint' && action.JettonMint) {
                           detail = `Mint to ${shortenAddress(action.JettonMint.recipient.address)}`;
                       }
                       historyEl.innerHTML += `<div class="d-flex justify-content-between p-2 border-bottom border-secondary border-opacity-25">
                            <small>${detail}</small>
                            <small class="text-secondary">${new Date(event.timestamp * 1000).toLocaleString()}</small>
                       </div>`;
                    });
                } else {
                    historyEl.innerHTML = `<p class="text-secondary text-center p-3">No transaction history found.</p>`;
                }
            } else {
                 historyEl.innerHTML = `<p class="text-danger">Failed to load history.</p>`;
            }

            // Render Holders
            if (holdersRes.status === 'fulfilled' && holdersRes.value.ok) {
                const data = await holdersRes.value.json();
                holdersEl.innerHTML = '';
                if(data.owners && data.owners.length > 0) {
                     data.owners.forEach(holder => {
                        holdersEl.innerHTML += `<div class="d-flex justify-content-between p-2 border-bottom border-secondary border-opacity-25">
                            <small><code>${shortenAddress(holder.address, 6, 6)}</code></small>
                            <small><strong>${(Number(BigInt(holder.balance)) / 1e9).toLocaleString()}</strong></small>
                       </div>`;
                    });
                } else {
                     holdersEl.innerHTML = `<p class="text-secondary text-center p-3">No holders found.</p>`;
                }
            } else {
                holdersEl.innerHTML = `<p class="text-danger">Failed to load holders.</p>`;
            }
        }

        // --- Data Parsers ---
        function parseEvent(event, userRawAddress, userFriendlyAddress) { /* ... Function remains the same ... */ }

        // --- News Fetcher ---
        async function fetchCryptoNews() { /* ... Function remains the same, but now called upon login ... */ }

        // Initial call if not logged in
        if (!tonConnectUI.connected) {
            fetchCryptoNews();
            newsSection.style.display = 'block';
        }

        // Make functions globally accessible if needed for inline JS, though it's better to avoid it.
        // For this structure, no global functions are needed. All event listeners handle the calls.
    });
    </script>
</body>
</html>
