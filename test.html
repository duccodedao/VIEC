<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON DEX Lite Demo (Updated)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 550px;
            box-sizing: border-box;
            text-align: center;
        }
        h1 {
            color: #007bff;
            margin-bottom: 30px;
            font-weight: 700;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .section h2 {
            color: #007bff;
            margin-top: 0;
            font-size: 1.4em;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            text-align: left;
        }
        input[type="text"],
        input[type="number"],
        select {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: white;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            margin-top: 10px;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            word-break: break-all; /* Allow long messages to wrap */
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #walletInfo {
            font-size: 0.95em;
            margin-top: 15px;
            text-align: left;
        }
        #walletAddressDisplay, #walletBalanceDisplay {
            font-weight: 700;
            word-break: break-all;
        }
        #walletBalanceDisplay {
            color: #28a745;
        }
        .swap-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .swap-inputs > div {
            flex: 1;
        }
        .swap-inputs input, .swap-inputs select {
            margin-bottom: 0;
            width: calc(100% - 2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TON DEX Lite Demo (Updated)</h1>

        <div class="section" id="connectWalletSection">
            <h2>Kết nối ví TON</h2>
            <button id="connectWalletBtn">Kết nối ví (Tonkeeper / MyTonWallet)</button>
            <div id="walletInfo" style="display: none;">
                <p>Địa chỉ ví: <span id="walletAddressDisplay"></span></p>
                <p>Số dư TON: <span id="walletBalanceDisplay"></span></p>
                <button id="disconnectWalletBtn" class="btn-secondary">Ngắt kết nối ví</button>
            </div>
            <p class="message" id="connectionMessage"></p>
        </div>

        <div class="section" id="dexFunctions" style="display: none;">
            <h2>Swap Token</h2>
            <p style="font-size: 0.85em; color: #666;">
                *Đây là giao diện minh họa. Hợp đồng AMM thực tế cần được triển khai trên TON.
                Giao dịch này sẽ gửi một tin nhắn nội bộ đến địa chỉ AMM giả định.
            </p>

            <label for="fromAmount">Bạn muốn đổi:</label>
            <div class="swap-inputs">
                <input type="number" id="fromAmount" step="0.001" placeholder="0.0">
                <select id="fromToken">
                    <option value="TON">TON</option>
                    </select>
            </div>

            <label for="toAmount">Bạn sẽ nhận được (ước tính):</label>
            <div class="swap-inputs">
                <input type="number" id="toAmount" step="0.001" placeholder="0.0" disabled>
                <select id="toToken">
                    <option value="FakeJetton">FakeJetton</option>
                </select>
            </div>

            <button id="swapBtn">Swap Now</button>
            <p class="message" id="swapMessage"></p>
        </div>
    </div>

    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <script>
        // --- CẤU HÌNH ---
        // Địa chỉ AMM Smart Contract giả định trên Testnet.
        // TRONG THỰC TẾ, ĐÂY PHẢI LÀ ĐỊA CHỈ HỢP ĐỒNG AMM CỦA BẠN ĐÃ TRIỂN KHAI.
        const AMM_CONTRACT_ADDRESS = 'EQDk_XjY48E4o3u47tqPj6d1r1C3Vw7hP2Z7sN0o9a2w3L4p'; // Một địa chỉ testnet ngẫu nhiên
        const TON_API_URL = 'https://testnet.toncenter.com/api/v2/jsonRPC'; // Sử dụng Testnet
        
        // MANIFEST URL: CỰC KỲ QUAN TRỌNG CHO TON CONNECT
        // Đây là một file JSON mô tả ứng dụng của bạn cho ví.
        // Nó phải được host trên một máy chủ công khai và an toàn (HTTPS).
        // Thay thế URL này bằng URL manifest của riêng bạn.
        // Ví dụ này sử dụng manifest mẫu từ TON Connect SDK, có thể cần cập nhật tùy theo phiên bản và mục đích sử dụng.
        const MANIFEST_URL = 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client_side_deeplinks/tonconnect-manifest.json';


        // --- GLOBAL VARIABLES ---
        const tonweb = new TonWeb(new TonWeb.HttpProvider(TON_API_URL));
        let tonConnectUI = null;
        let walletConnected = false;
        let userAddress = null;

        // --- DOM Elements ---
        const connectWalletSection = document.getElementById('connectWalletSection');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddressDisplay = document.getElementById('walletAddressDisplay');
        const walletBalanceDisplay = document.getElementById('walletBalanceDisplay');
        const connectionMessage = document.getElementById('connectionMessage');

        const dexFunctions = document.getElementById('dexFunctions');
        const fromAmountInput = document.getElementById('fromAmount');
        const fromTokenSelect = document.getElementById('fromToken');
        const toAmountInput = document.getElementById('toAmount');
        const toTokenSelect = document.getElementById('toToken');
        const swapBtn = document.getElementById('swapBtn');
        const swapMessage = document.getElementById('swapMessage');

        // --- Helper Functions ---
        function displayMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
        }

        function hideMessage(element) {
            element.textContent = '';
            element.className = 'message';
            element.style.display = 'none';
        }

        async function updateWalletInfo() {
            if (tonConnectUI && tonConnectUI.connected) {
                walletConnected = true;
                userAddress = tonConnectUI.account.address;
                walletAddressDisplay.textContent = userAddress;
                walletInfo.style.display = 'block';
                dexFunctions.style.display = 'block';
                connectWalletBtn.style.display = 'none'; // Ẩn nút kết nối khi đã kết nối
                disconnectWalletBtn.style.display = 'block'; // Hiển thị nút ngắt kết nối

                // Lấy số dư TON
                try {
                    // Để lấy số dư, chúng ta cần một đối tượng TonWeb.Wallet
                    // Tuy nhiên, tonConnectUI.account không cung cấp secretKey,
                    // nên chúng ta chỉ có thể query số dư bằng địa chỉ.
                    const wallet = new TonWeb.Experimental.Wallet({
                        address: new TonWeb.utils.Address(userAddress),
                        tonweb: tonweb
                    });
                    const balanceNano = await wallet.getBalance();
                    const balanceTon = TonWeb.utils.fromNano(balanceNano);
                    walletBalanceDisplay.textContent = `${parseFloat(balanceTon).toFixed(4)} TON`;
                    hideMessage(connectionMessage);
                } catch (error) {
                    console.error("Lỗi khi lấy số dư ví:", error);
                    walletBalanceDisplay.textContent = "Lỗi khi lấy số dư.";
                    displayMessage(connectionMessage, `Lỗi khi lấy số dư: ${error.message}`, 'error');
                }
            } else {
                walletConnected = false;
                walletInfo.style.display = 'none';
                dexFunctions.style.display = 'none';
                connectWalletBtn.style.display = 'block'; // Hiển thị lại nút kết nối
                disconnectWalletBtn.style.display = 'none'; // Ẩn nút ngắt kết nối
                userAddress = null;
                walletBalanceDisplay.textContent = '';
            }
        }

        // --- TON Connect Integration ---
        async function initTonConnect() {
            if (!window.TonConnectUI) {
                displayMessage(connectionMessage, "Thư viện TON Connect UI SDK không được tải. Vui lòng kiểm tra kết nối mạng hoặc thử lại.", 'error');
                return;
            }

            try {
                // Khởi tạo TonConnectUI
                tonConnectUI = new TonConnectUI.TonConnectUI({
                    manifestUrl: MANIFEST_URL,
                    // Bạn có thể thêm các tùy chọn khác tại đây nếu cần
                });

                // Lắng nghe trạng thái kết nối
                tonConnectUI.onStatusChange(async (wallet) => {
                    if (wallet) {
                        displayMessage(connectionMessage, `Đã kết nối với ví: ${wallet.account.address}`, 'success');
                    } else {
                        displayMessage(connectionMessage, "Ví đã bị ngắt kết nối.", 'error');
                    }
                    await updateWalletInfo(); // Cập nhật giao diện dựa trên trạng thái kết nối
                });

                // Cố gắng tự động khôi phục kết nối nếu có session cũ
                await tonConnectUI.restoreConnection();
                await updateWalletInfo(); // Cập nhật giao diện sau khi khôi phục
            } catch (error) {
                console.error("Lỗi khởi tạo TON Connect UI:", error);
                displayMessage(connectionMessage, `Lỗi khởi tạo TON Connect UI: ${error.message}. Đảm bảo manifestUrl đúng và có thể truy cập.`, 'error');
            }
        }

        // --- Swap Logic (Minh họa) ---
        async function handleSwap() {
            hideMessage(swapMessage);
            if (!walletConnected || !userAddress) {
                displayMessage(swapMessage, "Vui lòng kết nối ví trước khi swap.", 'error');
                return;
            }

            const fromAmount = parseFloat(fromAmountInput.value);
            const fromToken = fromTokenSelect.value;
            const toToken = toTokenSelect.value;

            if (isNaN(fromAmount) || fromAmount <= 0) {
                displayMessage(swapMessage, "Số lượng không hợp lệ.", 'error');
                return;
            }

            if (fromToken === toToken) {
                displayMessage(swapMessage, "Không thể swap cùng một loại token.", 'error');
                return;
            }

            // Ước tính số lượng nhận được (chỉ là minh họa, không phải tính toán AMM thực tế)
            let estimatedReceiveAmount = fromAmount * 0.99; 

            displayMessage(swapMessage, `Đang chuẩn bị giao dịch swap ${fromAmount} ${fromToken} lấy ${toToken}...`, 'success');
            swapBtn.disabled = true;

            try {
                const amountInNano = TonWeb.utils.toNano(fromAmount.toString());

                // Payload cho giao dịch swap
                // Đây là một ví dụ MINH HỌA về cấu trúc payload
                // Payload thực tế sẽ PHỤ THUỘC vào thiết kế smart contract AMM của bạn
                // Thường sẽ là một Cell để định nghĩa loại giao dịch, số lượng tối thiểu nhận được, v.v.
                const payload = new TonWeb.boc.Builder()
                    .storeUint(0x1, 32) // Opcode cho swap (giả định)
                    .storeUint(0, 64)   // Query ID (giả định)
                    .storeAddress(new TonWeb.utils.Address(userAddress)) // Địa chỉ người nhận sau swap
                    .endCell(); // Thêm các tham số khác tùy theo hợp đồng AMM của bạn

                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 300, // Giao dịch hợp lệ trong 5 phút
                    messages: [
                        {
                            address: AMM_CONTRACT_ADDRESS, // Địa chỉ hợp đồng AMM của bạn (giả định)
                            amount: amountInNano.toString(), // Số lượng TON gửi đi (nếu swap từ TON)
                            payload: payload.toBoc().toString('base64'), // Payload đã mã hóa thành base64
                        },
                    ],
                };

                // Gửi giao dịch thông qua ví của người dùng bằng TON Connect UI
                const result = await tonConnectUI.sendTransaction(transaction);

                displayMessage(swapMessage, `Swap thành công! TX BOC Hash: ${result.boc.slice(0, 30)}...\nKiểm tra trên explorer.`, 'success');
                fromAmountInput.value = '';
                toAmountInput.value = '';
                await updateWalletInfo(); // Cập nhật số dư sau swap
            } catch (error) {
                console.error("Lỗi khi swap:", error);
                if (error.message.includes('User rejected the transaction')) {
                     displayMessage(swapMessage, "Người dùng đã từ chối giao dịch.", 'error');
                } else if (error.message.includes('Invalid address') || error.message.includes('Invalid wallet address')) {
                    displayMessage(swapMessage, "Địa chỉ hợp đồng AMM không hợp lệ. Vui lòng kiểm tra lại cấu hình hoặc đảm bảo đây là địa chỉ ví TON hợp lệ.", 'error');
                }
                else {
                     displayMessage(swapMessage, `Lỗi khi swap: ${error.message}`, 'error');
                }
            } finally {
                swapBtn.disabled = false;
            }
        }

        // --- Event Listeners ---
        connectWalletBtn.addEventListener('click', async () => {
            if (tonConnectUI) {
                try {
                    // Gọi tonConnectUI.connectWallet() để hiển thị modal kết nối ví
                    await tonConnectUI.connectWallet();
                } catch (error) {
                    console.error("Lỗi khi gọi connectWallet:", error);
                    displayMessage(connectionMessage, `Không thể mở cửa sổ kết nối ví: ${error.message}. Đảm bảo bạn đã cài đặt ví TON (như Tonkeeper) và trình duyệt cho phép pop-up.`, 'error');
                }
            } else {
                displayMessage(connectionMessage, "TON Connect UI SDK chưa được khởi tạo. Vui lòng thử tải lại trang.", 'error');
            }
        });

        disconnectWalletBtn.addEventListener('click', async () => {
            if (tonConnectUI) {
                await tonConnectUI.disconnect();
                displayMessage(connectionMessage, "Đã ngắt kết nối ví.", 'success');
            }
        });

        swapBtn.addEventListener('click', handleSwap);

        // Simple estimation for demo (not real AMM calculation)
        fromAmountInput.addEventListener('input', () => {
            const amount = parseFloat(fromAmountInput.value);
            if (!isNaN(amount) && amount > 0) {
                toAmountInput.value = (amount * 0.99).toFixed(3); // Giả định 1% phí
            } else {
                toAmountInput.value = '';
            }
        });


        // Khởi tạo TON Connect UI khi DOM đã tải hoàn chỉnh
        document.addEventListener('DOMContentLoaded', initTonConnect);
    </script>
</body>
</html>
