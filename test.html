<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My TON Connect Wallet</title>
    <script src="https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1, h2 {
            color: #007bff;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        input[type="text"], input[type="number"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .jetton-item, .collectible-item, .transaction-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .jetton-item strong, .collectible-item strong, .transaction-item strong {
            color: #333;
            margin-right: 5px;
        }

        .jetton-logo, .nft-image {
            width: 40px; /* Nhỏ hơn một chút cho logo */
            height: 40px;
            object-fit: contain; /* Để logo không bị méo */
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .nft-image {
            object-fit: cover; /* Giữ nguyên cover cho NFT */
        }

        .status-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .transaction-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Ví TON Connect của tôi</h1>
        <div id="ton-connect-button"></div>
    </header>

    <main>
        <section id="wallet-info" style="display: none;">
            <h2>Thông tin Ví</h2>
            <p><strong>Địa chỉ:</strong> <span id="walletAddress"></span></p>
            <p><strong>Số dư (TON):</strong> <span id="tonBalance"></span></p>
            <button id="disconnectWallet">Ngắt kết nối</button>
        </section>

        <section id="send-ton" style="display: none;">
            <h2>Gửi TON</h2>
            <input type="text" id="sendToAddress" placeholder="Địa chỉ người nhận (vd: kQB....)" value="">
            <input type="number" id="sendAmount" placeholder="Số lượng TON (vd: 0.1)" step="0.000000001">
            <button id="sendTonButton">Gửi TON</button>
            <p id="sendTonStatus" class="status-message"></p>
        </section>

        <section id="jetton-list" style="display: none;">
            <h2>Jetton của bạn</h2>
            <div id="jettonsContainer">
                <p>Vui lòng kết nối ví để xem Jetton.</p>
            </div>
        </section>

        <section id="collectibles-history" style="display: none;">
            <h2>Lịch sử Sưu tầm (NFTs)</h2>
            <div id="collectiblesContainer">
                <p>Vui lòng kết nối ví để xem Sưu tầm.</p>
            </div>
        </section>

        <section id="transaction-history" style="display: none;">
            <h2>Lịch sử Giao dịch</h2>
            <div id="transactionsContainer">
                <p>Vui lòng kết nối ví để xem lịch sử giao dịch.</p>
            </div>
        </section>

    </main>

    <script>
        // Khởi tạo TON Connect UI
        // BẠN PHẢI thay thế 'https://your-app-domain.com/tonconnect-manifest.json'
        // bằng URL thực tế nơi file tonconnect-manifest.json của bạn được lưu trữ.
        // Đối với phát triển cục bộ, bạn có thể cần một máy chủ web cục bộ.
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://your-app-domain.com/tonconnect-manifest.json', // !!! QUAN TRỌNG: Cập nhật URL này !!!
            buttonRootId: 'ton-connect-button'
        });

        const walletInfoSection = document.getElementById('wallet-info');
        const walletAddressSpan = document.getElementById('walletAddress');
        const tonBalanceSpan = document.getElementById('tonBalance');
        const disconnectWalletButton = document.getElementById('disconnectWallet');

        const jettonListSection = document.getElementById('jetton-list');
        const jettonsContainer = document.getElementById('jettonsContainer');

        const collectiblesHistorySection = document.getElementById('collectibles-history');
        const collectiblesContainer = document.getElementById('collectiblesContainer');

        const transactionHistorySection = document.getElementById('transaction-history');
        const transactionsContainer = document.getElementById('transactionsContainer');

        const sendTonSection = document.getElementById('send-ton');
        const sendToAddressInput = document.getElementById('sendToAddress');
        const sendAmountInput = document.getElementById('sendAmount');
        const sendTonButton = document.getElementById('sendTonButton');
        const sendTonStatus = document.getElementById('sendTonStatus');

        // Hàm định dạng địa chỉ để hiển thị
        function formatAddress(address) {
            if (!address) return 'N/A';
            // Ví dụ: EQCD39VS...xqB2N
            return `${address.substring(0, 8)}...${address.substring(address.length - 8)}`;
        }

        // Hàm cập nhật thông báo trạng thái
        function setStatusMessage(element, message, type = '') {
            element.textContent = message;
            element.className = 'status-message'; // Đặt lại các lớp
            if (type === 'success') {
                element.classList.add('status-success');
            } else if (type === 'error') {
                element.classList.add('status-error');
            }
        }

        // Hàm lấy và hiển thị thông tin ví
        async function fetchWalletInfo(address) {
            try {
                const response = await fetch(`https://tonapi.io/v2/accounts/${address}`);
                if (!response.ok) throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                const data = await response.json();

                // Hiển thị số dư TON
                const balanceNano = data.balance; // Số dư tính bằng nanotons
                tonBalanceSpan.textContent = `${(balanceNano / 1e9).toFixed(4)} TON`; // Chuyển đổi sang TON

                // Hiển thị các phần
                walletInfoSection.style.display = 'block';
                jettonListSection.style.display = 'block';
                collectiblesHistorySection.style.display = 'block';
                transactionHistorySection.style.display = 'block';
                sendTonSection.style.display = 'block';

            } catch (error) {
                console.error('Lỗi khi lấy thông tin ví:', error);
                tonBalanceSpan.textContent = 'Lỗi tải số dư.';
                setStatusMessage(sendTonStatus, `Lỗi tải thông tin ví: ${error.message}`, 'error');
            }
        }

        // Hàm lấy và hiển thị Jetton
        async function fetchJettons(address) {
            jettonsContainer.innerHTML = '<p>Đang tải Jetton...</p>';
            try {
                const response = await fetch(`https://tonapi.io/v2/accounts/${address}/jettons`);
                if (!response.ok) throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                const data = await response.json();

                if (data.balances && data.balances.length > 0) {
                    jettonsContainer.innerHTML = ''; // Xóa thông báo tải
                    data.balances.forEach(jetton => {
                        const jettonDiv = document.createElement('div');
                        jettonDiv.classList.add('jetton-item');
                        const balance = parseFloat(jetton.balance) / (10 ** jetton.jetton.decimals);
                        const logoUrl = jetton.jetton.image; // Lấy logo từ trường image

                        jettonDiv.innerHTML = `
                            <img src="${logoUrl || 'https://via.placeholder.com/40?text=Jetton'}" alt="${jetton.jetton.name || 'Jetton'}" class="jetton-logo">
                            <div>
                                <strong>${jetton.jetton.symbol || 'N/A'}</strong>: ${balance.toFixed(Math.min(jetton.jetton.decimals, 6))} (${jetton.jetton.name || 'Không xác định'})
                            </div>
                        `;
                        jettonsContainer.appendChild(jettonDiv);
                    });
                } else {
                    jettonsContainer.innerHTML = '<p>Không tìm thấy Jetton nào cho địa chỉ này.</p>';
                }
            } catch (error) {
                console.error('Lỗi khi lấy Jetton:', error);
                jettonsContainer.innerHTML = '<p>Lỗi tải Jetton.</p>';
            }
        }

        // Hàm lấy và hiển thị lịch sử Sưu tầm (NFTs)
        async function fetchCollectiblesHistory(address) {
            collectiblesContainer.innerHTML = '<p>Đang tải Sưu tầm...</p>';
            try {
                const response = await fetch(`https://tonapi.io/v2/accounts/${address}/nfts`);
                if (!response.ok) throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                const data = await response.json();

                if (data.nft_items && data.nft_items.length > 0) {
                    collectiblesContainer.innerHTML = ''; // Xóa thông báo tải
                    data.nft_items.forEach(nft => {
                        const nftDiv = document.createElement('div');
                        nftDiv.classList.add('collectible-item');

                        let imageUrl = 'https://via.placeholder.com/50?text=NFT'; // Mặc định ảnh giữ chỗ
                        if (nft.previews && nft.previews.length > 0) {
                            // Ưu tiên ảnh preview lớn nhất có thể
                            const largePreview = nft.previews.find(p => p.resolution === '1080x1080' || p.resolution === '720x720');
                            imageUrl = largePreview ? largePreview.url : nft.previews[0].url;
                        } else if (nft.metadata && nft.metadata.image) {
                            // Thử lấy từ metadata nếu có
                            imageUrl = nft.metadata.image;
                        }

                        nftDiv.innerHTML = `
                            <img src="${imageUrl}" alt="${nft.metadata.name || 'NFT Image'}" class="nft-image" onerror="this.onerror=null;this.src='https://via.placeholder.com/50?text=Error';">
                            <div>
                                <strong>${nft.metadata.name || 'NFT không tên'}</strong>
                                <p>Bộ sưu tập: ${nft.collection.name || 'Không xác định'}</p>
                            </div>
                        `;
                        collectiblesContainer.appendChild(nftDiv);
                    });
                } else {
                    collectiblesContainer.innerHTML = '<p>Không tìm thấy Sưu tầm nào cho địa chỉ này.</p>';
                }
            } catch (error) {
                console.error('Lỗi khi lấy Sưu tầm:', error);
                collectiblesContainer.innerHTML = '<p>Lỗi tải Sưu tầm. Vui lòng thử lại sau.</p>';
            }
        }

        // Hàm lấy và hiển thị lịch sử giao dịch (TON và Jetton)
        async function fetchTransactionHistory(address) {
            transactionsContainer.innerHTML = '<p>Đang tải lịch sử giao dịch...</p>';
            try {
                // Lấy các giao dịch cho địa chỉ
                const response = await fetch(`https://tonapi.io/v2/accounts/${address}/transactions?limit=20`); // Lấy 20 giao dịch gần nhất
                if (!response.ok) throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                const data = await response.json();

                if (data.transactions && data.transactions.length > 0) {
                    transactionsContainer.innerHTML = ''; // Xóa thông báo tải
                    data.transactions.forEach(tx => {
                        const txDiv = document.createElement('div');
                        txDiv.classList.add('transaction-item');

                        const date = new Date(tx.utime * 1000).toLocaleString(); // Chuyển đổi timestamp sang ngày giờ
                        let transactionType = 'Unknown';
                        let amount = 'N/A';
                        let asset = 'TON';
                        let direction = '';
                        let counterparty = '';

                        // Xác định loại giao dịch (TON hoặc Jetton) và hướng
                        if (tx.in_msg && tx.in_msg.value) { // Incoming TON transaction
                            amount = (parseInt(tx.in_msg.value) / 1e9).toFixed(4);
                            direction = 'Nhận';
                            counterparty = formatAddress(tx.in_msg.source || 'N/A');
                            transactionType = `Nhận TON từ ${counterparty}`;
                        } else if (tx.out_msgs && tx.out_msgs.length > 0 && tx.out_msgs[0].value) { // Outgoing TON transaction
                            amount = (parseInt(tx.out_msgs[0].value) / 1e9).toFixed(4);
                            direction = 'Gửi';
                            counterparty = formatAddress(tx.out_msgs[0].destination || 'N/A');
                            transactionType = `Gửi TON tới ${counterparty}`;
                        }

                        // Kiểm tra các giao dịch Jetton nếu có
                        if (tx.out_msgs) {
                            for (const msg of tx.out_msgs) {
                                if (msg.decoded_body && msg.decoded_body.type === 'JettonTransfer') {
                                    const transfer = msg.decoded_body;
                                    amount = (parseInt(transfer.amount) / (10 ** transfer.jetton_info.decimals)).toFixed(Math.min(transfer.jetton_info.decimals, 6));
                                    asset = transfer.jetton_info.symbol || 'Jetton';
                                    direction = 'Gửi';
                                    counterparty = formatAddress(transfer.destination || 'N/A');
                                    transactionType = `Gửi ${amount} ${asset} tới ${counterparty}`;
                                    break; // Chỉ xử lý giao dịch jetton đầu tiên trong một tin nhắn ra
                                }
                            }
                        }
                        if (tx.in_msg && tx.in_msg.decoded_body && tx.in_msg.decoded_body.type === 'JettonTransfer') {
                            const transfer = tx.in_msg.decoded_body;
                            amount = (parseInt(transfer.amount) / (10 ** transfer.jetton_info.decimals)).toFixed(Math.min(transfer.jetton_info.decimals, 6));
                            asset = transfer.jetton_info.symbol || 'Jetton';
                            direction = 'Nhận';
                            counterparty = formatAddress(transfer.source || 'N/A');
                            transactionType = `Nhận ${amount} ${asset} từ ${counterparty}`;
                        }


                        txDiv.innerHTML = `
                            <strong>${transactionType}</strong>
                            <div class="transaction-details">
                                <p>Ngày: ${date}</p>
                                <p>Hash: ${tx.hash.substring(0, 15)}...</p>
                                <p>Hướng: ${direction}</p>
                                <p>Số lượng: ${amount} ${asset}</p>
                            </div>
                        `;
                        transactionsContainer.appendChild(txDiv);
                    });
                } else {
                    transactionsContainer.innerHTML = '<p>Không tìm thấy giao dịch nào cho địa chỉ này.</p>';
                }
            } catch (error) {
                console.error('Lỗi khi lấy lịch sử giao dịch:', error);
                transactionsContainer.innerHTML = '<p>Lỗi tải lịch sử giao dịch. Vui lòng thử lại sau.</p>';
            }
        }

        // Xử lý thay đổi trạng thái kết nối ví
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet && wallet.account) {
                const connectedAddress = wallet.account.address;
                walletAddressSpan.textContent = formatAddress(connectedAddress);
                console.log('Ví đã kết nối:', connectedAddress);

                // Lấy và hiển thị dữ liệu ví
                await fetchWalletInfo(connectedAddress);
                await fetchJettons(connectedAddress);
                await fetchCollectiblesHistory(connectedAddress);
                await fetchTransactionHistory(connectedAddress); // Lấy lịch sử giao dịch

            } else {
                // Ví đã ngắt kết nối hoặc chưa kết nối
                console.log('Ví đã ngắt kết nối.');
                walletInfoSection.style.display = 'none';
                jettonListSection.style.display = 'none';
                collectiblesHistorySection.style.display = 'none';
                transactionHistorySection.style.display = 'none'; // Ẩn lịch sử giao dịch
                sendTonSection.style.display = 'none';
                
                walletAddressSpan.textContent = 'N/A';
                tonBalanceSpan.textContent = 'N/A';
                jettonsContainer.innerHTML = '<p>Vui lòng kết nối ví để xem Jetton.</p>';
                collectiblesContainer.innerHTML = '<p>Vui lòng kết nối ví để xem Sưu tầm.</p>';
                transactionsContainer.innerHTML = '<p>Vui lòng kết nối ví để xem lịch sử giao dịch.</p>'; // Đặt lại thông báo
                setStatusMessage(sendTonStatus, '', ''); // Xóa trạng thái gửi
            }
        });

        // Lắng nghe sự kiện click nút ngắt kết nối
        disconnectWalletButton.addEventListener('click', () => {
            tonConnectUI.disconnect();
            setStatusMessage(sendTonStatus, '', ''); // Xóa trạng thái gửi khi ngắt kết nối
        });

        // Chức năng gửi TON
        sendTonButton.addEventListener('click', async () => {
            const recipientAddress = sendToAddressInput.value.trim();
            const amountTon = parseFloat(sendAmountInput.value);

            if (!recipientAddress || !amountTon || isNaN(amountTon) || amountTon <= 0) {
                setStatusMessage(sendTonStatus, 'Vui lòng nhập địa chỉ người nhận hợp lệ và số lượng dương.', 'error');
                return;
            }

            if (!tonConnectUI.wallet) {
                setStatusMessage(sendTonStatus, 'Vui lòng kết nối ví trước.', 'error');
                return;
            }

            // Chuyển đổi TON sang nanotons
            const amountNano = Math.round(amountTon * 1e9);

            try {
                setStatusMessage(sendTonStatus, 'Đang gửi giao dịch...', '');
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60, // Hiệu lực 60 giây
                    messages: [
                        {
                            address: recipientAddress,
                            amount: amountNano.toString(),
                        }
                    ]
                };

                const result = await tonConnectUI.sendTransaction(transaction);
                console.log('Giao dịch đã gửi:', result);
                setStatusMessage(sendTonStatus, `Giao dịch đã gửi thành công! TXID: ${result.boc.substring(0, 30)}...`, 'success');
                
                // Tùy chọn: Cập nhật số dư và lịch sử sau khi giao dịch thành công
                if (tonConnectUI.wallet && tonConnectUI.wallet.account) {
                    const connectedAddress = tonConnectUI.wallet.account.address;
                    await fetchWalletInfo(connectedAddress);
                    await fetchTransactionHistory(connectedAddress);
                }

            } catch (error) {
                console.error('Lỗi khi gửi giao dịch:', error);
                let errorMessage = 'Không thể gửi giao dịch.';
                if (error.message.includes('User rejected the transaction')) {
                    errorMessage = 'Giao dịch bị người dùng từ chối.';
                } else if (error.message.includes('Invalid address')) {
                    errorMessage = 'Địa chỉ người nhận không hợp lệ.';
                }
                setStatusMessage(sendTonStatus, `${errorMessage} Chi tiết: ${error.message}`, 'error');
            }
        });

        // Kiểm tra ban đầu nếu ví đã kết nối khi tải trang
        if (tonConnectUI.wallet && tonConnectUI.wallet.account) {
            tonConnectUI.onStatusChange((wallet) => {
                if (wallet && wallet.account) {
                    const connectedAddress = wallet.account.address;
                    walletAddressSpan.textContent = formatAddress(connectedAddress);
                    fetchWalletInfo(connectedAddress);
                    fetchJettons(connectedAddress);
                    fetchCollectiblesHistory(connectedAddress);
                    fetchTransactionHistory(connectedAddress);
                }
            }, true); // Tham số `true` sẽ gọi lại callback ngay lập tức nếu ví đã kết nối.
        }
    </script>
</body>
</html>
