<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Swap TON ‚Üí Jetton VIEC</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ton/core@0.0.6-alpha.2/dist/index.umd.js"></script>
</head>
<body>
  <h2>üîÑ G·ª≠i 0.005 TON ƒë·ªÉ nh·∫≠n 1000 VIEC</h2>

  <div id="ton-connect" style="margin-bottom: 10px;"></div>
  <button id="swap" disabled>‚ö° G·ª≠i 0.005 TON</button>

  <script>
    const { beginCell, toNano, Address } = window["@ton/core"];

    const TON_AMOUNT = toNano("0.005"); // Ng∆∞·ªùi d√πng g·ª≠i 0.005 TON
    const RETURN_JETTON = toNano("1000"); // G·ª≠i l·∫°i 1000 Jetton VIEC

    // ƒê·ªãa ch·ªâ v√≠ TON c·ªßa b·∫°n (nh·∫≠n TON & ch·ª©a Jetton Wallet)
    const ownerTonWallet = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD";

    // ƒê·ªãa ch·ªâ v√≠ Jetton Wallet c·ªßa b·∫°n (ƒë√£ n·∫°p s·∫µn Jetton VIEC)
    const jettonWalletAddress = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD";

    // Kh·ªüi t·∫°o TonConnect UI
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: "https://ton.org/tonconnect-manifest.json",
      buttonRootId: "ton-connect"
    });

    let userWalletAddress = null;

    tonConnectUI.onStatusChange(async (walletInfo) => {
      if (walletInfo && walletInfo.account?.address) {
        userWalletAddress = walletInfo.account.address;
        document.getElementById("swap").disabled = false;
      }
    });

    document.getElementById("swap").onclick = async () => {
      if (!userWalletAddress) return alert("Ch∆∞a k·∫øt n·ªëi v√≠!");

      // B1. G·ª≠i 0.005 TON ƒë·∫øn v√≠ c·ªßa b·∫°n
      const sendTonTx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [
          {
            address: ownerTonWallet,
            amount: TON_AMOUNT.toString(),
          }
        ]
      };

      try {
        await tonConnectUI.sendTransaction(sendTonTx);
        alert("‚úÖ ƒê√£ g·ª≠i 0.005 TON!\n‚è≥ ƒêang g·ª≠i l·∫°i 1000 VIEC...");

        // B2. T·ª± ƒë·ªông g·ª≠i l·∫°i 1000 VIEC (Jetton Transfer)
        const jettonTransfer = beginCell()
          .storeUint(0xf8a7ea5, 32)                       // Jetton transfer OP
          .storeUint(0, 64)                               // query_id
          .storeCoins(RETURN_JETTON)                      // S·ªë jetton g·ª≠i
          .storeAddress(Address.parse(userWalletAddress)) // ƒê·ªãa ch·ªâ nh·∫≠n
          .storeAddress(Address.parse(userWalletAddress)) // Response address
          .storeBit(0)                                    // no custom payload
          .storeCoins(toNano("0.01"))                     // TON ƒë√≠nh k√®m
          .storeBit(0)                                    // no forward payload
          .endCell();

        const sendJettonTx = {
          validUntil: Math.floor(Date.now() / 1000) + 600,
          messages: [
            {
              address: jettonWalletAddress,
              amount: toNano("0.05").toString(), // Ph√≠ cho jetton transfer
              payload: jettonTransfer.toBoc().toString("base64")
            }
          ]
        };

        await tonConnectUI.sendTransaction(sendJettonTx);
        alert("üéâ ƒê√£ g·ª≠i 1000 VIEC th√†nh c√¥ng!");
      } catch (err) {
        console.error(err);
        alert("‚ùå C√≥ l·ªói x·∫£y ra: " + err.message);
      }
    };
  </script>
</body>
</html>
