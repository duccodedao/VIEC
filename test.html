<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>TON Wallet Web</title>
  <script src="https://unpkg.com/@tonconnect/sdk@latest"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    button { padding: 10px 20px; margin: 10px 0; }
    #txs li { margin-bottom: 6px; }
  </style>
</head>
<body>

  <h1>Kết nối ví TON</h1>
  <button id="connect-btn">Kết nối ví</button>
  <div id="wallet-info"></div>

  <h2>Số dư ví</h2>
  <div id="balance">0 TON</div>

  <h2>Lịch sử giao dịch</h2>
  <ul id="txs"></ul>

  <h2>Gửi TON</h2>
  <input type="text" id="to" placeholder="Địa chỉ nhận" style="width:100%">
  <input type="number" id="amount" placeholder="Số TON" style="width:100%">
  <button id="send-btn">Gửi</button>

  <script>
    const connector = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://ton.org/tonconnect-manifest.json',
      buttonRootId: 'connect-btn',
    });

    let userAddress = '';
    const apiKey = ''; // TonAPI client-side key nếu bạn có (nếu không có thì bỏ qua)
    const tonApiUrl = 'https://tonapi.io/v2/accounts';

    connector.onStatusChange(async walletInfo => {
      if (walletInfo) {
        userAddress = walletInfo.account.address;
        document.getElementById('wallet-info').innerText = 'Địa chỉ ví: ' + userAddress;
        getBalance();
        getTxHistory();
      }
    });

    async function getBalance() {
      const res = await fetch(`${tonApiUrl}/${userAddress}`, {
        headers: apiKey ? { 'Authorization': 'Bearer ' + apiKey } : {}
      });
      const data = await res.json();
      const ton = Number(data.balance) / 1e9;
      document.getElementById('balance').innerText = ton.toFixed(3) + ' TON';
    }

    async function getTxHistory() {
      const res = await fetch(`${tonApiUrl}/${userAddress}/transactions?limit=5`, {
        headers: apiKey ? { 'Authorization': 'Bearer ' + apiKey } : {}
      });
      const data = await res.json();
      const txList = data.transactions.map(tx => {
        const amount = tx.in_msg?.value ? (Number(tx.in_msg.value) / 1e9).toFixed(3) : '0';
        const addr = tx.in_msg?.source?.address || 'unknown';
        return `<li>+${amount} TON từ ${addr}</li>`;
      });
      document.getElementById('txs').innerHTML = txList.join('');
    }

    document.getElementById('send-btn').onclick = async () => {
      const to = document.getElementById('to').value;
      const amountTON = parseFloat(document.getElementById('amount').value);
      if (!to || !amountTON) return alert('Điền đầy đủ');

      const amountNano = (amountTON * 1e9).toString();

      await connector.sendTransaction({
        validUntil: Math.floor(Date.now() / 1000) + 360,
        messages: [{
          address: to,
          amount: amountNano,
        }]
      });

      alert('Gửi thành công!');
      getBalance();
      getTxHistory();
    };
  </script>
</body>
</html>
