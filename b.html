<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEURALIS - The VIEC Experience</title>

    <!-- Meta SEO -->
    <meta name="description" content="NEURALIS: Trải nghiệm Web3 đỉnh cao. Giao diện tương lai kết hợp với sức mạnh của tonapi.io để quản lý tài sản TON của bạn một cách trực quan và đẹp mắt.">
    <link rel="icon" href="https://duccodedao.github.io/VIEC/img/logo.png" type="image/png">

    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050816;
            --card-color: rgba(23, 27, 48, 0.5);
            --border-color: rgba(145, 94, 255, 0.2);
            --accent-primary: #915EFF;
            --accent-secondary: #2BCBC4;
            --text-primary: #f1f2f6;
            --text-secondary: #aaa6c3;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            background: linear-gradient(-45deg, #050816, #120e2a, #1a163c, #0d0b1f);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .main-container { max-width: 1400px; padding: 2rem; margin: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 2rem; }
        .header-logo img { height: 40px; }
        
        .card-glass {
            background: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
            height: 100%;
        }
        .card-glass:hover { transform: translateY(-5px); box-shadow: 0 0 25px rgba(145, 94, 255, 0.3); border-color: var(--accent-primary); }
        .card-title { font-weight: 600; margin-bottom: 1.5rem; }
        
        .hero-section { text-align: center; padding: 4rem 0; }
        .hero-section h1 { font-size: 3.5rem; font-weight: 700; }
        .hero-section .highlight { color: var(--accent-primary); }

        .skeleton-loader {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            border-radius: 8px;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-line { height: 20px; margin-bottom: 10px; }
        .skeleton-line.w-50 { width: 50%; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
    </style>
</head>
<body>

    <div class="main-container">
        <header class="header">
            <a href="#" class="header-logo"><img src="https://duccodedao.github.io/VIEC/img/logo_viewc.png" alt="NEURALIS Logo"></a>
            <div id="ton-connect-button-root"></div>
        </header>

        <main id="dashboard" style="display: none;">
            <div class="row g-4">
                <!-- Left Column -->
                <div class="col-lg-7">
                    <div class="row g-4">
                        <div class="col-md-12">
                            <div class="card-glass">
                                <h5 class="card-title">Core Assets</h5>
                                <div id="main-assets-content"></div>
                            </div>
                        </div>
                        <div class="col-md-12">
                             <div class="card-glass">
                                <h5 class="card-title">Activity Feed</h5>
                                <div id="activity-feed-content" style="max-height: 480px; overflow-y: auto; padding-right: 10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Right Column -->
                <div class="col-lg-5">
                     <div class="row g-4">
                         <div class="col-12">
                             <div class="card-glass">
                                <h5 class="card-title">Token Portfolio</h5>
                                <div id="other-tokens-content" style="max-height: 250px; overflow-y: auto; padding-right: 10px;"></div>
                            </div>
                         </div>
                        <div class="col-12">
                            <div class="card-glass">
                                <h5 class="card-title">NFT Gallery</h5>
                                <div id="nft-gallery-content" style="max-height: 250px; overflow-y: auto;"></div>
                            </div>
                        </div>
                     </div>
                </div>
            </div>
        </main>
        
        <section id="hero-section" class="hero-section">
            <div class="container">
                <h1 class="mb-4">Welcome to the <span class="highlight">Neuralis</span><br>Web3 Experience</h1>
                <p class="lead text-secondary col-md-8 mx-auto mb-4">Connect your wallet to visualize your assets and interact with the VIEC ecosystem in a stunning, next-generation interface.</p>
                <button id="connect-wallet-hero-btn" class="btn px-5 py-3" style="background-color: var(--accent-primary); color: white; font-weight: 600;">Connect Wallet</button>
            </div>
        </section>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const VIEC_JETTON_ROOT = "EQA5JIIDkiPljbagP_S9R7fZQLAhLZjNhIPRVSWkuicj5M_f";
        const TON_API_BASE = 'https://tonapi.io/v2';
        
        // --- UI ELEMENTS ---
        const dashboardEl = document.getElementById('dashboard');
        const heroEl = document.getElementById('hero-section');
        const connectWalletHeroBtn = document.getElementById('connect-wallet-hero-btn');
        const mainAssetsContent = document.getElementById('main-assets-content');
        const activityFeedContent = document.getElementById('activity-feed-content');
        const otherTokensContent = document.getElementById('other-tokens-content');
        const nftGalleryContent = document.getElementById('nft-gallery-content');

        // --- SKELETON LOADER TEMPLATES ---
        const skeletonAsset = `<div class="d-flex align-items-center justify-content-between mb-3"><div class="d-flex align-items-center"><div class="skeleton-loader me-3" style="width: 40px; height: 40px; border-radius: 50%;"></div><div><div class="skeleton-loader skeleton-line w-50"></div><div class="skeleton-loader skeleton-line" style="width: 80px;"></div></div></div><div class="skeleton-loader skeleton-line" style="width: 100px;"></div></div>`;
        const skeletonTx = `<div class="d-flex align-items-center mb-3"><div class="skeleton-loader me-3" style="width: 30px; height: 30px; border-radius: 50%;"></div><div style="flex-grow: 1;"><div class="skeleton-loader skeleton-line"></div><div class="skeleton-loader skeleton-line w-50"></div></div></div>`;

        // --- TONCONNECT ---
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://duccodedao.github.io/VIEC/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button-root'
        });

        connectWalletHeroBtn.addEventListener('click', () => tonConnectUI.openModal());

        // --- HELPERS ---
        const showDashboard = (show) => {
            dashboardEl.style.display = show ? 'block' : 'none';
            heroEl.style.display = show ? 'none' : 'flex';
        };
        const setSkeletonLoaders = () => {
            mainAssetsContent.innerHTML = skeletonAsset + skeletonAsset;
            otherTokensContent.innerHTML = skeletonAsset;
            nftGalleryContent.innerHTML = `<div class="row g-3"><div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 12px;"></div></div><div class="col-3"><div class="skeleton-loader" style="width: 100%; aspect-ratio: 1/1; border-radius: 12px;"></div></div></div>`;
            activityFeedContent.innerHTML = skeletonTx.repeat(5);
        };
        const shortenAddress = (addr) => addr ? `${addr.slice(0, 4)}...${addr.slice(-4)}` : '';

        // --- UI RENDERING FUNCTIONS ---
        // **CHANGED**: This function now renders both TON balance and the Wallet Address.
        const renderMainAssets = (accountInfo) => {
            mainAssetsContent.innerHTML = '';
            
            // TON Balance
            mainAssetsContent.innerHTML += `<div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center"><img src="https://ton.org/download/ton_symbol.png" class="me-3" style="width: 48px;">
                    <div><h5 class="m-0">TON</h5><p class="m-0 text-secondary">The Open Network</p></div></div>
                <h4 class="m-0">${(accountInfo.balance / 1e9).toFixed(4)}</h4></div>`;
            
            // Wallet Address (replaces VIEC)
            const userFriendlyAddress = accountInfo?.address?.bounceable?.address;
            if (userFriendlyAddress) {
                 mainAssetsContent.innerHTML += `<div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-wallet me-3" style="width: 48px; font-size: 24px; text-align: center; color: var(--accent-secondary);"></i>
                        <div><h5 class="m-0">Address</h5><p class="m-0 text-secondary">Your Wallet</p></div>
                    </div>
                    <h6 class="m-0" style="font-family: monospace; cursor: help;" title="${userFriendlyAddress}">${shortenAddress(userFriendlyAddress)}</h6>
                </div>`;
            }
        };
        
        const renderOtherTokens = (jettons) => {
            otherTokensContent.innerHTML = '';
            // VIEC will now appear here along with other tokens
            const otherJettons = jettons; // No longer filtering VIEC out
            if(otherJettons.length > 0) {
                otherJettons.forEach(j => {
                    // Use BigInt for safety with large numbers
                    const balanceBigInt = BigInt(j.balance);
                    const decimals = j.jetton.decimals || 9;
                    const divisor = 10n ** BigInt(decimals);
                    const displayBalance = Number(balanceBigInt) / Number(divisor);
                    const formattedBalance = displayBalance.toLocaleString(undefined, { maximumFractionDigits: 4 });

                    otherTokensContent.innerHTML += `<div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center"><img src="${j.jetton.image}" class="me-3" style="width: 32px; height: 32px; border-radius: 50%;">
                        <div><h6 class="m-0">${j.jetton.symbol}</h6></div></div><h6 class="m-0">${formattedBalance}</h6></div>`;
                });
            } else { otherTokensContent.innerHTML = `<p class="text-secondary">No tokens found.</p>`; }
        };

        const renderNFTs = (nfts) => {
            nftGalleryContent.innerHTML = '';
            if (nfts.nft_items && nfts.nft_items.length > 0) {
                let html = '<div class="row g-3">';
                nfts.nft_items.slice(0, 12).forEach(nft => {
                    const imgUrl = nft.previews?.[nft.previews.length - 1]?.url || nft.metadata?.image || 'https://via.placeholder.com/100';
                    html += `<div class="col-3"><div title="${nft.metadata?.name || 'NFT'}" style="cursor: pointer;">
                               <img src="${imgUrl}" style="width: 100%; border-radius: 12px; aspect-ratio: 1/1; object-fit: cover;" onerror="this.src='https://via.placeholder.com/100'">
                             </div></div>`;
                });
                html += '</div>';
                nftGalleryContent.innerHTML = html;
            } else { nftGalleryContent.innerHTML = `<p class="text-secondary">No NFTs found.</p>`; }
        };

        const renderActivity = (events, userAddress) => {
            activityFeedContent.innerHTML = '';
            if(events.events && events.events.length > 0) {
                events.events.forEach(event => {
                    const log = parseEventToLog(event, userAddress);
                    if (log) {
                         const icon = log.direction === 'in' ? 'fa-arrow-down' : 'fa-arrow-up';
                         const color = log.direction === 'in' ? 'var(--accent-secondary)' : '#ff6b6b';
                         const title = `${log.direction === 'in' ? 'Received' : 'Sent'} ${log.symbol}`;
                         const party = log.direction === 'in' ? `From: ${shortenAddress(log.party)}` : `To: ${shortenAddress(log.party)}`;
                         activityFeedContent.innerHTML += `<div class="d-flex align-items-center py-2 border-bottom border-secondary border-opacity-25">
                            <i class="fas ${icon} me-3 p-2" style="background: ${color}20; color: ${color}; border-radius: 50%;"></i>
                            <div class="flex-grow-1"><p class="m-0 fw-bold">${title}</p><p class="m-0 text-secondary" style="font-size: 0.8rem;">${party}</p></div>
                            <div class="text-end"><p class="m-0 fw-bold">${log.amount} ${log.amount ? log.symbol : ''}</p><p class="m-0 text-secondary" style="font-size: 0.8rem;">${new Date(log.timestamp).toLocaleDateString()}</p></div>
                         </div>`;
                    }
                });
            } else { activityFeedContent.innerHTML = `<p class="text-secondary">No recent activity found.</p>`; }
        };

        // --- MAIN LOGIC ---
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet) {
                showDashboard(true);
                setSkeletonLoaders();
                
                const rawAddress = wallet.account.address;
                const [accountInfo, jettonsInfo, nftsInfo, eventsInfo] = await Promise.all([
                    fetch(`${TON_API_BASE}/accounts/${rawAddress}`).then(res => res.json()),
                    fetch(`${TON_API_BASE}/accounts/${rawAddress}/jettons`).then(res => res.json()),
                    fetch(`${TON_API_BASE}/accounts/${rawAddress}/nfts?limit=100&indirect_ownership=false`).then(res => res.json()),
                    fetch(`${TON_API_BASE}/accounts/${rawAddress}/events?limit=20`).then(res => res.json())
                ]);

                // **CHANGED**: Pass only accountInfo as jettons are no longer needed here.
                renderMainAssets(accountInfo); 
                renderOtherTokens(jettonsInfo.balances);
                renderNFTs(nftsInfo);
                renderActivity(eventsInfo, rawAddress);

            } else {
                showDashboard(false);
            }
        });
        
        const parseEventToLog = (event, userAddress) => {
            if (!event || !Array.isArray(event.actions) || event.actions.length === 0) return null;
            const action = event.actions[0]; if (!action) return null;
            const log = { type: action.type, timestamp: event.timestamp * 1000 };

            if (log.type === 'TonTransfer' && action.TonTransfer) { 
                log.direction = action.TonTransfer.sender.address === userAddress ? 'out' : 'in'; 
                log.amount = (parseInt(action.TonTransfer.amount) / 1e9).toFixed(4); 
                log.symbol = 'TON'; 
                log.party = log.direction === 'out' ? action.TonTransfer.recipient.address.bounceable.address : action.TonTransfer.sender.address.bounceable.address; 
                return log; 
            }
            if (log.type === 'JettonTransfer' && action.JettonTransfer) { 
                log.direction = action.JettonTransfer.sender?.address === userAddress ? 'out' : 'in'; 
                const decimals = action.JettonTransfer.jetton.decimals || 9; 
                log.amount = (Number(BigInt(action.JettonTransfer.amount)) / (10 ** decimals)).toLocaleString();
                log.symbol = action.JettonTransfer.jetton.symbol; 
                log.party = log.direction === 'out' ? action.JettonTransfer.recipient?.address.bounceable.address : action.JettonTransfer.sender?.address.bounceable.address;
                if(log.party) return log;
            }
            if (log.type === 'NftItemTransfer' && action.NftItemTransfer) { 
                log.direction = action.NftItemTransfer.sender?.address === userAddress ? 'out' : 'in'; 
                log.symbol = action.NftItemTransfer.nft_item?.metadata?.name || 'NFT'; 
                log.amount = ''; 
                log.party = log.direction === 'out' ? action.NftItemTransfer.recipient?.address.bounceable.address : action.NftItemTransfer.sender?.address.bounceable.address; 
                if(log.party) return log;
            }
            return null;
        };
    });
    </script>
</body>
</html>
