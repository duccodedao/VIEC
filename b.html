<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NEURALIS - The VIEC Experience</title>

    <!-- Meta SEO -->
    <meta name="description" content="NEURALIS: Trải nghiệm Web3 đỉnh cao. Giao diện tương lai kết hợp với sức mạnh của tonapi.io để quản lý tài sản TON của bạn một cách trực quan và đẹp mắt.">
    <link rel="icon" href="https://duccodedao.github.io/VIEC/img/logo.png" type="image/png">

    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <!-- **NEW**: For creating transaction payloads -->
    <script src="https://unpkg.com/buffer@6.0.3/index.js"></script>
    <script src="https://unpkg.com/tonweb@0.0.66/dist/tonweb.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050816;
            --card-color: rgba(23, 27, 48, 0.5);
            --border-color: rgba(145, 94, 255, 0.2);
            --accent-primary: #915EFF;
            --accent-secondary: #2BCBC4;
            --text-primary: #f1f2f6;
            --text-secondary: #aaa6c3;
            --color-in: #2BCBC4;
            --color-out: #ff6b6b;
            --color-failed: #ffcc00;
            --color-verified: #3498db;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-primary); background: linear-gradient(-45deg, #050816, #120e2a, #1a163c, #0d0b1f); background-size: 400% 400%; animation: gradientBG 15s ease infinite; overflow-x: hidden; font-size: 16px; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .main-container { max-width: 1400px; padding: 2rem 1rem; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 2rem; }
        .header-logo { display: flex; align-items: center; text-decoration: none; color: var(--text-primary); gap: 10px; }
        .header-logo img { height: 40px; width: 40px; object-fit: cover; transition: all 0.3s ease; }
        .header-logo span { font-size: 1.1rem; font-weight: 600; }
        .card-glass { background: var(--card-color); border: 1px solid var(--border-color); border-radius: 20px; padding: 1.5rem; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); transition: all 0.3s ease; height: 100%; }
        .card-glass:hover { transform: translateY(-5px); box-shadow: 0 0 25px rgba(145, 94, 255, 0.3); border-color: var(--accent-primary); }
        .card-title { font-weight: 600; margin-bottom: 1.5rem; font-size: 1.25rem; }
        .hero-section { text-align: center; padding: 4rem 0; }
        .hero-section h1 { font-size: 2.5rem; font-weight: 700; }
        .hero-section .highlight { color: var(--accent-primary); }
        .skeleton-loader { background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size: 200% 100%; border-radius: 8px; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-line { height: 20px; margin-bottom: 10px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }
        .activity-item-icon { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .amount-in { color: var(--color-in); }
        .amount-out { color: var(--color-out); }
        .status-icon, .verified-tick { font-size: 0.9em; margin-left: 5px; }
        .status-ok, .verified-tick { color: var(--color-in); }
        .status-failed { color: var(--color-failed); }
        #custom-wallet-button { background: var(--accent-primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 500; cursor: pointer; }
        #wallet-dropdown { display: none; position: absolute; right: 0; top: calc(100% + 5px); background-color: #171b30; border: 1px solid var(--border-color); border-radius: 8px; z-index: 1000; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        #wallet-dropdown a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; }
        #wallet-dropdown a:hover { background-color: rgba(145, 94, 255, 0.2); }
        #wallet-dropdown a i { margin-right: 10px; width: 15px; text-align: center; }
        @media (min-width: 768px) { .hero-section h1 { font-size: 3.5rem; } .card-glass { padding: 2rem; } }
        /* Send Modal Styles */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 1040; display: none; }
        .modal-content { background: var(--card-color); border: 1px solid var(--border-color); }
        .form-control { background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-primary); }
        .form-control:focus { background-color: rgba(0,0,0,0.3); border-color: var(--accent-primary); box-shadow: 0 0 0 0.25rem rgba(145, 94, 255, 0.25); color: var(--text-primary); }
    </style>
</head>
<body>

    <div class="main-container">
        <header class="header">
            <a href="#" class="header-logo" id="app-logo-container"><img id="app-logo-img" src="https://duccodedao.github.io/VIEC/img/logo_viewc.png" alt="App Logo"><span id="app-logo-text"></span></a>
            <div class="position-relative">
                <div id="ton-connect-button-root"></div>
                <div id="custom-wallet-button-container" style="display: none;"><button id="custom-wallet-button"></button><div id="wallet-dropdown"><a href="#" id="copy-address-btn"><i class="fas fa-copy"></i><span>Copy Address</span></a><a href="#" id="disconnect-btn"><i class="fas fa-sign-out-alt"></i>Disconnect</a></div></div>
            </div>
        </header>
        <main id="dashboard" style="display: none;">
             <div class="row g-4">
                <div class="col-lg-7">
                    <div class="row g-4"><div class="col-md-12"><div class="card-glass"><h5 class="card-title">Core Assets</h5><div id="main-assets-content"></div></div></div><div class="col-md-12"><div class="card-glass"><h5 class="card-title">NFT Gallery</h5><div id="nft-gallery-content" style="max-height: 420px; overflow-y: auto;"></div></div></div></div>
                </div>
                <div class="col-lg-5">
                     <div class="row g-4"><div class="col-12"><div class="card-glass"><h5 class="card-title">Token Portfolio</h5><div id="other-tokens-content" style="max-height: 250px; overflow-y: auto; padding-right: 10px;"></div></div></div><div class="col-12"><div class="card-glass"><h5 class="card-title">Activity Feed</h5><div id="activity-feed-content" style="max-height: 525px; overflow-y: auto; padding-right: 10px;"></div></div></div></div>
                </div>
            </div>
        </main>
        <section id="hero-section" class="hero-section">
            <div class="container"><h1 class="mb-4">Welcome to the <span class="highlight">Neuralis</span><br/>Web3 Experience</h1><p class="lead text-secondary col-md-8 mx-auto mb-4">Connect your wallet to visualize your assets and interact with the VIEC ecosystem in a stunning, next-generation interface.</p><button id="connect-wallet-hero-btn" class="btn px-5 py-3" style="background-color: var(--accent-primary); color: white; font-weight: 600;">Connect Wallet</button></div>
        </section>
    </div>

    <!-- **NEW**: Send Modal -->
    <div class="modal-backdrop" id="send-modal-backdrop">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="send-modal-title">Send Asset</h5>
                    <button type="button" class="btn-close btn-close-white" id="send-modal-close-btn"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label for="recipient-address" class="form-label">Recipient Address</label><input type="text" class="form-control" id="recipient-address" placeholder="UQ... or username.ton"></div>
                    <div class="mb-3"><label for="send-amount" class="form-label">Amount</label><input type="number" class="form-control" id="send-amount" placeholder="0.0"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" id="send-modal-cancel-btn">Cancel</button><button type="button" class="btn" style="background-color: var(--accent-primary); color: white;" id="send-modal-confirm-btn">Send</button></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const TON_API_BASE = 'https://tonapi.io/v2';
        const dashboardEl = document.getElementById('dashboard');
        const heroEl = document.getElementById('hero-section');
        const mainAssetsContent = document.getElementById('main-assets-content');
        const otherTokensContent = document.getElementById('other-tokens-content');
        const nftGalleryContent = document.getElementById('nft-gallery-content');
        const activityFeedContent = document.getElementById('activity-feed-content');
        
        const tonConnectButtonRoot = document.getElementById('ton-connect-button-root');
        const customWalletContainer = document.getElementById('custom-wallet-button-container');
        const customWalletButton = document.getElementById('custom-wallet-button');
        const walletDropdown = document.getElementById('wallet-dropdown');
        const copyAddressBtn = document.getElementById('copy-address-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        
        const appLogoImg = document.getElementById('app-logo-img');
        const appLogoText = document.getElementById('app-logo-text');
        const DEFAULT_LOGO_SRC = 'https://duccodedao.github.io/VIEC/img/logo_viewc.png';
        const BMASS_LOGO_SRC = 'https://duccodedao.github.io/VIEC/img/logo.png';

        // Send Modal Elements
        const sendModalBackdrop = document.getElementById('send-modal-backdrop');
        const sendModalTitle = document.getElementById('send-modal-title');
        const recipientAddressInput = document.getElementById('recipient-address');
        const sendAmountInput = document.getElementById('send-amount');
        const sendModalConfirmBtn = document.getElementById('send-modal-confirm-btn');

        let telegramUserData = null;
        try { if (window.Telegram && window.Telegram.WebApp) { const tg = window.Telegram.WebApp; tg.ready(); if (tg.initDataUnsafe && tg.initDataUnsafe.user) { telegramUserData = tg.initDataUnsafe.user; } } } catch (e) { console.error("Could not initialize Telegram Web App:", e); }

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://duccodedao.github.io/VIEC/tonconnect-manifest.json', buttonRootId: 'ton-connect-button-root' });
        
        const showDashboard = (show) => { dashboardEl.style.display = show ? 'block' : 'none'; heroEl.style.display = show ? 'none' : 'flex'; };
        const shortenAddress = (addr) => addr ? (addr.includes('.') ? addr : `${addr.slice(0, 4)}...${addr.slice(-4)}`) : 'Unknown';
        const getRaw = (addrObj) => addrObj?.raw_form || (typeof addrObj?.address === 'string' ? addrObj.address : null);
        const getFriendly = (addrObj) => addrObj?.bounceable?.address || addrObj?.name || getRaw(addrObj) || 'Unknown Address';

        const renderMainAssets = (accountInfo) => {
            if (!accountInfo) { mainAssetsContent.innerHTML = `<p class="text-danger">Could not load account data.</p>`; return; }
            mainAssetsContent.innerHTML = `<div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center"><img src="https://ton.org/download/ton_symbol.png" class="me-3" style="width: 48px;">
                    <div><h5 class="m-0">TON</h5><p class="m-0 text-secondary">The Open Network</p></div></div>
                <div class="text-end"><h4 class="m-0 mb-1">${Number((accountInfo.balance / 1e9).toPrecision(6))}</h4><button class="btn btn-sm" id="send-ton-btn" style="background-color:var(--accent-primary); color: white;">Send</button></div></div>`;
            const userFriendlyAddress = getFriendly(accountInfo);
            if (userFriendlyAddress) { mainAssetsContent.innerHTML += `<div class="d-flex align-items-center justify-content-between"> <div class="d-flex align-items-center"> <i class="fas fa-wallet me-3" style="width: 48px; font-size: 24px; text-align: center; color: var(--accent-secondary);"></i> <div><h5 class="m-0">Address</h5><p class="m-0 text-secondary">Your Wallet</p></div></div><h6 class="m-0" style="font-family: monospace; cursor: help;" title="${userFriendlyAddress}">${shortenAddress(userFriendlyAddress)}</h6></div>`; }
            document.getElementById('send-ton-btn').addEventListener('click', () => openSendModal({ type: 'ton' }));
        };
        const renderOtherTokens = (jettons) => {
            otherTokensContent.innerHTML = '';
            const jettonsWithBalance = jettons.filter(j => BigInt(j.balance) > 0n);
            if (jettonsWithBalance.length > 0) {
                jettonsWithBalance.forEach(j => {
                    const displayBalance = Number((Number(BigInt(j.balance)) / (10 ** (j.jetton.decimals || 9))).toPrecision(15));
                    const verifiedTick = j.jetton.verification === 'whitelist' ? `<i class="fas fa-check-circle verified-tick" title="Verified"></i>` : '';
                    otherTokensContent.innerHTML += `<div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="d-flex align-items-center"><img src="${j.jetton.image}" class="me-3" style="width: 32px; height: 32px; border-radius: 50%;">
                        <div><h6 class="m-0">${j.jetton.symbol}${verifiedTick}</h6></div></div>
                        <div class="text-end"><h6 class="m-0 mb-1">${displayBalance.toLocaleString('en-US')}</h6><button class="btn btn-sm" data-asset-type="jetton" data-jetton-wallet="${j.wallet_address.address}" data-jetton-master="${j.jetton.address}" data-decimals="${j.jetton.decimals}" data-symbol="${j.jetton.symbol}" style="background-color: var(--accent-secondary); color: white; font-size: 0.75rem; padding: 0.1rem 0.4rem;">Send</button></div></div>`;
                });
            } else { otherTokensContent.innerHTML = `<p class="text-secondary">No other tokens found.</p>`; }
        };
        otherTokensContent.addEventListener('click', (e) => {
            if (e.target.dataset.assetType === 'jetton') openSendModal(e.target.dataset);
        });

        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet) {
                if (telegramUserData) { appLogoImg.src = telegramUserData.photo_url || DEFAULT_LOGO_SRC; appLogoImg.style.borderRadius = '50%'; appLogoText.textContent = `@${telegramUserData.username}` || 'Telegram User'; }
                else { appLogoImg.src = BMASS_LOGO_SRC; appLogoImg.style.borderRadius = '0'; appLogoText.textContent = 'Bmass Wallet'; }
                showDashboard(true);
                // Skeletons etc.
                try {
                    const rawAddress = wallet.account.address;
                    const results = await Promise.allSettled([ fetch(`${TON_API_BASE}/accounts/${rawAddress}`), fetch(`${TON_API_BASE}/accounts/${rawAddress}/jettons`), fetch(`${TON_API_BASE}/accounts/${rawAddress}/nfts?limit=100&indirect_ownership=false`), fetch(`${TON_API_BASE}/accounts/${rawAddress}/events?limit=100`) ]);
                    const [accountRes, jettonsRes, nftsRes, eventsRes] = results;
                    if (accountRes.status !== 'fulfilled' || !accountRes.value.ok) throw new Error('Could not fetch account info.');
                    const accountInfo = await accountRes.value.json();
                    const jettonsInfo = jettonsRes.status === 'fulfilled' && jettonsRes.value.ok ? await jettonsRes.value.json() : { balances: [] };
                    const userFriendlyAddress = getFriendly(accountInfo);
                    renderMainAssets(accountInfo);
                    renderOtherTokens(jettonsInfo.balances ?? []);
                    // ... other render functions ...
                    tonConnectButtonRoot.style.display = 'none'; customWalletContainer.style.display = 'block'; customWalletButton.textContent = shortenAddress(userFriendlyAddress); copyAddressBtn.dataset.address = userFriendlyAddress;
                } catch (error) { console.error("A critical error occurred while fetching data:", error); /* Error handling UI */ }
            } else { showDashboard(false); tonConnectButtonRoot.style.display = 'block'; customWalletContainer.style.display = 'none'; appLogoImg.src = DEFAULT_LOGO_SRC; appLogoImg.style.borderRadius = '0'; appLogoText.textContent = ''; }
        });

        // --- Send Modal Logic ---
        const openSendModal = (asset) => {
            sendModalTitle.textContent = `Send ${asset.symbol || 'TON'}`;
            recipientAddressInput.value = '';
            sendAmountInput.value = '';
            sendModalBackdrop.style.display = 'flex';
            // Store asset data in the confirm button
            Object.keys(asset).forEach(key => { sendModalConfirmBtn.dataset[key] = asset[key]; });
        };
        const closeSendModal = () => { sendModalBackdrop.style.display = 'none'; };

        document.getElementById('send-modal-close-btn').addEventListener('click', closeSendModal);
        document.getElementById('send-modal-cancel-btn').addEventListener('click', closeSendModal);

        sendModalConfirmBtn.addEventListener('click', async () => {
            const recipient = recipientAddressInput.value;
            const amount = sendAmountInput.value;
            const asset = sendModalConfirmBtn.dataset;

            if (!recipient || !amount || parseFloat(amount) <= 0) { alert('Please enter a valid recipient and amount.'); return; }

            let transaction;
            if (asset.type === 'ton') {
                transaction = { validUntil: Math.floor(Date.now() / 1000) + 60, messages: [{ address: recipient, amount: (amount * 1e9).toString() }] };
            } else if (asset.type === 'jetton') {
                const amountInJettonUnits = BigInt(Math.floor(amount * (10 ** parseInt(asset.decimals, 10))));
                const forwardTonAmount = TonWeb.utils.toNano('0.05');

                const body = new TonWeb.boc.Cell();
                body.bits.writeUint(0x0f8a7ea5, 32); // op code for jetton transfer
                body.bits.writeUint(0, 64); // query id
                body.bits.writeCoins(amountInJettonUnits);
                body.bits.writeAddress(new TonWeb.utils.Address(recipient));
                body.bits.writeAddress(new TonWeb.utils.Address(tonConnectUI.account.address)); // response address
                body.bits.writeBit(false); // no custom payload
                body.bits.writeCoins(forwardTonAmount);
                body.bits.writeBit(false); // no forward_payload 

                transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 60,
                    messages: [{
                        address: asset.jettonWallet, // User's jetton wallet address for this token
                        amount: TonWeb.utils.toNano('0.1').toString(), // Gas fee for the transaction
                        payload: body.toBoc().toString('base64')
                    }]
                };
            }

            if (transaction) {
                try {
                    await tonConnectUI.sendTransaction(transaction);
                    alert('Transaction sent for confirmation!');
                    closeSendModal();
                } catch (e) {
                    console.error(e);
                    alert('Transaction was rejected or failed.');
                }
            }
        });

        // Other functions (disconnect, copy, parseEvent etc.) remain the same
        customWalletButton.addEventListener('click', () => { walletDropdown.style.display = walletDropdown.style.display === 'block' ? 'none' : 'block'; });
        disconnectBtn.addEventListener('click', (e) => { e.preventDefault(); tonConnectUI.disconnect(); walletDropdown.style.display = 'none'; });
        copyAddressBtn.addEventListener('click', (e) => { e.preventDefault(); const address = e.currentTarget.dataset.address; const textSpan = e.currentTarget.querySelector('span'); if (address) { navigator.clipboard.writeText(address).then(() => { textSpan.textContent = 'Copied!'; setTimeout(() => { textSpan.textContent = 'Copy Address'; }, 2000); }); } });
        window.addEventListener('click', (e) => { if (!customWalletContainer.contains(e.target)) { walletDropdown.style.display = 'none'; } });

    </script>
</body>
</html>
